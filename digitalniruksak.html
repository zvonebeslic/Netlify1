<!DOCTYPE html>
<html lang="hr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mountain Adventures ‚Äî Digitalni ruksak</title>
  <meta name="description" content="Digitalni ruksak: vodiƒçi, kamera, 3D vodoravna strelica s GPX praƒáenjem (file/URL), backtrack mrvice, offline savjeti, dnevno svjetlo i SOS. Geografski/magnetski sjever + auto deklinacija (offline/ruƒçno)." />
  <link rel="icon" href="images/mountain-adventures.svg" type="image/svg+xml" />
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0e0f10" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="images/mountain-adventures-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#0e0f10; --fg:#e9eef2; --muted:#9aa6b2; --card:#121416; --line:#1f2327;
      --accent:#2aa96b; --accent-2:#3aa0ff; --accent-3:#e44747;
      --ok:#86d486; --warn:#f2c14e; --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--fg);
      font:500 15px/1.5 Montserrat,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;
    }

    .navbar{
      position:sticky;top:0;z-index:1000;
      background:linear-gradient(#14171b,#0e0f10);border-bottom:1px solid var(--line);
      display:flex;align-items:center;gap:12px;justify-content:space-between;
      padding:10px 14px;
    }
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{width:22px;height:22px}
    .brand span{font-weight:700;font-size:15px;letter-spacing:.2px}
    .navgroup{display:flex;align-items:center;gap:10px}
    .navlink{color:var(--muted);text-decoration:none;font-size:14px;padding:6px 8px;border-radius:8px}
    .navlink:hover{background:#1a1d22;color:#fff}
    .flag{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:13px;color:var(--muted)}
    .flag img{width:16px;height:12px;object-fit:cover;border-radius:2px}

    header.page-head{padding:10px 14px;border-bottom:1px solid var(--line)}
    header.page-head h1{margin:0;font-size:18px}
    header.page-head .intro{margin:4px 0 0;color:var(--muted);font-size:13px}

    main{max-width:1100px;margin:0 auto;padding:18px 14px 28px}
    .tools-grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(310px,1fr))}
    .tool-card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
    .eyebrow{font-size:11px;color:var(--muted);letter-spacing:.3px;text-transform:uppercase}
    .tool-card h3{margin:6px 0 6px;font-size:16px}
    .tool-card p,.tool-card ul{color:var(--muted);font-size:13px}
    .tool-card ul{margin:6px 0 8px 18px;padding:0}
    .btn-row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:0;border-radius:10px;padding:.55em .9em;font-weight:700;background:var(--accent);color:#fff;cursor:pointer;text-decoration:none;display:inline-block;font-size:13px}
    .btn.ghost{background:#2b2f36}
    .btn.alt{background:var(--accent-2)}
    .btn.alert{background:var(--accent-3)}
    .hint{color:var(--muted);font-size:12px}
    section.tool-panel{margin-top:16px;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
    section.tool-panel h4{margin:0 0 8px;font-size:16px}
    .divider{height:1px;background:var(--line);margin:10px 0 12px}
    .two-col{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:800px){.two-col{grid-template-columns:.9fr 1.1fr}}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);padding:.3em .6em;border-radius:999px;font-size:12px;color:var(--muted)}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}

    /* Kamera */
    .camera-wrap{display:grid;gap:10px}
    video#camVideo{width:100%;aspect-ratio:9/16;max-height:72vh;background:#000;border-radius:10px}
    canvas#camCanvas{display:none}
    .toolbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .dot{width:10px;height:10px;border-radius:50%;background:#a33;box-shadow:0 0 6px #600}
    .dot.ok{background:#3c3;box-shadow:0 0 8px #2a2}
    #camMsg{min-width:200px;color:var(--muted);font-size:12px}
    #camThumb{max-width:220px;border-radius:8px;border:1px solid var(--line)}

    /* Kompas + 3D strelica + Libela */
    .compass-wrap{display:grid;gap:10px}
    .compass-row{display:flex;gap:14px;align-items:center;flex-wrap:wrap}
    .compass{
      width:150px;height:150px;border-radius:50%;border:1px solid var(--line);
      background:
        radial-gradient(closest-side, rgba(255,255,255,.06), rgba(0,0,0,0) 60%),
        radial-gradient(transparent 58%, #1b1f25 59%);
      display:grid;place-items:center;position:relative;perspective:800px;
    }
    .compass .tick{position:absolute;inset:8px;border-radius:50%;border:1px dashed #2a2f36}
    .compass-ring{
      position:absolute; inset:0; border-radius:50%;
      border:2px solid rgba(255,255,255,.18);
      box-shadow:0 0 24px rgba(0,0,0,.25) inset;
      transform:rotate(0deg);
    }
    .compass-ring .mark{
      position:absolute; font:700 12px/1 Montserrat,system-ui; letter-spacing:.12em;
      color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.6); user-select:none;
    }
    .compass-ring .n{ top:4px; left:50%; transform:translateX(-50%); }
    .compass-ring .s{ bottom:4px; left:50%; transform:translateX(-50%); }
    .compass-ring .e{ right:4px; top:50%; transform:translateY(-50%); }
    .compass-ring .w{ left:4px; top:50%; transform:translateY(-50%); }
    .compass-ring .ticks{
      position:absolute; inset:10px; border-radius:50%;
      -webkit-mask: radial-gradient(transparent 56%, #000 56.3%);
              mask: radial-gradient(transparent 56%, #000 56.3%);
      background: conic-gradient(from 0deg, rgba(255,255,255,.18) 0 1deg, transparent 1deg 9deg);
    }

    .arrow3d{
      width:68px;height:12px;position:relative;transform-style:preserve-3d;
      transition:transform .14s ease-out, opacity .14s ease-out, filter .2s ease-out;
      filter: drop-shadow(0 10px 14px rgba(0,0,0,.35));
    }
    .arrow3d::after{
      content:"";position:absolute;left:0;top:2px;bottom:2px;width:58px;border-radius:6px;
      background:linear-gradient(180deg,#36c286,#1e915f);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.2), inset 0 -1px 0 rgba(0,0,0,.2);
      transform:translateZ(0.6px);
    }
    .arrow3d::before{
      content:"";position:absolute;right:-14px;top:-6px;border-left:14px solid #36c286;
      border-top:12px solid transparent;border-bottom:12px solid transparent;transform:translateZ(0.8px);
      filter:drop-shadow(0 2px 2px rgba(0,0,0,.4));
    }
    .arrow3d.warn::after{background:linear-gradient(180deg,#f4c35f,#c78f2a)}
    .arrow3d.warn::before{border-left-color:#f4c35f}
    .arrow3d.bad::after{background:linear-gradient(180deg,#ff7a7a,#d84e4e)}
    .arrow3d.bad::before{border-left-color:#ff7a7a}

    .level-wrap{ width:140px; display:flex; flex-direction:column; align-items:center; gap:8px; }
    .level-ring{
      position:relative; width:140px; height:140px; border-radius:50%;
      border:2px solid rgba(255,255,255,.18);
      box-shadow: inset 0 0 18px rgba(0,0,0,.25);
      background: radial-gradient(circle at 50% 50%, rgba(255,255,255,.06) 0 55%, transparent 56% 100%);
      overflow:hidden;
    }
    .lvl-cross{ position:absolute; background:rgba(255,255,255,.18); pointer-events:none; }
    .lvl-h{ left:8%; right:8%; top:50%; height:1px; transform:translateY(-0.5px); }
    .lvl-v{ top:8%; bottom:8%; left:50%; width:1px; transform:translateX(-0.5px); }
    .level-bubble{
      position:absolute; width:26px; height:26px; border-radius:50%;
      background: radial-gradient(circle at 35% 35%, rgba(255,255,255,.85) 0 35%, rgba(255,255,255,.35) 36% 60%, rgba(0,0,0,.15) 61% 100%);
      box-shadow: 0 2px 6px rgba(0,0,0,.45);
      left:50%; top:50%; transform:translate(-50%,-50%);
    }
    .level-readout{ display:flex; gap:8px; font:600 11px/1.2 Montserrat,system-ui; color:#fff; opacity:.8 }

    input[type="number"],input[type="time"],input[type="file"],input[type="url"],input[type="text"]{
      background:#0f1114;border:1px solid var(--line);border-radius:8px;color:#fff;padding:.5em .6em;outline:none;font-size:13px
    }
    input[type="number"]{width:110px}

    #miniCompass{position:fixed;left:10px;bottom:10px;z-index:9999;width:78px;height:78px;border-radius:14px;padding:8px;background:rgba(18,20,22,.9);border:1px solid var(--line);backdrop-filter:blur(6px);box-shadow:0 8px 24px rgba(0,0,0,.35);touch-action:none;user-select:none}
    #miniCompass .mini-ring{width:100%;height:52px;border-radius:999px;border:1px dashed #2a2f36;display:grid;place-items:center;position:relative;overflow:hidden}
    #miniCompass .mini-needle{width:40px;height:6px;background:#2aa96b;border-radius:4px;transform-origin:0% 50%;transition:transform .14s ease-out, background .2s ease-out}
    #miniCompass .mini-needle.warn{background:#e09f3e}
    #miniCompass .mini-needle.bad{background:#e44747}
    #miniCompass .mini-info{text-align:center;font-size:11px;color:var(--muted);margin-top:4px}
    #miniCompass[hidden]{display:none}

    .banner{position:fixed;left:0;right:0;bottom:0;background:#2b2f36;border-top:1px solid var(--line);padding:8px 12px;display:flex;align-items:center;gap:8px;z-index:10000}
    .banner .msg{color:#ddd;font-size:13px}
    .banner .actions{margin-left:auto;display:flex;gap:8px}
    .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;place-items:center;z-index:10001}
    .modal{background:#161a1e;border:1px solid var(--line);border-radius:12px;padding:14px;max-width:520px;width:92%}
    .modal h5{margin:0 0 6px;font-size:16px}
    .modal p{margin:0 0 10px;color:var(--muted);font-size:13px}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end}

    footer{margin-top:26px;border-top:1px solid var(--line);padding:14px;color:var(--muted);font-size:12px;text-align:center}
  </style>
</head>
<body>
  <nav class="navbar" aria-label="Glavna navigacija">
    <div class="brand">
      <img src="images/mountain-adventures.svg" alt="Logo">
      <span>Digitalni ruksak</span>
    </div>
    <div class="navgroup">
      <a class="navlink" href="#tool-aid">Vodiƒçi</a>
      <a class="navlink" href="#tool-camera">Kamera</a>
      <a class="navlink" href="#tool-arrow">Strelica</a>
      <a class="navlink" href="#tool-offline">Offline</a>
      <a class="navlink" href="#tool-sos">SOS</a>
      <span class="flag" title="Jezik: Bosanski/Hrvatski/Srpski">
        <img src="https://flagcdn.com/w20/ba.png" alt="BA"> BA/HR/SR
      </span>
    </div>
  </nav>

  <header class="page-head">
    <h1>Digitalni ruksak</h1>
    <p class="intro">Vodiƒçi, kamera, 3D vodoravna strelica za GPX, backtrack, offline savjeti i SOS. Geografski/magnetski sjever + auto deklinacija.</p>
  </header>

  <main>
    <section class="tools-grid" aria-label="Alati">
      <article class="tool-card" id="tool-aid">
        <div class="eyebrow">Prioritet</div>
        <h3>Digitalna pomoƒá (jasni, laiƒçki vodiƒçi)</h3>
        <p>Brzi postupci koje svatko mo≈æe slijediti. Prvo sigurnost mjesta, zatim 112.</p>
        <div class="btn-row">
          <button class="btn alt" id="openAidPanel">Otvori vodiƒçe</button>
          <span class="chip">‚õ∞Ô∏è Podsjetnici pri ruci</span>
        </div>
      </article>

      <article class="tool-card" id="tool-camera">
        <div class="eyebrow">Foto</div>
        <h3>Pejza≈æno snimanje u≈æivo</h3>
        <p>Stabilan kadar ‚Üí blago pojaƒçanje kontrasta/boje/o≈°trine ‚Üí snimka (offline).</p>
        <ul>
          <li>Auto-stabilnost (snima kad se umiri)</li>
          <li>Radi na HTTPS/localhost</li>
          <li>Bez slanja na server</li>
        </ul>
        <div class="btn-row">
          <button class="btn" id="openCamPanel">Otvori alat</button>
          <a class="btn ghost" href="tools/camera-auto-enhance.html">U novoj kartici</a>
        </div>
        <p class="hint">Privatnost: slika ostaje u tvom pregledniku.</p>
      </article>

      <article class="tool-card" id="tool-arrow">
        <div class="eyebrow">Orijentacija</div>
        <h3>Pametna strelica (3D, uvijek vodoravna) ‚Äî GPX</h3>
        <p>Uƒçitaj GPX (file ili URL). Strelica cilja <b>toƒçno najbli≈æu toƒçku staze</b>. ≈Ωuta/crvena upozorenja + 3x beep.</p>
        <div class="btn-row">
          <button class="btn" id="openArrowPanel">Otvori alat</button>
          <button class="btn ghost" id="openPopupBtn" title="Mali odvojeni prozor s mini strelicom">Pop-up strelica</button>
          <button class="btn ghost" id="closePopupBtn" title="Zatvori pop-up" style="display:none">Zatvori pop-up</button>
        </div>
        <p class="hint">iOS tra≈æi ‚ÄúMotion & Orientation‚Äù dopu≈°tenje; radi na HTTPS-u.</p>
      </article>

      <article class="tool-card" id="tool-offline">
        <div class="eyebrow">Navigacija</div>
        <h3>Offline karte & GPX</h3>
        <p>Preuzmi regiju u OSMand/Organic Maps; GPX spremi lokalno.</p>
        <div class="btn-row">
          <button class="btn ghost" id="openOfflinePanel">Brzi savjeti</button>
        </div>
      </article>

      <article class="tool-card" id="tool-sos">
        <div class="eyebrow">SOS</div>
        <h3>SOS zvi≈ædaljka</h3>
        <p>Glasan ton (‚Ä¢‚Ä¢‚Ä¢ ‚Äî ‚Äî ‚Äî ‚Ä¢‚Ä¢‚Ä¢). 112 je prioritet.</p>
        <div class="btn-row">
          <button class="btn alert" id="playSOS">Pokreni SOS</button>
          <button class="btn ghost" id="stopSOS">Zaustavi</button>
        </div>
      </article>
    </section>

    <!-- PANELI -->
    <section id="panelAid" class="tool-panel" hidden>
      <h4>Digitalna pomoƒá ‚Äî laiƒçki vodiƒçi</h4>
      <div class="two-col">
        <div>
          <div class="chip">‚ÑπÔ∏è Podsjetnik ‚Äî ne zamjenjuje teƒçaj prve pomoƒái</div>
          <div class="divider"></div>
          <div class="aid-accordion" id="aidAcc">
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">üöë KPR (odrasli)</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li><b>Najprije:</b> sigurno mjesto, pozovi <b>112</b>.</li>
                  <li><b>Ne di≈°e normalno?</b> Kreni s KPR: dlan na sredinu prsnog ko≈°a, drugi dlan preko, laktovi ravno.</li>
                  <li><b>Ritam:</b> 100‚Äì120/min; <b>dubina 5‚Äì6 cm</b>. Pusti da se prsa vrate gore.</li>
                  <li>Omjer <b>30:2</b> samo ako zna≈° i ima≈° masku ‚Äî inaƒçe samo pritisci.</li>
                </ul>
              </div>
            </div>
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">ü©∏ Jako krvarenje</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li><b>Stisni</b> direktno 10 minuta bez provjeravanja.</li>
                  <li>Ako promoƒçi, <b>dodaj</b> preko (ne skidaj prvu gazu).</li>
                  <li>Za udove: kompresivni zavoj/turniket (zabilje≈æi vrijeme).</li>
                </ul>
              </div>
            </div>
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">üßä Hladnoƒáa (hipotermija)</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li>Suho i toplo slojevito; vjetar/vlaga out.</li>
                  <li>Astrofolija: srebrna <b>prema tijelu</b> grije (zlatna vani).</li>
                </ul>
              </div>
            </div>
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">üì¢ 112 ‚Äî ≈°to reƒái</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li>Lokacija (koordinate/oznaka staze), ≈°to se dogodilo, broj osoba, pristup.</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="divider"></div>
          <div class="hint">Ovo su sa≈æeti podsjetnici. Teƒçaj prve pomoƒái je preporuƒçljiv.</div>
        </div>
        <div>
          <h4 style="margin-top:0">Brzi podsjetnici</h4>
          <ul>
            <li>Astrofolija: <b>srebrna prema tijelu</b>.</li>
            <li>KPR: <b>30:2</b> (ako zna≈°), 100‚Äì120/min.</li>
            <li>Krvarenje: <b>stisni 10 min</b>; dodaj preko.</li>
          </ul>
          <div class="chip" style="margin-top:8px">üìû 112 ‚Äî hitna pomoƒá i spa≈°avanje</div>
        </div>
      </div>
    </section>

    <section id="panelCamera" class="tool-panel" hidden>
      <h4>Pejza≈æno snimanje (ugraƒëeno)</h4>
      <div class="camera-wrap">
        <video id="camVideo" autoplay playsinline></video>
        <canvas id="camCanvas"></canvas>
        <div class="toolbar">
          <div id="camDot" class="dot" title="Pokazatelj mirnoƒáe"></div>
          <div id="camMsg">Tra≈æim stabilnost‚Ä¶</div>
          <button id="camManual" class="btn ghost">Snimi sada</button>
          <button id="camAuto" class="btn">Auto snimanje: ON</button>
          <button id="camClose" class="btn ghost">Zatvori</button>
        </div>
        <div class="result">
          <img id="camThumb" alt="Pregled snimljene fotografije" />
          <div class="hint">Radi samo na HTTPS/localhost. Slika ostaje lokalno.</div>
        </div>
      </div>
    </section>

    <!-- PANEL: Strelica + GPX + deklinacija -->
    <section id="panelArrow" class="tool-panel" hidden>
      <h4>Pametna strelica ‚Äî GPX (file/URL) + Backtrack</h4>
      <div class="compass-wrap">
        <div class="compass-row">
          <div class="compass" aria-label="Kompas">
            <div class="compass-ring" id="compassRing">
              <span class="mark n">N</span>
              <span class="mark e">E</span>
              <span class="mark s">S</span>
              <span class="mark w">W</span>
              <div class="ticks"></div>
            </div>
            <div class="tick"></div>
            <div id="arrow3d" class="arrow3d" style="opacity:0"></div>
          </div>

          <div class="level-wrap" aria-label="Libela">
            <div class="level-ring" id="levelRing">
              <div class="lvl-cross lvl-h"></div>
              <div class="lvl-cross lvl-v"></div>
              <div class="level-bubble" id="levelBubble"></div>
            </div>
            <div class="level-readout">
              <span>Pitch: <b id="pitchDeg">0.0¬∞</b></span>
              <span>Roll: <b id="rollDeg">0.0¬∞</b></span>
            </div>
          </div>

          <div class="hint">Kompas dr≈æi Sjever gore; libela pokazuje vodoravnost. Strelica cilja najbli≈æu toƒçku staze.</div>
        </div>

        <div class="divider"></div>

        <div class="compass-row">
          <div class="field">
            <label for="gpxInput">GPX file:</label>
            <input id="gpxInput" type="file" accept=".gpx,application/gpx+xml" />
            <button class="btn ghost" id="loadGpxBtn">Uƒçitaj</button>
          </div>
          <div class="field">
            <label for="gpxUrl">GPX URL:</label>
            <input id="gpxUrl" type="url" placeholder="https://‚Ä¶/ruta.gpx" style="width:260px" />
            <button class="btn ghost" id="loadUrlBtn">Uƒçitaj URL</button>
          </div>
          <div class="field">
            <label for="alertMeters">Prag (m) zvuka:</label>
            <input id="alertMeters" type="number" min="5" step="5" value="30" />
            <button class="btn" id="toggleTrackBtn">Pokreni praƒáenje</button>
          </div>
        </div>

        <div class="status-line" style="margin-top:6px">
          <span class="chip" id="trackStatusPill">GPX: ‚Äî</span>
          <span class="chip" id="onTrackChip">üß≠ status: ‚Äî</span>
          <span class="chip" id="offDistChip">‚ÜîÔ∏é udaljenost: ‚Äî</span>
        </div>

        <div class="divider"></div>

        <div class="compass-row">
          <div class="btn-row">
            <button class="btn ghost" id="btStart">Zapoƒçni povratak</button>
            <button class="btn ghost" id="btStop">Zaustavi povratak</button>
          </div>
          <span class="chip" id="btStatus">‚Ü©Ô∏é Povratak: iskljuƒçen</span>
        </div>

        <div class="divider"></div>

        <!-- Deklinacija / sjever -->
        <div class="compass-row">
          <div class="chip">
            <label><input type="checkbox" id="useTrueNorth" checked> Geografski sjever</label>
          </div>
          <div class="chip">
            <label><input type="checkbox" id="autoDecl" checked> Auto deklinacija (GPS/offline)</label>
          </div>
          <div class="chip">
            Deklinacija: <input id="declInput" type="number" step="0.1" style="width:80px" />¬∞
          </div>
          <button class="btn ghost" id="declHelp">Upute</button>
        </div>

        <p class="hint" style="margin-top:6px">URL mo≈æe imati parametar: <code>?gpx=https://‚Ä¶/ruta.gpx</code></p>
        <div><button class="btn" id="arrowClose">Zatvori</button></div>
      </div>
    </section>

    <section id="panelOffline" class="tool-panel" hidden>
      <h4>Offline savjeti</h4>
      <ul>
        <li><b>Organic Maps</b> ili <b>OSMand</b> ‚Äî preuzmi regiju za offline.</li>
        <li>GPX spremi lokalno i otvori iz aplikacije (bez interneta).</li>
        <li>Ukljuƒçi ‚ÄúAirplane mode‚Äù + GPS radi ≈°tednje baterije.</li>
      </ul>
      <button class="btn ghost" onclick="this.closest('section').hidden=true">Zatvori</button>
    </section>
  </main>

  <!-- MINI STRELICA (HUD) -->
  <div id="miniCompass" aria-label="Mini strelica" hidden>
    <div class="mini-ring"><div id="miniNeedle" class="mini-needle"></div></div>
    <div class="mini-info"><span id="miniMeters">‚Äî m</span></div>
  </div>

  <!-- BANNER: GPS lost -->
  <div id="gpsBanner" class="banner" style="display:none">
    <div class="msg">üì° Nema GPS signala ‚Äî ƒçekam fix. Navigacija ograniƒçena.</div>
    <div class="actions"><button class="btn ghost" id="bannerHide">Sakrij</button></div>
  </div>

  <!-- MODAL: Upute deklinacija -->
  <div id="declModalBack" class="modal-back">
    <div class="modal">
      <h5>Deklinacija ‚Äî kratke upute</h5>
      <p><b>Geografski sjever</b> je prema zemljinoj osi. <b>Magnetski sjever</b> je gdje pokazuje magnetometar. Razlika je <b>deklinacija</b> (E = dodaj +¬∞, W = oduzmi ¬∞).</p>
      <p>Ukljuƒçena je <b>Auto deklinacija</b> (offline procjena za Balkan + GPS korekcija). Po ≈æelji ruƒçno promijeni brojku.</p>
      <div class="actions">
        <button class="btn ghost" id="declClose">Zatvori</button>
      </div>
    </div>
  </div>

  <footer>¬© Mountain Adventures ¬∑ Offline spremno (PWA) ¬∑ Ako je opasno: zaustavi se i zovi 112.</footer>

  <script>
    /* PWA SW */
    if ('serviceWorker' in navigator){ navigator.serviceWorker.register('/sw.js').catch(()=>{}); }

    /* Helpers / paneli */
    const qs = s => document.querySelector(s);
    const show = el => { if(!el) return; el.hidden=false; el.scrollIntoView({ behavior:'smooth', block:'start' }); };
    const hide = el => { if(!el) return; el.hidden=true; };

    const panelAid=qs('#panelAid'), panelCamera=qs('#panelCamera'), panelArrow=qs('#panelArrow'),
          panelOffline=qs('#panelOffline');

    qs('#openAidPanel')?.addEventListener('click', () => show(panelAid));
    qs('#openCamPanel')?.addEventListener('click', async () => { show(panelCamera); await startCam(); });
    qs('#openArrowPanel')?.addEventListener('click', () => { show(panelArrow); openArrow(); });
    qs('#openOfflinePanel')?.addEventListener('click', () => show(panelOffline));

    /* Akordeon */
    (function(){ const acc=qs('#aidAcc'); if(!acc) return;
      acc.querySelectorAll('.aid-head').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const body=btn.parentElement.querySelector('.aid-body');
          const open=btn.classList.toggle('open'); body.style.display=open?'block':'none';
        });
      });
    })();

    /* Kamera (kratko, isto kao prije) */
    const camClose=qs('#camClose'), camVideo=qs('#camVideo'),
          camCanvas=qs('#camCanvas'), camCtx=camCanvas?.getContext?.('2d',{willReadFrequently:true}),
          camDot=qs('#camDot'), camMsg=qs('#camMsg'), camThumb=qs('#camThumb'),
          camManual=qs('#camManual'), camAutoBtn=qs('#camAuto');
    const STABILITY_FRAMES=8, DIFF_THRESHOLD=6, CAPTURE_WIDTH=1600;
    let camAutoMode=true, camPrev=null, camSteady=0, camLastAuto=0, camLoopOn=false;
    camClose?.addEventListener('click', stopCam);
    camAutoBtn?.addEventListener('click', ()=>{ camAutoMode=!camAutoMode; camAutoBtn.textContent=camAutoMode?'Auto snimanje: ON':'Auto snimanje: OFF'; });
    camManual?.addEventListener('click', captureCam);
    async function startCam(){
      if(camLoopOn) return;
      try{
        const stream=await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
        camVideo.srcObject=stream; await camVideo.play();
        camCanvas.width=Math.min(1280,camVideo.videoWidth||1280);
        camCanvas.height=Math.min(720,camVideo.videoHeight||720);
        camLoopOn=true; requestAnimationFrame(camLoop);
      }catch(e){ camMsg.textContent='Gre≈°ka s kamerom: '+e.message; }
    }
    function stopCam(){ hide(panelCamera); camLoopOn=false; try{ camVideo.pause(); camVideo.srcObject?.getTracks?.().forEach(t=>t.stop()); camVideo.srcObject=null; }catch(e){} }
    function lumaAt(d,i){ return 0.2126*d[i]+0.7152*d[i+1]+0.0722*d[i+2]; }
    function frameDiff(a,b){ const da=a.data, db=b.data; let s=0,n=da.length/4; for(let p=0,i=0;p<n;p++,i+=4){ s+=Math.abs(lumaAt(da,i)-lumaAt(db,i)); } return s/n; }
    function autoContrast(img){ const d=img.data,n=d.length/4; let lo=255,hi=0; for(let i=0;i<n;i++){const idx=i*4,L=lumaAt(d,idx); if(L<lo)lo=L; if(L>hi)hi=L;} const range=Math.max(1,hi-lo),scale=255/range;
      for(let i=0;i<n;i++){const idx=i*4; d[idx]=Math.min(255,Math.max(0,(d[idx]-lo)*scale)); d[idx+1]=Math.min(255,Math.max(0,(d[idx+1]-lo)*scale)); d[idx+2]=Math.min(255,Math.max(0,(d[idx+2]-lo)*scale)); } return img; }
    function unsharp(img,a=.55,r=1){ const w=img.width,h=img.height,s=img.data,out=new Uint8ClampedArray(s.length);
      for(let y=0;y<h;y++){ for(let x=0;x<w;x++){ let rsum=0,gsum=0,bsum=0,c=0;
        for(let oy=-r;oy<=r;oy++){const yy=Math.min(h-1,Math.max(0,y+oy));
          for(let ox=-r;ox<=r;ox++){const xx=Math.min(w-1,Math.max(0,x+ox)),i=(yy*w+xx)*4; rsum+=s[i]; gsum+=s[i+1]; bsum+=s[i+2]; c++;}}
        const i=(y*w+x)*4, br=rsum/c, bg=gsum/c, bb=bsum/c;
        out[i]=Math.min(255,Math.max(0,s[i]+a*(s[i]-br))); out[i+1]=Math.min(255,Math.max(0,s[i+1]+a*(s[i+1]-bg))); out[i+2]=Math.min(255,Math.max(0,s[i+2]+a*(s[i+2]-bb))); out[i+3]=s[i+3];
      }} img.data.set(out); return img; }
    async function camLoop(){ if(!camLoopOn) return;
      if(camVideo.readyState>=2){ camCtx.drawImage(camVideo,0,0,camCanvas.width,camCanvas.height); const cur=camCtx.getImageData(0,0,camCanvas.width,camCanvas.height);
        if(camPrev){ const diff=frameDiff(cur,camPrev);
          if(diff<DIFF_THRESHOLD){ camSteady++; camDot.classList.add('ok'); camMsg.textContent=`Mirno ‚Äî ${camSteady}/${STABILITY_FRAMES}`; }
          else{ camSteady=0; camDot.classList.remove('ok'); camMsg.textContent=`Nemirno (${Math.round(diff)}), dr≈æi mirnije`; }
          if(camSteady>=STABILITY_FRAMES && camAutoMode){ const now=Date.now(); if(now-camLastAuto>2500){ camLastAuto=now; await captureCam(); } camSteady=0; }
        } camPrev=cur; }
      requestAnimationFrame(camLoop);
    }
    async function captureCam(){
      camMsg.textContent='Snimam i obraƒëujem‚Ä¶';
      try{
        const track=camVideo.srcObject?.getVideoTracks?.[0];
        if(track && window.ImageCapture){
          const ic=new ImageCapture(track);
          if(ic.takePhoto){
            const blob=await ic.takePhoto(); const bmp=await createImageBitmap(blob); const r=bmp.width/bmp.height;
            const W=Math.min(CAPTURE_WIDTH,bmp.width), H=Math.round(W/r); camCanvas.width=W; camCanvas.height=H;
            camCtx.drawImage(bmp,0,0,W,H);
            camCtx.filter='contrast(1.06) saturate(1.08)'; camCtx.drawImage(camCanvas,0,0); camCtx.filter='none';
            let id=camCtx.getImageData(0,0,W,H); id=autoContrast(id); id=unsharp(id,.6,1); camCtx.putImageData(id,0,0);
            const url=camCanvas.toDataURL('image/jpeg',0.92); camThumb.src=url; camMsg.innerHTML='Gotovo. <a style="margin-left:8px" download="mountain-photo.jpg" href="'+url+'">Preuzmi</a>'; return;
          }
        }
      }catch(e){}
      const r=(camVideo.videoWidth||1080)/(camVideo.videoHeight||1920);
      const W=Math.min(CAPTURE_WIDTH,camVideo.videoWidth||1280), H=Math.round(W/r);
      camCanvas.width=W; camCanvas.height=H; camCtx.drawImage(camVideo,0,0,W,H);
      camCtx.filter='contrast(1.06) saturate(1.08)'; camCtx.drawImage(camCanvas,0,0); camCtx.filter='none';
      let id=camCtx.getImageData(0,0,W,H); id=autoContrast(id); id=unsharp(id,.6,1); camCtx.putImageData(id,0,0);
      const url=camCanvas.toDataURL('image/jpeg',0.92); camThumb.src=url; camMsg.innerHTML='Gotovo. <a style="margin-left:8px" download="mountain-photo.jpg" href="'+url+'">Preuzmi</a>';
    }

    /* === STRELICA + GPX + BACKTRACK + KOMPAS + LIBELA + DEKLINACIJA === */
    const arrowEl=qs('#arrow3d'),
          gpxInput=qs('#gpxInput'), loadGpxBtn=qs('#loadGpxBtn'),
          gpxUrl=qs('#gpxUrl'), loadUrlBtn=qs('#loadUrlBtn'),
          alertMetersInput=qs('#alertMeters'), toggleTrackBtn=qs('#toggleTrackBtn'),
          trackStatusPill=qs('#trackStatusPill'), onTrackChip=qs('#onTrackChip'), offDistChip=qs('#offDistChip');

    const mini=qs('#miniCompass'), miniNeedle=qs('#miniNeedle'), miniMeters=qs('#miniMeters');
    const compassRing = qs('#compassRing');
    const levelRing   = qs('#levelRing');
    const levelBubble = qs('#levelBubble');
    const pitchLbl    = qs('#pitchDeg');
    const rollLbl     = qs('#rollDeg');

    const useTrueNorthEl = qs('#useTrueNorth');
    const autoDeclEl     = qs('#autoDecl');
    const declInput      = qs('#declInput');
    const declModalBack  = qs('#declModalBack'); 
    const declHelpBtn    = qs('#declHelp');
    const declCloseBtn   = qs('#declClose');

    declHelpBtn?.addEventListener('click', ()=> declModalBack.style.display='grid');
    declCloseBtn?.addEventListener('click', ()=> declModalBack.style.display='none');

    // Stanje
    const R=6371000, RAD=Math.PI/180, DEG=180/Math.PI;
    let useAOS=false, lastMatrix=null;
    let gpxTrack=null, watchId=null, alertMeters=30;
    let audioCtx=null, offBeepArmed=false;
    let lastKnownLat=null, lastKnownLon=null;
    let lastFix=null; // {lat,lon,t}
    const COG_MIN_SPEED=0.5;

    // heading / deklinacija
    let useTrueNorth = JSON.parse(localStorage.getItem('ma_useTrueNorth') || 'true');
    let autoDecl     = JSON.parse(localStorage.getItem('ma_autoDecl') || 'true');
    let declinationDeg = parseFloat(localStorage.getItem('ma_declinationDeg') || '4.3');
    useTrueNorthEl.checked = useTrueNorth;
    autoDeclEl.checked = autoDecl;
    declInput.value = (+declinationDeg).toFixed(1);

    useTrueNorthEl.addEventListener('change', ()=>{ useTrueNorth = useTrueNorthEl.checked; localStorage.setItem('ma_useTrueNorth', JSON.stringify(useTrueNorth)); });
    autoDeclEl.addEventListener('change', ()=>{ autoDecl = autoDeclEl.checked; localStorage.setItem('ma_autoDecl', JSON.stringify(autoDecl)); });
    declInput.addEventListener('change', ()=>{ const v=parseFloat(declInput.value); if(Number.isFinite(v)){ declinationDeg=v; localStorage.setItem('ma_declinationDeg', String(declinationDeg)); } });

    // Gruba offline mre≈æa deklinacije (Balkan ~2025, E pozitivno)
    const DEC_GRID={ lats:[40,42,44,46], lons:[12,16,20,24],
      vals:[
        [2.0,3.0,4.0,4.8],
        [2.6,3.6,4.6,5.4],
        [3.0,4.1,5.1,6.0],
        [3.3,4.4,5.4,6.3]
      ] };
    function bilerp(x,x0,x1,y,y0,y1,q11,q21,q12,q22){
      const tx=(x-x0)/(x1-x0||1), ty=(y-y0)/(y1-y0||1);
      const a=q11*(1-tx)+q21*tx, b=q12*(1-tx)+q22*tx; return a*(1-ty)+b*ty;
    }
    function estimateDeclination(lat,lon){
      const {lats,lons,vals}=DEC_GRID;
      lat=Math.max(lats[0],Math.min(lats.at(-1),lat));
      lon=Math.max(lons[0],Math.min(lons.at(-1),lon));
      let i=lats.findIndex((v,idx)=>lat>=v&&(idx===lats.length-1||lat<lats[idx+1])); if(i<0) i=lats.length-2;
      let j=lons.findIndex((v,idx)=>lon>=v&&(idx===lons.length-1||lon<lons[idx+1])); if(j<0) j=lons.length-2;
      return bilerp(lon,lons[j],lons[j+1],lat,lats[i],lats[i+1], vals[i][j],vals[i][j+1],vals[i+1][j],vals[i+1][j+1]);
    }

    // Level-lock & smoothing
    let lastAngleDeg=0; const SMOOTHING=0.18; const DEAD_BAND_DEG=3; const MAX_ROT_SPEED_DPS=240;
    const OK_THRESHOLD_M=5, YELLOW_MAX_M=10;

    // mrvice / backtrack
    let breadcrumbs=[]; let lastCrumb=null; const CRUMB_MIN_DIST=10, CRUMB_MAX_ACC=35, CRUMB_MIN_INTERVAL_MS=30000, AUTO_ADVANCE_RADIUS=8;
    let backtrackOn=false, backIdx=null;

    // heading kazeta (no-GPS fallback)
    let headingTape=[]; let hbOn=false; let hbIdx=null; const HEADING_SAMPLE_MS=1000;
    let lastHeadingSampleAt=0, gpsLostSince=null, tapeTick=null; const GPS_LOST_MODAL_AFTER_MS=120000;
    const gpsBanner=qs('#gpsBanner'), bannerHide=qs('#bannerHide');
    bannerHide?.addEventListener('click', ()=> gpsBanner.style.display='none');

    // Helpers
    const toRad=x=>x*RAD;
    function quatToMatrix(x,y,z,w){
      const xx=x*x,yy=y*y,zz=z*z; const xy=x*y,xz=x*z,yz=y*z; const wx=w*x,wy=w*y,wz=w*z;
      return [
        [1-2*(yy+zz), 2*(xy-wz),  2*(xz+wy)],
        [2*(xy+wz),   1-2*(xx+zz),2*(yz-wx)],
        [2*(xz-wy),   2*(yz+wx),  1-2*(xx+yy)]
      ];
    }
    function eulerToMatrix(alpha,beta,gamma){
      const z=alpha*RAD,x=beta*RAD,y=gamma*RAD;
      const cZ=Math.cos(z),sZ=Math.sin(z), cX=Math.cos(x),sX=Math.sin(x), cY=Math.cos(y),sY=Math.sin(y);
      return [
        [ cZ*cY - sZ*sX*sY,   -cX*sZ,           cY*sZ*sX + cZ*sY ],
        [ cY*sZ + cZ*sX*sY,    cZ*cX,           sZ*sY - cZ*cY*sX ],
        [ -cX*sY,              sX,              cX*cY            ]
      ];
    }
    function extractYPR(M){
      const r11=M[0][0], r12=M[0][1], r13=M[0][2];
      const r21=M[1][0], r22=M[1][1], r23=M[1][2];
      const r31=M[2][0], r32=M[2][1], r33=M[2][2];
      const pitch = Math.asin(-r31);
      const roll  = Math.atan2(r32, r33);
      const yaw   = Math.atan2(r21, r11);
      return { yaw: yaw*DEG, pitch: pitch*DEG, roll: roll*DEG };
    }
    function enuVector(lat,lon,lat2,lon2){
      const œÜ1=lat*RAD, œÜ2=lat2*RAD, dŒª=(lon2-lon)*RAD;
      return [ R * dŒª * Math.cos((œÜ1+œÜ2)/2), R * (œÜ2-œÜ1), 0 ];
    }
    function bearingBetween(lat1,lon1,lat2,lon2){
      const œÜ1=toRad(lat1), œÜ2=toRad(lat2), ŒîŒª=toRad(lon2-lon1);
      const y=Math.sin(ŒîŒª)*Math.cos(œÜ2), x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);
      return ((Math.atan2(y,x)*DEG)+360)%360;
    }
    function haversine(lat1,lon1,lat2,lon2){
      const dœÜ=toRad(lat2-lat1), dŒª=toRad(lon2-lon1);
      const a=Math.sin(dœÜ/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dŒª/2)**2;
      return 2*R*Math.asin(Math.sqrt(a));
    }
    function toXY(lat,lon,lat0){ const x=(lon*RAD)*Math.cos(lat0*RAD)*R, y=(lat*RAD)*R; return {x,y}; }
    function nearestPointOnTrack(p,track){
      let best={lat:track[0].lat,lon:track[0].lon,distM:Infinity,segIndex:0};
      const lat0=p.lat, P=toXY(p.lat,p.lon,lat0);
      for(let i=0;i<track.length-1;i++){
        const A=toXY(track[i].lat,track[i].lon,lat0), B=toXY(track[i+1].lat,track[i+1].lon,lat0);
        const ABx=B.x-A.x, ABy=B.y-A.y, APx=P.x-A.x, APy=P.y-A.y;
        const ab2=ABx*ABx + ABy*ABy || 1; let t=(APx*ABx + APy*ABy)/ab2; t=Math.max(0,Math.min(1,t));
        const Qx=A.x+t*ABx, Qy=A.y+t*ABy;
        const lon=(Qx/(R*Math.cos(lat0*RAD)))*(180/Math.PI), lat=(Qy/R)*(180/Math.PI);
        const d=haversine(p.lat,p.lon,lat,lon);
        if(d<best.distM) best={lat,lon,distM:d,segIndex:i};
      } return best;
    }
    function clamp(v,min,max){ return Math.min(max,Math.max(min,v)); }

    /* Strelica: boja */
    function setArrowMode(mode){
      arrowEl.classList.remove('warn','bad');
      arrowEl.style.filter = (mode==='bad') ? 'drop-shadow(0 0 10px rgba(228,71,71,.45))' :
                             (mode==='warn')? 'drop-shadow(0 0 10px rgba(242,193,78,.35))' : 'drop-shadow(0 10px 14px rgba(0,0,0,.35))';
      if(mode==='warn'){ arrowEl.classList.add('warn'); }
      else if(mode==='bad'){ arrowEl.classList.add('bad'); }
    }
    function showMini(){ mini.hidden=false; }
    function hideMini(){ mini.hidden=true; }
    function setMiniColor(mode){
      miniNeedle.classList.remove('warn','bad');
      if(mode==='warn') miniNeedle.classList.add('warn');
      else if(mode==='bad') miniNeedle.classList.add('bad');
    }

    /* Mrvice */
    function loadCrumbs(){ try{ breadcrumbs=JSON.parse(localStorage.getItem('ma_crumbs')||'[]')||[]; }catch{ breadcrumbs=[]; } }
    function saveCrumbs(){ try{ localStorage.setItem('ma_crumbs', JSON.stringify(breadcrumbs)); }catch{} }
    function pushCrumb(lat,lon,acc){ const c={lat,lon,t:Date.now(),acc:acc??null}; breadcrumbs.push(c); lastCrumb=c; if(breadcrumbs.length>2000) breadcrumbs.shift(); saveCrumbs(); }
    function maybeAddCrumb(lat,lon,acc){
      if(!Number.isFinite(lat)||!Number.isFinite(lon)) return;
      if(acc!=null && acc>CRUMB_MAX_ACC) return;
      const now=Date.now(); if(!lastCrumb){ pushCrumb(lat,lon,acc); return; }
      const dist=haversine(lastCrumb.lat,lastCrumb.lon,lat,lon); const dt=now-(lastCrumb.t||0);
      if(dist>=CRUMB_MIN_DIST || dt>=CRUMB_MIN_INTERVAL_MS) pushCrumb(lat,lon,acc);
    }
    loadCrumbs(); if(breadcrumbs.length) lastCrumb=breadcrumbs.at(-1);

    /* Yaw/pitch/roll iz matrice */
    function deviceWorldYPR(){ if(!lastMatrix) return {yaw:0,pitch:0,roll:0}; return extractYPR(lastMatrix); }

    /* Kompas prsten + libela */
    function renderCompassAndLevel(headingTrueDeg=null){
      if(!compassRing || !levelRing) return;
      const ypr=deviceWorldYPR();
      const yaw = (headingTrueDeg!=null) ? headingTrueDeg : (ypr.yaw%360+360)%360;
      compassRing.style.transform = `rotate(${-yaw}deg)`;
      const pitch=ypr.pitch, roll=ypr.roll;
      const ringRect = levelRing.getBoundingClientRect();
      const Rb = (ringRect.width/2) - 13;
      const maxTilt = 30;
      let x = (roll / maxTilt) * Rb;
      let y = (pitch / maxTilt) * Rb;
      const dist = Math.hypot(x,y);
      if(dist>Rb){ const k=Rb/dist; x*=k; y*=k; }
      levelBubble.style.left = '50%';
      levelBubble.style.top  = '50%';
      levelBubble.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
      pitchLbl.textContent = `${pitch.toFixed(1)}¬∞`;
      rollLbl.textContent  = `${roll.toFixed(1)}¬∞`;
    }

    /* Senzori */
    function openArrow(){
      // AbsoluteOrientationSensor (ako postoji)
      try{
        if('AbsoluteOrientationSensor' in window){
          const aos=new AbsoluteOrientationSensor({frequency:30, referenceFrame:'device'});
          aos.addEventListener('reading', ()=>{
            const [qx,qy,qz,qw]=aos.quaternion;
            lastMatrix=quatToMatrix(qx,qy,qz,qw);
            // kompas prsten ƒáemo rotirati u onPos / onHeading kad imamo heading
          });
          aos.start(); useAOS=true;
        }
      }catch(e){ useAOS=false; }

      // DeviceOrientation fallback (iOS: webkitCompassHeading = TRUE NORTH)
      const havePermissionAPI = (typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function');
      if(havePermissionAPI){
        const btn=document.createElement('button'); btn.textContent='Omoguƒái kompas (iOS)'; btn.className='btn ghost';
        panelArrow.querySelector('.compass-wrap').appendChild(btn);
        btn.addEventListener('click', async ()=>{
          try{ const state=await DeviceOrientationEvent.requestPermission();
            if(state==='granted'){ window.addEventListener('deviceorientation', onOrient3D, true); btn.remove(); }
          }catch(e){ btn.remove(); }
        }, {once:true});
      } else {
        window.addEventListener('deviceorientation', onOrient3D, true);
      }

      // Parametar gpx
      const urlParam=new URL(location.href).searchParams.get('gpx'); if(urlParam) loadGpxFromUrl(urlParam);
    }

    let lastTrueHeading = null; // 0..360
    function onOrient3D(e){
      // iOS Safari: e.webkitCompassHeading je TRUE NORTH (0=N)
      if(typeof e.webkitCompassHeading === 'number' && Number.isFinite(e.webkitCompassHeading)){
        lastTrueHeading = (e.webkitCompassHeading % 360 + 360) % 360;
        renderCompassAndLevel(lastTrueHeading);
      } else {
        // Ostalo: koristimo alpha (ƒçesto true kad absolute==true, ali varira po ureƒëaju)
        if(e.alpha!=null){
          let h = (e.alpha % 360 + 360) % 360; // heading oko Z
          // Ako koristimo true north, korigiraj deklinacijom ako alpha daje MAG north
          if(useTrueNorth){
            h = (h + declinationDeg + 360) % 360;
          }
          lastTrueHeading = h;
          renderCompassAndLevel(lastTrueHeading);
        }
      }
      // spremi matrix za libelu/3D
      if(e.alpha!=null && e.beta!=null && e.gamma!=null){
        lastMatrix=eulerToMatrix(e.alpha,e.beta,e.gamma);
      }
    }

    /* GPX uƒçitavanje */
    async function loadGpxFromUrl(url){
      try{
        const res=await fetch(url,{mode:'cors'}); if(!res.ok) throw new Error('HTTP '+res.status);
        const txt=await res.text(); gpxTrack=parseGpxToTrack(txt); afterGpxLoaded(`GPX (URL): ${gpxTrack.length} toƒçaka`);
      }catch(e){ trackStatusPill.textContent='GPX URL: ne mogu uƒçitati (CORS?)'; console.error(e); }
    }
    function parseGpxToTrack(xml){
      const dom=new DOMParser().parseFromString(xml,'application/xml');
      let pts=[...dom.querySelectorAll('trkpt')].map(n=>({lat:+n.getAttribute('lat'), lon:+n.getAttribute('lon')}));
      if(!pts.length){ pts=[...dom.querySelectorAll('rtept')].map(n=>({lat:+n.getAttribute('lat'), lon:+n.getAttribute('lon')})); }
      return pts.filter(p=>Number.isFinite(p.lat)&&Number.isFinite(p.lon));
    }
    function afterGpxLoaded(label){
      if(!gpxTrack || gpxTrack.length<2){ trackStatusPill.textContent='GPX: premalo toƒçaka'; return; }
      trackStatusPill.textContent=label;
      onTrackChip.textContent='üß≠ status: GPX spreman ‚Äî klikni ‚ÄúPokreni praƒáenje‚Äù';
      offDistChip.textContent='‚ÜîÔ∏é udaljenost: ‚Äî';
      toggleTrackBtn.classList.add('alt'); setTimeout(()=>toggleTrackBtn.classList.remove('alt'),1400);
    }
    loadGpxBtn?.addEventListener('click', async ()=>{
      const f=gpxInput?.files?.[0]; if(!f){ trackStatusPill.textContent='GPX: nema datoteke'; return; }
      try{ const txt=await f.text(); gpxTrack=parseGpxToTrack(txt); afterGpxLoaded(`GPX (file): ${gpxTrack.length} toƒçaka`); }
      catch(e){ trackStatusPill.textContent='GPX: gre≈°ka pri uƒçitavanju'; console.error(e); }
    });
    loadUrlBtn?.addEventListener('click', async ()=>{
      const url=gpxUrl.value.trim(); if(!url){ trackStatusPill.textContent='GPX URL: prazno'; return; }
      await loadGpxFromUrl(url);
    });

    /* Praƒáenje / GPS */
    let distLP=null; const DIST_ALPHA=0.35;
    toggleTrackBtn?.addEventListener('click', ()=>{
      alertMeters=Math.max(5, Number(alertMetersInput.value)||30);
      if(watchId==null){
        if(!gpxTrack || gpxTrack.length<2){ trackStatusPill.textContent='GPX: uƒçitaj trag prvo'; return; }
        startGeoWatch(); toggleTrackBtn.textContent='Zaustavi praƒáenje';
      } else { stopGeoWatch(); toggleTrackBtn.textContent='Pokreni praƒáenje'; }
    });

    function startGeoWatch(){
      try{
        watchId=navigator.geolocation.watchPosition(onPos,onGeoErr,{enableHighAccuracy:true, maximumAge:1000, timeout:10000});
        trackStatusPill.textContent='GPS: praƒáenje ukljuƒçeno';
        offBeepArmed=true; showMini();
      }catch(e){ trackStatusPill.textContent='GPS: ne mogu pokrenuti'; }
    }
    function stopGeoWatch(){
      if(watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
      trackStatusPill.textContent='GPS: zaustavljeno'; hideMini();
      gpsBanner.style.display='none'; gpsLostSince=null;
      lastFix=null;
    }
    function onGeoErr(err){
      trackStatusPill.textContent='GPS gre≈°ka: '+(err?.message||'');
      if(!gpsLostSince) gpsLostSince=Date.now();
      gpsBanner.style.display='flex';
    }

    function onPos(pos){
      gpsBanner.style.display='none';
      const lat=pos.coords.latitude, lon=pos.coords.longitude, acc=pos.coords.accuracy;
      lastKnownLat=lat; lastKnownLon=lon;

      // Auto deklinacija: procijeni na osnovu pozicije (offline grid)
      if(autoDecl && Number.isFinite(lat) && Number.isFinite(lon)){
        const est=estimateDeclination(lat,lon);
        if(Number.isFinite(est)){ declinationDeg = est; declInput.value = est.toFixed(1); localStorage.setItem('ma_declinationDeg', String(declinationDeg)); }
      }

      // heading kazeta
      const now=Date.now();
      if(now-lastHeadingSampleAt>=HEADING_SAMPLE_MS){
        lastHeadingSampleAt=now;
        const hTrue = getCurrentHeadingTrue();
        headingTape.push({t:now,yawWorldDeg: hTrue!=null ? hTrue : 0, speed: (Number.isFinite(pos.coords.speed)?Math.max(0,pos.coords.speed):null)});
        if(headingTape.length>7200) headingTape.shift();
      }

      // mrvice
      maybeAddCrumb(lat,lon,acc);

      if(!gpxTrack || gpxTrack.length<2){ arrowEl.style.opacity='1'; renderCompassAndLevel(getCurrentHeadingTrue()); return; }

      // najbli≈æa toƒçka staze
      const nearest=nearestPointOnTrack({lat,lon}, gpxTrack);

      if(Number.isFinite(acc) && acc>50){
        onTrackChip.textContent='üß≠ status: GPS netoƒçan (>50 m)';
        renderCompassAndLevel(getCurrentHeadingTrue());
        return;
      }

      // distancija (LPF)
      let dist=nearest.distM;
      distLP = distLP==null ? dist : (DIST_ALPHA*dist + (1-DIST_ALPHA)*distLP);
      updateOffTrackUI(distLP);

      // cilj yaw = prema najbli≈æoj toƒçki staze
      const vWorld=enuVector(lat,lon,nearest.lat,nearest.lon);
      const yawTarget=(Math.atan2(vWorld[0], vWorld[1])*DEG+360)%360;

      // heading ureƒëaja: prioritet TRUE heading (iOS/alpha+decl), fallback GPS COG kad se kreƒáe
      let yawDevice = getCurrentHeadingTrue();
      const canUseCOG = Number.isFinite(pos.coords.speed) && pos.coords.speed>=COG_MIN_SPEED && lastFix;
      if(canUseCOG){
        const cog = bearingBetween(lastFix.lat,lastFix.lon,lat,lon);
        // blend: GPS COG jaƒçe kad se kreƒáe
        yawDevice = (yawDevice!=null) ? (0.6*cog + 0.4*yawDevice + 360)%360 : cog;
      }
      lastFix = {lat,lon,t:now};

      // delta yaw s deadband/cap
      if(yawDevice==null){ yawDevice = deviceWorldYPR().yaw; } // zadnja opcija
      let dYaw = ((yawTarget - yawDevice + 540) % 360) - 180;
      if(Math.abs(dYaw) < DEAD_BAND_DEG) dYaw = 0;
      const maxStep = MAX_ROT_SPEED_DPS / 60;
      dYaw = clamp(dYaw, -maxStep, maxStep);

      let delta = dYaw - lastAngleDeg; if(delta>180) delta-=360; if(delta<-180) delta+=360;
      lastAngleDeg=(lastAngleDeg + SMOOTHING*delta + 360)%360;

      const {pitch, roll}=deviceWorldYPR();
      arrowEl.style.opacity='1';
      arrowEl.style.transform = `rotateX(${-pitch}deg) rotateY(${-roll}deg) rotateZ(${lastAngleDeg}deg)`;

      // mini HUD
      miniMeters.textContent=`${distLP.toFixed(0)} m`;
      const miniRot = Math.round(lastAngleDeg/5)*5;
      miniNeedle.style.transform=`rotate(${miniRot}deg)`;
      const mode = distLP<=OK_THRESHOLD_M ? 'ok' : (distLP<=YELLOW_MAX_M ? 'warn' : 'bad');
      setMiniColor(mode);

      // kompas prsten
      renderCompassAndLevel(getCurrentHeadingTrue());
    }

    function updateOffTrackUI(dist){
      if(dist<=OK_THRESHOLD_M){ setArrowMode('ok'); onTrackChip.textContent='üß≠ status: na tragu ‚úì'; }
      else if(dist<=alertMeters){ setArrowMode('warn'); onTrackChip.textContent='üß≠ status: blizu ruba'; }
      else{ setArrowMode('bad'); onTrackChip.textContent='üß≠ status: izvan traga'; if(offBeepArmed){ offBeepArmed=false; beep3(); setTimeout(()=>offBeepArmed=true,8000); } }
      offDistChip.textContent=`‚ÜîÔ∏é udaljenost: ${dist.toFixed(0)} m`;
    }

    // Izraƒçun trenutnog TRUE headinga:
    function getCurrentHeadingTrue(){
      if(lastTrueHeading!=null) return (lastTrueHeading+360)%360; // veƒá je true (iOS ili alpha+decl)
      // ako nemamo event-based heading, probaj iz matrice (slabije)
      const ypr=deviceWorldYPR();
      let h = (ypr.yaw%360+360)%360;
      if(useTrueNorth){ h = (h + declinationDeg + 360) % 360; }
      return h;
    }

    // Backtrack
    function findNearestCrumbIndex(lat,lon){
      if(!breadcrumbs.length||!Number.isFinite(lat)||!Number.isFinite(lon)) return 0;
      let bestI=0,bestD=Infinity;
      for(let i=0;i<breadcrumbs.length;i++){ const d=haversine(lat,lon,breadcrumbs[i].lat,breadcrumbs[i].lon); if(d<bestD){ bestD=d; bestI=i; } }
      return bestI;
    }
    function doBacktrackStep(lat,lon){
      if(breadcrumbs.length===0){ return; }
      if(backIdx==null){ backIdx=findNearestCrumbIndex(lat,lon); }
      if(backIdx<=0){ onTrackChip.textContent='üß≠ status: stigao na start'; setArrowMode('ok'); offDistChip.textContent='‚ÜîÔ∏é udaljenost: 0 m'; renderCompassAndLevel(getCurrentHeadingTrue()); return; }
      const tgt=breadcrumbs[backIdx]; const distM=haversine(lat,lon,tgt.lat,tgt.lon); updateOffTrackUI(distM);
      const vWorld=enuVector(lat,lon,tgt.lat,tgt.lon);
      const yawTarget=(Math.atan2(vWorld[0], vWorld[1])*DEG+360)%360;

      let yawDevice = getCurrentHeadingTrue();
      if(lastFix){ const cog=bearingBetween(lastFix.lat,lastFix.lon,lat,lon); yawDevice=(yawDevice!=null)?(0.7*cog+0.3*yawDevice+360)%360:cog; }

      let dYaw=((yawTarget - yawDevice + 540) % 360) - 180;
      if(Math.abs(dYaw)<DEAD_BAND_DEG) dYaw=0;
      const maxStep = MAX_ROT_SPEED_DPS/60;
      dYaw=clamp(dYaw,-maxStep,maxStep);

      let delta=dYaw - lastAngleDeg; if(delta>180) delta-=360; if(delta<-180) delta+=360;
      lastAngleDeg=(lastAngleDeg + SMOOTHING*delta + 360)%360;

      const {pitch,roll}=deviceWorldYPR();
      arrowEl.style.transform=`rotateX(${-pitch}deg) rotateY(${-roll}deg) rotateZ(${lastAngleDeg}deg)`;
      const miniRot = Math.round(lastAngleDeg/5)*5;
      miniNeedle.style.transform=`rotate(${miniRot}deg)`;
      miniMeters.textContent=`${Math.round(distM)} m`;

      if(distM<=AUTO_ADVANCE_RADIUS){ backIdx=Math.max(0, backIdx-1); }
      onTrackChip.textContent='üß≠ status: povratak istim putem';
      renderCompassAndLevel(getCurrentHeadingTrue());
    }
    qs('#btStart')?.addEventListener('click', ()=>{
      if(!breadcrumbs.length){ qs('#btStatus').textContent='‚Ü©Ô∏é Povratak: nema mrvica'; return; }
      backtrackOn=true; backIdx=findNearestCrumbIndex(lastKnownLat??breadcrumbs.at(-1)?.lat,lastKnownLon??breadcrumbs.at(-1)?.lon);
      qs('#btStatus').textContent='‚Ü©Ô∏é Povratak: ukljuƒçen';
    });
    qs('#btStop')?.addEventListener('click', ()=>{ backtrackOn=false; backIdx=null; qs('#btStatus').textContent='‚Ü©Ô∏é Povratak: iskljuƒçen'; });

    // UI close
    qs('#arrowClose')?.addEventListener('click', ()=>{ hide(panelArrow); window.removeEventListener('deviceorientation', onOrient3D, true); if(watchId!=null) navigator.geolocation.clearWatch(watchId); });

    // Visibility: ≈°tedi bateriju
    document.addEventListener('visibilitychange', ()=>{
      if(document.visibilityState==='hidden'){
        if(watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
        if(!useAOS){ window.removeEventListener('deviceorientation', onOrient3D, true); }
      } else {
        if(!useAOS){ window.addEventListener('deviceorientation', onOrient3D, true); }
      }
    });

    /* SOS */
    let sosCtx=null, sosPlay=false;
    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
    function sosBeep(freq=900,dur=150){ return new Promise(res=>{ try{
      sosCtx=sosCtx||new (window.AudioContext||window.webkitAudioContext)();
      const t=sosCtx.currentTime; const osc=sosCtx.createOscillator(); const gain=sosCtx.createGain();
      osc.frequency.value=freq; osc.type='sine'; gain.gain.value=0.0001; osc.connect(gain); gain.connect(sosCtx.destination);
      osc.start(); gain.gain.exponentialRampToValueAtTime(0.25, t+0.02);
      gain.gain.setValueAtTime(0.25, t+dur/1000-0.03); gain.gain.exponentialRampToValueAtTime(0.0001, t+dur/1000);
      osc.stop(t+dur/1000+0.02); setTimeout(res, dur);
    }catch(e){ res(); } }); }
    async function playSOS(){
      if(sosPlay) return; sosPlay=true;
      while(sosPlay){
        await sosBeep(900,150); await sleep(120);
        await sosBeep(900,150); await sleep(120);
        await sosBeep(900,150); await sleep(300);
        await sosBeep(900,450); await sleep(150);
        await sosBeep(900,450); await sleep(150);
        await sosBeep(900,450); await sleep(300);
        await sosBeep(900,150); await sleep(120);
        await sosBeep(900,150); await sleep(120);
        await sosBeep(900,150); await sleep(900);
      }
    }
    function stopSOS(){ sosPlay=false; }
    qs('#playSOS')?.addEventListener('click', playSOS);
    qs('#stopSOS')?.addEventListener('click', stopSOS);

    /* Beep pri off-tracku */
    function beep3(){
      try{
        audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
        const seq = [900,900,900]; let t = audioCtx.currentTime;
        seq.forEach((f)=>{
          const osc=audioCtx.createOscillator();
          const gain=audioCtx.createGain();
          osc.type='sine'; osc.frequency.value=f; osc.connect(gain); gain.connect(audioCtx.destination);
          gain.gain.setValueAtTime(0.0001, t);
          gain.gain.exponentialRampToValueAtTime(0.25, t+0.02);
          osc.start(t); osc.stop(t+0.15);
          gain.gain.exponentialRampToValueAtTime(0.0001, t+0.15);
          t += 0.27;
        });
      }catch(e){}
    }
  </script>
</body>
</html>
