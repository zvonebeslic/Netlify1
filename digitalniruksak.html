<!DOCTYPE html>
<html lang="hr">
<head>
  <!-- =========================================================
       META / PWA / OSNOVNO
       ========================================================= -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mountain Adventures — Digitalni ruksak</title>
  <meta name="description" content="Digitalni ruksak: vodiči, kamera, kompas s fiksnim N/E/S/W (igla fiksna, brojčanik se rotira), target strelica prema najbližoj točki GPX staze, backtrack, offline savjeti, SOS, meteoprognoza, noćno nebo i terenski vodič.">
  <link rel="icon" href="images/mountain-adventures.svg" type="image/svg+xml">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0e0f10">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="images/mountain-adventures-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- =========================================================
       STILOVI (format: jedno svojstvo u jednom redu)
       ========================================================= -->
  <style>
    :root {
      --bg: #0e0f10;
      --fg: #e9eef2;
      --muted: #9aa6b2;
      --card: #121416;
      --line: #1f2327;
      --accent: #2aa96b;
      --accent-2: #3aa0ff;
      --accent-3: #e44747;
      --ok: #86d486;
      --warn: #f2c14e;
      --bad: #ff6b6b;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font: 500 15px/1.5 Montserrat, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    .navbar {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: linear-gradient(#14171b, #0e0f10);
      border-bottom: 1px solid var(--line);
      display: flex;
      align-items: center;
      gap: 12px;
      justify-content: space-between;
      padding: 10px 14px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand img {
      width: 22px;
      height: 22px;
    }

    .brand span {
      font-weight: 700;
      font-size: 15px;
      letter-spacing: .2px;
    }

    .navgroup {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .navlink {
      color: var(--muted);
      text-decoration: none;
      font-size: 14px;
      padding: 6px 8px;
      border-radius: 8px;
    }

    .navlink:hover {
      background: #1a1d22;
      color: #fff;
    }

    .flag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 4px 8px;
      font-size: 13px;
      color: var(--muted);
    }

    .flag img {
      width: 16px;
      height: 12px;
      object-fit: cover;
      border-radius: 2px;
    }

    header.page-head {
      padding: 10px 14px;
      border-bottom: 1px solid var(--line);
    }

    header.page-head h1 {
      margin: 0;
      font-size: 18px;
    }

    header.page-head .intro {
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 13px;
    }

    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 14px 28px;
    }

    .tools-grid {
      display: grid;
      gap: 14px;
      grid-template-columns: repeat(auto-fill, minmax(310px, 1fr));
    }

    .tool-card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
    }

    .eyebrow {
      font-size: 11px;
      color: var(--muted);
      letter-spacing: .3px;
      text-transform: uppercase;
    }

    .tool-card h3 {
      margin: 6px 0 6px;
      font-size: 16px;
    }

    .tool-card p,
    .tool-card ul {
      color: var(--muted);
      font-size: 13px;
    }

    .tool-card ul {
      margin: 6px 0 8px 18px;
      padding: 0;
    }

    .btn-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      appearance: none;
      border: 0;
      border-radius: 10px;
      padding: .55em .9em;
      font-weight: 700;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      font-size: 13px;
    }

    .btn.ghost {
      background: #2b2f36;
    }

    .btn.alt {
      background: var(--accent-2);
    }

    .btn.alert {
      background: var(--accent-3);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid var(--line);
      padding: .3em .6em;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
    }

    .ok {
      color: var(--ok);
    }

    .warn {
      color: var(--warn);
    }

    .bad {
      color: var(--bad);
    }

    .hint {
      color: var(--muted);
      font-size: 12px;
    }

    section.tool-panel {
      margin-top: 16px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
    }

    section.tool-panel h4 {
      margin: 0 0 8px;
      font-size: 16px;
    }

    .divider {
      height: 1px;
      background: var(--line);
      margin: 10px 0 12px;
    }

    .two-col {
      display: grid;
      gap: 12px;
      grid-template-columns: 1fr;
    }

    @media (min-width: 800px) {
      .two-col {
        grid-template-columns: .9fr 1.1fr;
      }
    }

    /* ---------------- Kamera ---------------- */
    .camera-wrap {
      display: grid;
      gap: 10px;
    }

    video#camVideo {
      width: 100%;
      aspect-ratio: 9 / 16;
      max-height: 72vh;
      background: #000;
      border-radius: 10px;
    }

    canvas#camCanvas {
      display: none;
    }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #a33;
      box-shadow: 0 0 6px #600;
    }

    .dot.ok {
      background: #3c3;
      box-shadow: 0 0 8px #2a2;
    }

    #camMsg {
      min-width: 200px;
      color: var(--muted);
      font-size: 12px;
    }

    #camThumb {
      max-width: 220px;
      border-radius: 8px;
      border: 1px solid var(--line);
    }

    /* ---------------- Kompas + Libela ---------------- */
    .compass-wrap {
      display: grid;
      gap: 10px;
    }

    .compass-row {
      display: flex;
      gap: 14px;
      align-items: center;
      flex-wrap: wrap;
    }

    .compass {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      border: 1px solid var(--line);
      background: radial-gradient(closest-side, rgba(255,255,255,.06), rgba(0,0,0,0) 60%), radial-gradient(transparent 58%, #1b1f25 59%);
      display: grid;
      place-items: center;
      position: relative;
      perspective: 800px;
    }

    .compass .tick {
      position: absolute;
      inset: 8px;
      border-radius: 50%;
      border: 1px dashed #2a2f36;
    }

    .compass-ring {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,.18);
      box-shadow: 0 0 24px rgba(0,0,0,.25) inset;
      transform-origin: 50% 50%;
      transform: rotate(0deg);
      will-change: transform;
      backface-visibility: hidden;
    }

    .compass-ring .mark {
      position: absolute;
      font: 700 12px/1 Montserrat, system-ui;
      letter-spacing: .12em;
      color: #fff;
      text-shadow: 0 1px 2px rgba(0,0,0,.6);
      user-select: none;
    }

    .compass-ring .n {
      top: 4px;
      left: 50%;
      transform: translateX(-50%);
      color: #ff3b3b;
    }

    .compass-ring .s {
      bottom: 4px;
      left: 50%;
      transform: translateX(-50%);
    }

    .compass-ring .e {
      right: 4px;
      top: 50%;
      transform: translateY(-50%);
    }

    .compass-ring .w {
      left: 4px;
      top: 50%;
      transform: translateY(-50%);
    }

    .compass-ring .ticks {
      position: absolute;
      inset: 10px;
      border-radius: 50%;
      -webkit-mask: radial-gradient(transparent 56%, #000 56.3%);
      mask: radial-gradient(transparent 56%, #000 56.3%);
      background: conic-gradient(from 0deg, rgba(255,255,255,.18) 0 1deg, transparent 1deg 9deg);
    }

    .north-needle {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 4px;
      height: 120px;
      transform-origin: 50% 92%;
      transform: translate(-50%, -92%) rotate(0deg);
      filter: drop-shadow(0 0 4px rgba(255,0,0,.35));
      pointer-events: none;
    }

    .north-needle .tip {
      position: absolute;
      left: -6px;
      top: -6px;
      width: 16px;
      height: 40px;
      background: linear-gradient(#ff6464, #d30000);
      clip-path: polygon(50% 0, 100% 100%, 50% 78%, 0 100%);
      border-radius: 2px;
    }

        .target-arrow {
  position: absolute;
  left: 50%;
  top: 50%;
  width: 40px;
  height: 80px;
  transform: translate(-50%, -50%) rotate(0deg);
  transform-origin: 50% 50%;
  transform-box: fill-box;        /* ← bitno za SVG pivot */
  will-change: transform;         /* glađe */
  filter: drop-shadow(0 0 6px rgba(0,224,255,.5));
  opacity: 1;
  transition: opacity .25s ease;
  pointer-events: none;
}

    .arrow3d {
      width: 68px;
      height: 12px;
      position: relative;
      transform-style: preserve-3d;
      transition: transform .14s ease-out, opacity .14s ease-out, filter .2s ease-out;
      filter: drop-shadow(0 10px 14px rgba(0,0,0,.35));
    }

    .arrow3d::after {
      content: "";
      position: absolute;
      left: 0;
      top: 2px;
      bottom: 2px;
      width: 58px;
      border-radius: 6px;
      background: linear-gradient(180deg, #36c286, #1e915f);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.2), inset 0 -1px 0 rgba(0,0,0,.2);
      transform: translateZ(0.6px);
    }

    .arrow3d::before {
      content: "";
      position: absolute;
      right: -14px;
      top: -6px;
      border-left: 14px solid #36c286;
      border-top: 12px solid transparent;
      border-bottom: 12px solid transparent;
      transform: translateZ(0.8px);
      filter: drop-shadow(0 2px 2px rgba(0,0,0,.4));
    }

    .arrow3d.warn::after {
      background: linear-gradient(180deg, #f4c35f, #c78f2a);
    }

    .arrow3d.warn::before {
      border-left-color: #f4c35f;
    }

    .arrow3d.bad::after {
      background: linear-gradient(180deg, #ff7a7a, #d84e4e);
    }

    .arrow3d.bad::before {
      border-left-color: #ff7a7a;
    }

    .level-wrap {
      width: 140px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
    }

    .level-ring {
      position: relative;
      width: 140px;
      height: 140px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,.18);
      box-shadow: inset 0 0 18px rgba(0,0,0,.25);
      background: radial-gradient(circle at 50% 50%, rgba(255,255,255,.06) 0 55%, transparent 56% 100%);
      overflow: hidden;
    }

    .lvl-cross {
      position: absolute;
      background: rgba(255,255,255,.18);
      pointer-events: none;
    }

    .lvl-h {
      left: 8%;
      right: 8%;
      top: 50%;
      height: 1px;
      transform: translateY(-0.5px);
    }

    .lvl-v {
      top: 8%;
      bottom: 8%;
      left: 50%;
      width: 1px;
      transform: translateX(-0.5px);
    }

    .level-bubble {
      position: absolute;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, rgba(255,255,255,.85) 0 35%, rgba(255,255,255,.35) 36% 60%;
      box-shadow: none !important;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }

    .level-readout {
      display: flex;
      gap: 8px;
      font: 600 11px/1.2 Montserrat, system-ui;
      color: #fff;
      opacity: .8;
    }

    /* ---------------- Mini HUD strelica ---------------- */
    #miniCompass {
      position: fixed;
      left: 10px;
      bottom: 10px;
      z-index: 9999;
      width: 78px;
      height: 78px;
      border-radius: 14px;
      padding: 8px;
      background: rgba(18,20,22,.9);
      border: 1px solid var(--line);
      backdrop-filter: blur(6px);
      box-shadow: 0 8px 24px rgba(0,0,0,.35);
      touch-action: none;
      user-select: none;
    }

    #miniCompass .mini-ring {
      width: 100%;
      height: 52px;
      border-radius: 999px;
      border: 1px dashed #2a2f36;
      display: grid;
      place-items: center;
      position: relative;
      overflow: hidden;
    }

    #miniCompass .mini-needle {
      width: 40px;
      height: 6px;
      background: #2aa96b;
      border-radius: 4px;
      transform-origin: 0% 50%;
      transition: transform .14s ease-out, background .2s ease-out;
    }

    #miniCompass .mini-needle.warn {
      background: #e09f3e;
    }

    #miniCompass .mini-needle.bad {
      background: #e44747;
    }

    #miniCompass .mini-info {
      text-align: center;
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    #miniCompass[hidden] {
      display: none;
    }

      #targetArrow { display: none; }
#onPathOK { display: none; }
.hidden { display: none !important; }

    /* ---------------- Banner / Modal ---------------- */
    .banner {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: #2b2f36;
      border-top: 1px solid var(--line);
      padding: 8px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 10000;
    }

    .banner .msg {
      color: #ddd;
      font-size: 13px;
    }

    .banner .actions {
      margin-left: auto;
      display: flex;
      gap: 8px;
    }

    .modal-back {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display: none;
      place-items: center;
      z-index: 10001;
    }

    .modal {
      background: #161a1e;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 14px;
      max-width: 520px;
      width: 92%;
    }

    .modal h5 {
      margin: 0 0 6px;
      font-size: 16px;
    }

    .modal p {
      margin: 0 0 10px;
      color: var(--muted);
      font-size: 13px;
    }

    .modal .actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    /* ---------------- Meteo kartice ---------------- */
    .weather-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    }

    .wx-card {
      background: #14171b;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 10px;
    }

    .wx-card h5 {
      margin: 0 0 4px;
      font-size: 14px;
    }

    .wx-meta {
      font-size: 12px;
      color: var(--muted);
    }

    /* ---------------- Nebo (platno) ---------------- */
    #skyCanvas {
      width: 100%;
      max-width: 520px;
      height: 300px;
      background: #020309;
      border: 1px solid var(--line);
      border-radius: 10px;
      display: block;
    }

    .sky-legend {
      font-size: 12px;
      color: var(--muted);
    }

    /* ---------------- Flora/Fauna vodič ---------------- */
    .id-grid {
      display: grid;
      gap: 8px;
      grid-template-columns: 1fr;
    }

    .id-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .tag {
      padding: .35em .6em;
      background: #1a1d22;
      border: 1px solid var(--line);
      border-radius: 999px;
      font-size: 12px;
      color: #d8dee6;
    }

    footer {
      margin-top: 26px;
      border-top: 1px solid var(--line);
      padding: 14px;
      color: var(--muted);
      font-size: 12px;
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- =========================================================
       GORNJA NAVIGACIJA
       ========================================================= -->
  <nav class="navbar" aria-label="Glavna navigacija">
    <div class="brand">
      <img src="images/mountain-adventures.svg" alt="Logo">
      <span>Digitalni ruksak</span>
    </div>
    <div class="navgroup">
      <a class="navlink" href="#tool-aid">Vodiči</a>
      <a class="navlink" href="#tool-camera">Kamera</a>
      <a class="navlink" href="#tool-arrow">Kompas/GPX</a>
      <a class="navlink" href="#tool-sky">Noćno nebo</a>
      <a class="navlink" href="#tool-weather">Vrijeme</a>
      <a class="navlink" href="#tool-bio">Biljke/Životinje</a>
      <a class="navlink" href="#tool-offline">Offline</a>
      <a class="navlink" href="#tool-sos">SOS</a>
      <span class="flag" title="Jezik: Bosanski/Hrvatski/Srpski">
        <img src="https://flagcdn.com/w20/ba.png" alt="BA"> BA/HR/SR
      </span>
    </div>
  </nav>

  <!-- =========================================================
       NASLOV
       ========================================================= -->
  <header class="page-head">
    <h1>Digitalni ruksak</h1>
    <p class="intro">Vodiči, kamera, kompas (igla fiksna, N/E/S/W rotiraju) + target GPX, libela, noćno nebo, prognoza i terenski vodič.</p>
  </header>

  <!-- =========================================================
       GLAVNI SADRŽAJ — KARTICE ALATA
       ========================================================= -->
  <main>
    <section class="tools-grid" aria-label="Alati">
      <!-- Kartica: Vodiči -->
      <article class="tool-card" id="tool-aid">
        <div class="eyebrow">Prioritet</div>
        <h3>Digitalna pomoć (jasni, laički vodiči)</h3>
        <p>Brzi postupci koje svatko može slijediti. Prvo sigurnost mjesta, zatim 112.</p>
        <div class="btn-row">
          <button class="btn alt" id="openAidPanel">Otvori vodiče</button>
          <span class="chip">⛰️ Podsjetnici pri ruci</span>
        </div>
      </article>

      <!-- Kartica: Kamera -->
      <article class="tool-card" id="tool-camera">
        <div class="eyebrow">Foto</div>
        <h3>Pejzažno snimanje uživo</h3>
        <p>Stabilan kadar → blago pojačanje kontrasta/boje/oštrine → snimka (offline).</p>
        <ul>
          <li>Auto-stabilnost (snima kad se umiri)</li>
          <li>Radi na HTTPS/localhost</li>
          <li>Bez slanja na server</li>
        </ul>
        <div class="btn-row">
          <button class="btn" id="openCamPanel">Otvori alat</button>
          <a class="btn ghost" href="tools/camera-auto-enhance.html">U novoj kartici</a>
        </div>
        <p class="hint">Privatnost: slika ostaje u tvom pregledniku.</p>
      </article>

      <!-- Kartica: Kompas/GPX -->
      <article class="tool-card" id="tool-arrow">
        <div class="eyebrow">Orijentacija</div>
        <h3>Kompas (igla fiksna) + GPX target</h3>
        <p>Oznake N/E/S/W rotiraju prema headingu, crvena igla je fiksna i pokazuje <b>istinski sjever</b> (dekli.). Kad poravnaš s N (±5°), plava strelica pokazuje najbližu točku GPX staze.</p>
        <div class="btn-row">
          <button class="btn" id="openArrowPanel">Otvori alat</button>
          <button class="btn ghost" id="openPopupBtn" title="Mali odvojeni prozor s mini strelicom">Pop-up strelica</button>
          <button class="btn ghost" id="closePopupBtn" title="Zatvori pop-up" style="display:none">Zatvori pop-up</button>
        </div>
        <p class="hint">iOS traži “Motion & Orientation” dopuštenje; radi na HTTPS-u.</p>
      </article>

      <!-- Kartica: Nebo -->
      <article class="tool-card" id="tool-sky">
        <div class="eyebrow">Noć</div>
        <h3>Noćno nebo (Orion/Veliki medvjed)</h3>
        <p>Prikaz svjetlijih zvijezda. Ako telefon uperiš prema gore, asterizmi se <b>naglašavaju i spajaju linijama</b>.</p>
        <div class="btn-row">
          <button class="btn" id="openSkyPanel">Otvori nebo</button>
        </div>
        <p class="hint">Za preciznije aplikacije: Stellarium Mobile / Sky Map.</p>
      </article>

      <!-- Kartica: Vrijeme -->
      <article class="tool-card" id="tool-weather">
        <div class="eyebrow">Meteo</div>
        <h3>Prognoza (Open-Meteo)</h3>
        <p>Brza lokalna prognoza: temperatura, vjetar, oborina, UV.</p>
        <div class="btn-row">
          <button class="btn" id="openWeatherPanel">Otvori prognozu</button>
        </div>
        <p class="hint">Izvor: open-meteo.com (bez API ključa).</p>
      </article>

      <!-- Kartica: Flora/Fauna -->
      <article class="tool-card" id="tool-bio">
        <div class="eyebrow">Terenski vodič</div>
        <h3>Biljke i životinje (manualni ID)</h3>
        <p>Snimi fotku i usporedi s mini vodičem. (Za AI prepoznavanje preporuka: iNaturalist / Pl@ntNet.)</p>
        <div class="btn-row">
          <button class="btn" id="openBioPanel">Otvori vodič</button>
        </div>
        <p class="hint">Radi offline kao pomoć pri opažanju; online može otvoriti iNaturalist.</p>
      </article>

      <!-- Kartica: Offline -->
      <article class="tool-card" id="tool-offline">
        <div class="eyebrow">Navigacija</div>
        <h3>Offline karte & GPX</h3>
        <p>Preuzmi regiju u OSMand/Organic Maps; GPX spremi lokalno.</p>
        <div class="btn-row">
          <button class="btn ghost" id="openOfflinePanel">Brzi savjeti</button>
        </div>
      </article>

      <!-- Kartica: SOS -->
      <article class="tool-card" id="tool-sos">
        <div class="eyebrow">SOS</div>
        <h3>SOS zviždaljka</h3>
        <p>Glasan ton (••• — — — •••). 112 je prioritet.</p>
        <div class="btn-row">
          <button class="btn alert" id="playSOS">Pokreni SOS</button>
          <button class="btn ghost" id="stopSOS">Zaustavi</button>
        </div>
      </article>
    </section>

    <!-- =========================================================
         PANEL: VODIČI
         ========================================================= -->
    <section id="panelAid" class="tool-panel" hidden>
      <h4>Digitalna pomoć — laički vodiči</h4>
      <div class="two-col">
        <div>
          <div class="chip">ℹ️ Podsjetnik — ne zamjenjuje tečaj prve pomoći</div>
          <div class="divider"></div>
          <div class="aid-accordion" id="aidAcc">
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">🚑 KPR (odrasli)</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li><b>Najprije:</b> sigurno mjesto, pozovi <b>112</b>.</li>
                  <li><b>Ne diše normalno?</b> Kreni s KPR: dlan na sredinu prsnog koša, drugi dlan preko, laktovi ravno.</li>
                  <li><b>Ritam:</b> 100–120/min; <b>dubina 5–6 cm</b>. Pusti da se prsa vrate.</li>
                  <li>Omjer <b>30:2</b> samo ako znaš i imaš masku — inače samo pritisci.</li>
                </ul>
              </div>
            </div>
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">🩸 Jako krvarenje</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li><b>Stisni</b> direktno 10 minuta bez provjeravanja.</li>
                  <li>Ako promoči, <b>dodaj</b> preko (ne skidaj prvu gazu).</li>
                  <li>Za udove: kompresivni zavoj/turniket (zabilježi vrijeme).</li>
                </ul>
              </div>
            </div>
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">🧊 Hladnoća (hipotermija)</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li>Suho i toplo slojevito; vjetar/vlaga out.</li>
                  <li>Astrofolija: srebrna <b>prema tijelu</b> grije (zlatna vani).</li>
                </ul>
              </div>
            </div>
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">📢 112 — što reći</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li>Lokacija (koordinate/oznaka staze), što se dogodilo, broj osoba, pristup.</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="divider"></div>
          <div class="hint">Ovo su sažeti podsjetnici. Tečaj prve pomoći je preporučljiv.</div>
        </div>
        <div>
          <h4 style="margin-top:0">Brzi podsjetnici</h4>
          <ul>
            <li>Astrofolija: <b>srebrna prema tijelu</b>.</li>
            <li>KPR: <b>30:2</b> (ako znaš), 100–120/min.</li>
            <li>Krvarenje: <b>stisni 10 min</b>; dodaj preko.</li>
          </ul>
          <div class="chip" style="margin-top:8px">📞 112 — hitna pomoć i spašavanje</div>
        </div>
      </div>
    </section>

    <!-- =========================================================
         PANEL: KAMERA
         ========================================================= -->
    <section id="panelCamera" class="tool-panel" hidden>
      <h4>Pejzažno snimanje (ugrađeno)</h4>
      <div class="camera-wrap">
        <video id="camVideo" autoplay playsinline></video>
        <canvas id="camCanvas"></canvas>
        <div class="toolbar">
          <div id="camDot" class="dot" title="Pokazatelj mirnoće"></div>
          <div id="camMsg">Tražim stabilnost…</div>
          <button id="camManual" class="btn ghost">Snimi sada</button>
          <button id="camAuto" class="btn">Auto snimanje: ON</button>
          <button id="camClose" class="btn ghost">Zatvori</button>
        </div>
        <div class="result">
          <img id="camThumb" alt="Pregled snimljene fotografije">
          <div class="hint">Radi samo na HTTPS/localhost. Slika ostaje lokalno.</div>
        </div>
      </div>
    </section>

     <!-- PANEL: KOMPAS + GPX + DEKLINACIJA + LIBELA
         ========================================================= -->
    <section id="panelArrow" class="tool-panel" hidden>
      <h4>Kompas (igla fiksna, oznake rotiraju) + GPX target</h4>
      <div class="compass-wrap">
        <div class="compass-row">
          <!-- Kompas -->
          <div class="compass" aria-label="Kompas">
            <div class="compass-ring" id="compassRing">
              <span class="mark n">N</span>
              <span class="mark e">E</span>
              <span class="mark s">S</span>
              <span class="mark w">W</span>
              <div class="ticks"></div>
            </div>
            <div class="north-needle" id="northNeedle"><div class="tip"></div></div>
               <!-- Strelica koja NAVODI (sakrivena dok nema GPX ili si na stazi) -->
<svg id="targetArrow" width="72" height="72" viewBox="0 0 72 72" style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%) rotate(0deg); display:none; z-index:5;">
  <polygon points="36,6 46,30 36,26 26,30" fill="#e53935"/>
  <rect x="33" y="26" width="6" height="28" rx="3" fill="#e53935"/>
</svg>

<!-- Zelena kvačica kad si NA stazi -->
<div id="onPathOK" style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); display:none; z-index:5;">
  <svg width="64" height="64" viewBox="0 0 64 64">
    <circle cx="32" cy="32" r="28" fill="#2e7d32"/>
    <polyline points="20,33 28,41 46,23" fill="none" stroke="#fff" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
</div>
            <div class="tick"></div>
            <div id="arrow3d" class="arrow3d" style="opacity:0"></div>
          </div>

          <!-- Libela -->
          <div class="level-wrap" aria-label="Libela">
            <div class="level-ring" id="levelRing">
              <div class="lvl-cross lvl-h"></div>
              <div class="lvl-cross lvl-v"></div>
              <div class="level-bubble" id="levelBubble"></div>
            </div>
            <div class="level-readout">
              <span>Pitch: <b id="pitchDeg">0.0°</b></span>
              <span>Roll: <b id="rollDeg">0.0°</b></span>
            </div>
          </div>

          <div class="hint">
            N/E/S/W su na rotirajućem prstenu, crvena igla je fiksna. <br>
            Ako je igla poravnata s N (±5°), plava strelica pokazuje najbližu točku GPX staze.
          </div>
        </div>

        <div class="divider"></div>

        <!-- GPX Učitavanje -->
        <div class="compass-row">
          <div class="field">
            <label for="gpxInput">GPX file:</label>
            <input id="gpxInput" type="file" accept=".gpx,application/gpx+xml">
            <button class="btn ghost" id="loadGpxBtn">Učitaj</button>
          </div>

          <div class="field">
            <label for="gpxUrl">GPX URL:</label>
            <input id="gpxUrl" type="url" placeholder="https://…/ruta.gpx" style="width:260px">
            <button class="btn ghost" id="loadUrlBtn">Učitaj URL</button>
          </div>

          <div class="field">
            <label for="alertMeters">Prag (m) zvuka:</label>
            <input id="alertMeters" type="number" min="5" step="5" value="30">
            <button class="btn" id="toggleTrackBtn">Pokreni praćenje</button>
          </div>
        </div>

        <div class="status-line" style="margin-top:6px">
          <span class="chip" id="trackStatusPill">GPX: —</span>
          <span class="chip" id="onTrackChip">🧭 status: —</span>
          <span class="chip" id="offDistChip">↔︎ udaljenost: —</span>
        </div>

        <div class="divider"></div>

        <!-- Backtrack -->
        <div class="compass-row">
          <div class="btn-row">
            <button class="btn ghost" id="btStart">Započni povratak</button>
            <button class="btn ghost" id="btStop">Zaustavi povratak</button>
          </div>
          <span class="chip" id="btStatus">↩︎ Povratak: isključen</span>
        </div>

        <div class="divider"></div>

        <!-- Deklinacija i dozvole -->
        <div class="compass-row">
          <div class="chip">
            <label><input type="checkbox" id="useTrueNorth" checked> Geografski sjever</label>
          </div>
          <div class="chip">
            <label><input type="checkbox" id="autoDecl" checked> Auto deklinacija (offline + GPS)</label>
          </div>
          <div class="chip">
            Deklinacija: <input id="declInput" type="number" step="0.1" style="width:80px">°
          </div>
          <button class="btn ghost" id="declHelp">Upute</button>
          <button class="btn ghost" id="iosPermBtn" style="margin-left:auto">Omogući kompas (iOS)</button>
        </div>

        <p class="hint" style="margin-top:6px">Možeš dodati parametar: <code>?gpx=https://…/ruta.gpx</code></p>

        <div><button class="btn" id="arrowClose">Zatvori</button></div>
      </div>
    </section>

    <!-- =========================================================
         PANEL: NOĆNO NEBO (MINI PLANISFERA)
         ========================================================= -->
    <section id="panelSky" class="tool-panel" hidden>
      <h4>Noćno nebo — Orion i Veliki medvjed (beta)</h4>
      <canvas id="skyCanvas" width="520" height="300"></canvas>
      <div class="sky-legend" id="skyLegend">
        Pomakni telefon: prikaz prati orijentaciju (azimut). <br>
        Kad telefon uperiš prema gore (pitch &le; -60°), istaknut ćemo linije asterizama i nazive zvijezda.
      </div>
      <div class="divider"></div>
      <div class="btn-row">
        <button class="btn" id="skyStart">Uključi senzore</button>
        <button class="btn ghost" id="skyNow">Centriraj na sjever</button>
      </div>
    </section>

    <!-- =========================================================
         PANEL: PROGNOZA VREMENA (OPEN-METEO)
         ========================================================= -->
    <section id="panelWeather" class="tool-panel" hidden>
      <h4>Meteorološka prognoza — sljedeća 3 dana</h4>
      <div class="btn-row">
        <button class="btn" id="wxFetch">Dohvati prema lokaciji</button>
        <input id="wxLat" type="number" step="0.0001" placeholder="Lat" style="width:110px">
        <input id="wxLon" type="number" step="0.0001" placeholder="Lon" style="width:110px">
        <button class="btn ghost" id="wxFetchManual">Dohvati po koordinatama</button>
      </div>
      <div class="divider"></div>
      <div id="wxCity" class="chip">Lokacija: —</div>
      <div class="weather-grid" id="wxGrid"></div>
    </section>

    <!-- =========================================================
         PANEL: BILJKE / ŽIVOTINJE (MANUALNI ID)
         ========================================================= -->
    <section id="panelBio" class="tool-panel" hidden>
      <h4>Terenski vodič — Biljke i životinje (offline pomoć)</h4>
      <div class="id-grid">
        <div class="id-row">
          <button class="btn" id="bioOpenCam">Otvori kameru</button>
          <button class="btn ghost" id="bioSnap" disabled>Snimi</button>
          <button class="btn ghost" id="bioCloseCam" disabled>Zatvori</button>
          <button class="btn alt" id="bioINat">iNaturalist (online)</button>
        </div>
        <video id="bioVideo" autoplay playsinline style="width:100%;max-width:420px;border:1px solid var(--line);border-radius:10px;display:none"></video>
        <canvas id="bioCanvas" width="640" height="480" style="display:none"></canvas>
        <img id="bioPhoto" alt="Snimka za usporedbu" style="max-width:420px;border:1px solid var(--line);border-radius:10px;display:none">
        <div class="divider"></div>
        <div class="hint">Brzi vodič (općenito):</div>
        <div class="id-row">
          <span class="tag">Listovi suprotni ili naizmjenični?</span>
          <span class="tag">Rub lista: cijeli / nazubljen</span>
          <span class="tag">Cvijet: broj latica (4,5,6…)</span>
          <span class="tag">Plod: bobica / komuška / oraščić</span>
          <span class="tag">Stanište: livada / šuma / voda</span>
          <span class="tag">Životinja: tragovi — broj prstiju</span>
          <span class="tag">Perje: oblik repa i kljuna</span>
        </div>
      </div>
    </section>

    <!-- =========================================================
         PANEL: OFFLINE SAVJETI
         ========================================================= -->
    <section id="panelOffline" class="tool-panel" hidden>
      <h4>Offline savjeti</h4>
      <ul>
        <li><b>Organic Maps</b> ili <b>OSMand</b> — preuzmi regiju za offline.</li>
        <li>GPX spremi lokalno i otvori iz aplikacije (bez interneta).</li>
        <li>Uključi “Airplane mode” + GPS radi štednje baterije.</li>
      </ul>
      <button class="btn ghost" onclick="this.closest('section').hidden=true">Zatvori</button>
    </section>
  </main>

  <!-- =========================================================
       MINI HUD STRELICA + GPS BANNER + DEKLINACIJA MODAL
       ========================================================= -->
  <div id="miniCompass" aria-label="Mini strelica" hidden>
    <div class="mini-ring"><div id="miniNeedle" class="mini-needle"></div></div>
    <div class="mini-info"><span id="miniMeters">— m</span></div>
  </div>

  <div id="gpsBanner" class="banner" style="display:none">
    <div class="msg">📡 Nema GPS signala — čekam fix. Navigacija ograničena.</div>
    <div class="actions"><button class="btn ghost" id="bannerHide">Sakrij</button></div>
  </div>

  <div id="declModalBack" class="modal-back">
    <div class="modal">
      <h5>Deklinacija — kratke upute</h5>
      <p><b>Geografski sjever</b> je prema zemljinoj osi. <b>Magnetski sjever</b> je gdje pokazuje magnetometar. Razlika je <b>deklinacija</b> (E = dodaj +°, W = oduzmi °).</p>
      <p>Uključena je <b>Auto deklinacija</b> (offline procjena za Balkan + GPS korekcija). Po želji ručno promijeni brojku.</p>
      <div class="actions">
        <button class="btn ghost" id="declClose">Zatvori</button>
      </div>
    </div>
  </div>

  <!-- =========================================================
       PODNOŽJE
       ========================================================= -->
  <footer>© Mountain Adventures · Offline spremno (PWA) · Ako je opasno: zaustavi se i zovi 112.</footer>

  <!-- =========================================================
       SCRIPTS — LOGIKA
       ========================================================= -->
  <script>
    /* =========================================================
       PWA SERVICE WORKER
       ========================================================= */
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(()=>{});
    }

    /* =========================================================
       HELPERI / PANELI / UI
       ========================================================= */
    const qs = s => document.querySelector(s);
    const show = el => { if(!el) return; el.hidden=false; el.scrollIntoView({ behavior:'smooth', block:'start' }); };
    const hide = el => { if(!el) return; el.hidden=true; };
    const normalize = d => { d = d % 360; return d < 0 ? d + 360 : d; };

    const panelAid=qs('#panelAid'),
          panelCamera=qs('#panelCamera'),
          panelArrow=qs('#panelArrow'),
          panelSky=qs('#panelSky'),
          panelWeather=qs('#panelWeather'),
          panelBio=qs('#panelBio'),
          panelOffline=qs('#panelOffline');

    qs('#openAidPanel')?.addEventListener('click', () => show(panelAid));
    qs('#openCamPanel')?.addEventListener('click', async () => { show(panelCamera); await startCam(); });
    qs('#openArrowPanel')?.addEventListener('click', () => { show(panelArrow); openArrow(); });
    qs('#openSkyPanel')?.addEventListener('click', () => show(panelSky));
    qs('#openWeatherPanel')?.addEventListener('click', () => show(panelWeather));
    qs('#openBioPanel')?.addEventListener('click', () => show(panelBio));
    qs('#openOfflinePanel')?.addEventListener('click', () => show(panelOffline));


    /* =========================================================
       AKORDEON VODIČ
       ========================================================= */
    (function(){
      const acc=qs('#aidAcc'); if(!acc) return;
      acc.querySelectorAll('.aid-head').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const body=btn.parentElement.querySelector('.aid-body');
          const open=btn.classList.toggle('open');
          body.style.display=open?'block':'none';
        });
      });
    })();

    /* =========================================================
       KAMERA — AUTO STABILNOST I CAPTURE
       ========================================================= */
    const camClose=qs('#camClose'),
          camVideo=qs('#camVideo'),
          camCanvas=qs('#camCanvas'),
          camCtx=camCanvas?.getContext?.('2d',{willReadFrequently:true}),
          camDot=qs('#camDot'),
          camMsg=qs('#camMsg'),
          camThumb=qs('#camThumb'),
          camManual=qs('#camManual'),
          camAutoBtn=qs('#camAuto');

    const STABILITY_FRAMES=8,
          DIFF_THRESHOLD=6,
          CAPTURE_WIDTH=1600;

    let camAutoMode=true, camPrev=null, camSteady=0, camLastAuto=0, camLoopOn=false;

    camClose?.addEventListener('click', stopCam);
    camAutoBtn?.addEventListener('click', ()=>{
      camAutoMode=!camAutoMode;
      camAutoBtn.textContent=camAutoMode?'Auto snimanje: ON':'Auto snimanje: OFF';
    });
    camManual?.addEventListener('click', captureCam);

    async function startCam(){
      if(camLoopOn) return;
      try{
        const stream=await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
        camVideo.srcObject=stream; await camVideo.play();
        camCanvas.width=Math.min(1280,camVideo.videoWidth||1280);
        camCanvas.height=Math.min(720,camVideo.videoHeight||720);
        camLoopOn=true; requestAnimationFrame(camLoop);
      }catch(e){ camMsg.textContent='Greška s kamerom: '+e.message; }
    }
    function stopCam(){
      hide(panelCamera);
      camLoopOn=false;
      try{
        camVideo.pause();
        camVideo.srcObject?.getTracks?.().forEach(t=>t.stop());
        camVideo.srcObject=null;
      }catch(e){}
    }
    function lumaAt(d,i){ return 0.2126*d[i]+0.7152*d[i+1]+0.0722*d[i+2]; }
    function frameDiff(a,b){
      const da=a.data, db=b.data; let s=0,n=da.length/4;
      for(let p=0,i=0;p<n;p++,i+=4){ s+=Math.abs(lumaAt(da,i)-lumaAt(db,i)); }
      return s/n;
    }
    function autoContrast(img){
      const d=img.data,n=d.length/4; let lo=255,hi=0;
      for(let i=0;i<n;i++){const idx=i*4,L=lumaAt(d,idx); if(L<lo)lo=L; if(L>hi)hi=L;}
      const range=Math.max(1,hi-lo),scale=255/range;
      for(let i=0;i<n;i++){
        const idx=i*4;
        d[idx]=Math.min(255,Math.max(0,(d[idx]-lo)*scale));
        d[idx+1]=Math.min(255,Math.max(0,(d[idx+1]-lo)*scale));
        d[idx+2]=Math.min(255,Math.max(0,(d[idx+2]-lo)*scale));
      }
      return img;
    }
    function unsharp(img,a=.55,r=1){
      const w=img.width,h=img.height,s=img.data,out=new Uint8ClampedArray(s.length);
      for(let y=0;y<h;y++){
        for(let x=0;x<w;x++){
          let rsum=0,gsum=0,bsum=0,c=0;
          for(let oy=-r;oy<=r;oy++){
            const yy=Math.min(h-1,Math.max(0,y+oy));
            for(let ox=-r;ox<=r;ox++){
              const xx=Math.min(w-1,Math.max(0,x+ox)),i=(yy*w+xx)*4;
              rsum+=s[i]; gsum+=s[i+1]; bsum+=s[i+2]; c++;
            }
          }
          const i=(y*w+x)*4, br=rsum/c, bg=gsum/c, bb=bsum/c;
          out[i]=Math.min(255,Math.max(0,s[i]+a*(s[i]-br)));
          out[i+1]=Math.min(255,Math.max(0,s[i+1]+a*(s[i+1]-bg)));
          out[i+2]=Math.min(255,Math.max(0,s[i+2]+a*(s[i+2]-bb)));
          out[i+3]=s[i+3];
        }
      }
      img.data.set(out); return img;
    }
    async function camLoop(){ if(!camLoopOn) return;
      if(camVideo.readyState>=2){
        camCtx.drawImage(camVideo,0,0,camCanvas.width,camCanvas.height);
        const cur=camCtx.getImageData(0,0,camCanvas.width,camCanvas.height);
        if(camPrev){
          const diff=frameDiff(cur,camPrev);
          if(diff<DIFF_THRESHOLD){ camSteady++; camDot.classList.add('ok'); camMsg.textContent=`Mirno — ${camSteady}/${STABILITY_FRAMES}`; }
          else{ camSteady=0; camDot.classList.remove('ok'); camMsg.textContent=`Nemirno (${Math.round(diff)}), drži mirnije`; }
          if(camSteady>=STABILITY_FRAMES && camAutoMode){
            const now=Date.now();
            if(now-camLastAuto>2500){ camLastAuto=now; await captureCam(); }
            camSteady=0;
          }
        }
        camPrev=cur;
      }
      requestAnimationFrame(camLoop);
    }
    async function captureCam(){
      camMsg.textContent='Snimam i obrađujem…';
      try{
        const track=camVideo.srcObject?.getVideoTracks?.[0];
        if(track && window.ImageCapture){
          const ic=new ImageCapture(track);
          if(ic.takePhoto){
            const blob=await ic.takePhoto();
            const bmp=await createImageBitmap(blob);
            const r=bmp.width/bmp.height;
            const W=Math.min(CAPTURE_WIDTH,bmp.width), H=Math.round(W/r);
            camCanvas.width=W; camCanvas.height=H;
            camCtx.drawImage(bmp,0,0,W,H);
            camCtx.filter='contrast(1.06) saturate(1.08)';
            camCtx.drawImage(camCanvas,0,0);
            camCtx.filter='none';
            let id=camCtx.getImageData(0,0,W,H);
            id=autoContrast(id); id=unsharp(id,.6,1);
            camCtx.putImageData(id,0,0);
            const url=camCanvas.toDataURL('image/jpeg',0.92);
            camThumb.src=url;
            camMsg.innerHTML='Gotovo. <a style="margin-left:8px" download="mountain-photo.jpg" href="'+url+'">Preuzmi</a>';
            return;
          }
        }
      }catch(e){}
      const r=(camVideo.videoWidth||1080)/(camVideo.videoHeight||1920);
      const W=Math.min(CAPTURE_WIDTH,camVideo.videoWidth||1280), H=Math.round(W/r);
      camCanvas.width=W; camCanvas.height=H;
      camCtx.drawImage(camVideo,0,0,W,H);
      camCtx.filter='contrast(1.06) saturate(1.08)';
      camCtx.drawImage(camCanvas,0,0);
      camCtx.filter='none';
      let id=camCtx.getImageData(0,0,W,H);
      id=autoContrast(id); id=unsharp(id,.6,1);
      camCtx.putImageData(id,0,0);
      const url=camCanvas.toDataURL('image/jpeg',0.92);
      camThumb.src=url;
      camMsg.innerHTML='Gotovo. <a style="margin-left:8px" download="mountain-photo.jpg" href="'+url+'">Preuzmi</a>';
    }


/* =========================================================
   KOMPAS/GPX — FIKSNE OZNAKE + FIKSNA IGla + TARGET
   (stabilno, bez treperenja; jedan sensor event; kvantizacija)
   ========================================================= */

    const arrowEl=qs('#arrow3d'),
      gpxInput=qs('#gpxInput'),
      loadGpxBtn=qs('#loadGpxBtn'),
      gpxUrl=qs('#gpxUrl'),
      loadUrlBtn=qs('#loadUrlBtn'),
      alertMetersInput=qs('#alertMeters'),
      toggleTrackBtn=qs('#toggleTrackBtn'),
      trackStatusPill=qs('#trackStatusPill'),
      onTrackChip=qs('#onTrackChip'),
      offDistChip=qs('#offDistChip');

const mini=qs('#miniCompass'),
      miniNeedle=qs('#miniNeedle'),
      miniMeters=qs('#miniMeters');

const compassRing = qs('#compassRing');
const northNeedle = qs('#northNeedle');
const targetArrow = qs('#targetArrow');
const levelRing   = qs('#levelRing');
const levelBubble = qs('#levelBubble');
const pitchLbl    = qs('#pitchDeg');
const rollLbl     = qs('#rollDeg');

const useTrueNorthEl = qs('#useTrueNorth');
const autoDeclEl     = qs('#autoDecl');
const declInput      = qs('#declInput');
const declModalBack  = qs('#declModalBack');
const declHelpBtn    = qs('#declHelp');
const declCloseBtn   = qs('#declClose');
const iosPermBtn     = qs('#iosPermBtn');
const gpsBanner      = qs('#gpsBanner');
const bannerHide     = qs('#bannerHide');

bannerHide?.addEventListener('click', ()=> gpsBanner.style.display='none');
declHelpBtn?.addEventListener('click', ()=> declModalBack.style.display='grid');
declCloseBtn?.addEventListener('click', ()=> declModalBack.style.display='none');

   // ---- NAV STATE: NO_TRACK / ON_PATH / OFF_PATH ----
const onPathOK = document.getElementById('onPathOK');

const NAV = {
  NO_TRACK: 'NO_TRACK',   // nema učitane staze -> ne prikazuj strelicu
  ON_PATH:  'ON_PATH',    // dovoljno blizu staze -> prikaži zelenu kvačicu
  OFF_PATH: 'OFF_PATH'    // daleko od staze -> prikaži strelicu
};

let navState = NAV.NO_TRACK;
const ONPATH_THRESH_M = 20; // prag za “na stazi” (po želji 10–25 m)

function setNavState(state){
  if (navState === state) return;
  navState = state;
  if (navState === NAV.NO_TRACK){
    targetArrow.style.display = 'none';
    onPathOK.style.display    = 'none';
  } else if (navState === NAV.ON_PATH){
    targetArrow.style.display = 'none';
    onPathOK.style.display    = 'block';
  } else { // OFF_PATH
    onPathOK.style.display    = 'none';
    targetArrow.style.display = 'block';
  }
}

// inicijalno: nema staze
setNavState(NAV.NO_TRACK);
    
// Stanje i konstante
const R=6371000, RAD=Math.PI/180, DEG=180/Math.PI;
let gpxTrack=null, watchId=null, alertMeters=30, audioCtx=null, offBeepArmed=false;
let lastFix=null, lastKnownLat=null, lastKnownLon=null;
let headingDeg=null;          // magnetski heading (0..360)
let correctedHeading=null;    // heading nakon deklinacije i screen offseta
let lastBrg = null;   // zadnji bearing prema najbližoj točki (iz GPS-a)
let useTrueNorth = JSON.parse(localStorage.getItem('ma_useTrueNorth') || 'true');
let autoDecl     = JSON.parse(localStorage.getItem('ma_autoDecl') || 'true');
let declinationDeg = parseFloat(localStorage.getItem('ma_declinationDeg') || '4.3');
const ALIGN_TOLERANCE = 5;
const COG_MIN_SPEED = 0.5;

useTrueNorthEl.checked = useTrueNorth;
autoDeclEl.checked = autoDecl;
declInput.value = (+declinationDeg).toFixed(1);

useTrueNorthEl.addEventListener('change', ()=>{
  useTrueNorth = useTrueNorthEl.checked;
  localStorage.setItem('ma_useTrueNorth', JSON.stringify(useTrueNorth));
  if(headingDeg!=null) applyHeading(headingDeg);
});
autoDeclEl.addEventListener('change', ()=>{
  autoDecl = autoDeclEl.checked;
  localStorage.setItem('ma_autoDecl', JSON.stringify(autoDecl));
});
declInput.addEventListener('change', ()=>{
  const v=parseFloat(declInput.value);
  if(Number.isFinite(v)){
    declinationDeg=v;
    localStorage.setItem('ma_declinationDeg', String(declinationDeg));
    if(headingDeg!=null) applyHeading(headingDeg);
  }
});

// Gruba offline mreža deklinacije (Balkan)
const DEC_GRID={ lats:[40,42,44,46], lons:[12,16,20,24], vals:[[2.0,3.0,4.0,4.8],[2.6,3.6,4.6,5.4],[3.0,4.1,5.1,6.0],[3.3,4.4,5.4,6.3]] };
function bilerp(x,x0,x1,y,y0,y1,q11,q21,q12,q22){ const tx=(x-x0)/(x1-x0||1), ty=(y-y0)/(y1-y0||1); const a=q11*(1-tx)+q21*tx, b=q12*(1-tx)+q22*tx; return a*(1-ty)+b*ty; }
function estimateDeclination(lat,lon){
  const {lats,lons,vals}=DEC_GRID;
  lat=Math.max(lats[0],Math.min(lats.at(-1),lat));
  lon=Math.max(lons[0],Math.min(lons.at(-1),lon));
  let i=lats.findIndex((v,idx)=>lat>=v&&(idx===lats.length-1||lat<lats[idx+1])); if(i<0) i=lats.length-2;
  let j=lons.findIndex((v,idx)=>lon>=v&&(idx===lons.length-1||lon<lons[idx+1])); if(j<0) j=lons.length-2;
  return bilerp(lon,lons[j],lons[j+1],lat,lats[i],lats[i+1], vals[i][j],vals[i][j+1],vals[i+1][j],vals[i+1][j+1]);
}

// Geometrija
const toRad=x=>x*RAD;
function toXY(lat,lon,lat0){ const x=(lon*RAD)*Math.cos(lat0*RAD)*R, y=(lat*RAD)*R; return {x,y}; }
function haversine(lat1,lon1,lat2,lon2){ const dφ=toRad(lat2-lat1), dλ=toRad(lon2-lon1); const a=Math.sin(dφ/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dλ/2)**2; return 2*R*Math.asin(Math.sqrt(a)); }
function bearingBetween(lat1,lon1,lat2,lon2){ const φ1=toRad(lat1), φ2=toRad(lat2), Δλ=toRad(lon2-lon1); const y=Math.sin(Δλ)*Math.cos(φ2); const x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ); return ((Math.atan2(y,x)*DEG)+360)%360; }
function nearestPointOnTrack(p,track){
  let best={lat:track[0].lat,lon:track[0].lon,distM:Infinity,segIndex:0};
  const lat0=p.lat, P=toXY(p.lat,p.lon,lat0);
  for(let i=0;i<track.length-1;i++){
    const A=toXY(track[i].lat,track[i].lon,lat0), B=toXY(track[i+1].lat,track[i+1].lon,lat0);
    const ABx=B.x-A.x, ABy=B.y-A.y, APx=P.x-A.x, APy=P.y-A.y;
    const ab2=ABx*ABx + ABy*ABy || 1;
    let t=(APx*ABx + APy*ABy)/ab2; t=Math.max(0,Math.min(1,t));
    const Qx=A.x+t*ABx, Qy=A.y+t*ABy;
    const lon=(Qx/(R*Math.cos(lat0*RAD)))*(180/Math.PI), lat=(Qy/R)*(180/Math.PI);
    const d=haversine(p.lat,p.lon,lat,lon);
    if(d<best.distM) best={lat,lon,distM:d,segIndex:i};
  }
  return best;
}

// Mini HUD util
function setArrowMode(mode){
  arrowEl.classList.remove('warn','bad');
  if(mode==='warn'){ arrowEl.classList.add('warn'); }
  else if(mode==='bad'){ arrowEl.classList.add('bad'); }
}
function showMini(){ mini.hidden=false; }
function hideMini(){ mini.hidden=true; }
function setMiniColor(mode){
  miniNeedle.classList.remove('warn','bad');
  if(mode==='warn') miniNeedle.classList.add('warn');
  else if(mode==='bad') miniNeedle.classList.add('bad');
}

// Libela
function renderLevel(pitch=0,roll=0){
  const ringRect = levelRing.getBoundingClientRect();
  const Rb = (ringRect.width/2) - 13;
  const maxTilt = 30;
  let x = (roll / maxTilt) * Rb;
  let y = (pitch / maxTilt) * Rb;
  const dist = Math.hypot(x,y);
  if(dist>Rb){ const k=Rb/dist; x*=k; y*=k; }
  levelBubble.style.left = '50%';
  levelBubble.style.top  = '50%';
  levelBubble.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
  pitchLbl.textContent = `${pitch.toFixed(1)}°`;
  rollLbl.textContent  = `${roll.toFixed(1)}°`;
}

// Orijentacija ekrana
function screenAngle(){
  const a = (screen.orientation && screen.orientation.angle) || window.orientation || 0;
  return (typeof a === 'number') ? a : 0;
}

// === Smoothing + render petlja (anti-flicker) ===
let rafId = null;
let smooth = 0, EMA = 0.12;          // malo sporije za glatkije
let activeOriEvent = null;           // 'deviceorientation' ili 'deviceorientationabsolute'
let lastHeadTs = 0;                  // debouncing ulaza

   function renderCompassRing(){
  if (typeof correctedHeading === 'number') {
    const delta = ((((correctedHeading - smooth) + 540) % 360) - 180);
    smooth = smooth + EMA * delta;

    // kvantizacija na 0.5° smanjuje treperenje teksta
    const smoothQuant = Math.round(smooth * 2) / 2;

    // promote to GPU layer
    compassRing.style.transform = `translateZ(0) rotate(${-smoothQuant}deg)`;

    //  — prikaz strelice samo kad je OFF_PATH + poravnato na N —
const off = Math.min(normalize(smoothQuant), 360 - normalize(smoothQuant));
const aligned = off <= ALIGN_TOLERANCE;

if (navState === NAV.OFF_PATH && aligned) {
  targetArrow.style.opacity = 1;
  if (lastBrg != null) {
    const rel = (lastBrg - smoothQuant + 360) % 360; // relativno na prsten
    targetArrow.style.transform = `translate(-50%, -50%) rotate(${rel}deg)`;
  }
} else {
  targetArrow.style.opacity = 0;
}
  }
  rafId = requestAnimationFrame(renderCompassRing);
}

// Primijeni heading (magnetski) -> true/mag + deklinacija + screen offset
    function applyHeading(mag, isIOS){
  // 1) magnetski -> (opcionalno) geografski
  let h = normalize(mag);
  if (useTrueNorth) h = normalize(h + declinationDeg);

  // 2) korekcija za orijentaciju ekrana SAMO na Androidu (alpha), NE iOS webkitCompassHeading
  if (!isIOS) {
    h = normalize(h - screenAngle());
  }

  correctedHeading = h;
}

// Senzori (heading) — s debouncingom
  function onOrient3D(e){
  const now = performance.now();
  if (now - lastHeadTs < 30) return;  // ~33 fps input
  lastHeadTs = now;

  let isIOSHeading = false;

  if (typeof e.webkitCompassHeading === 'number' && Number.isFinite(e.webkitCompassHeading)) {
    headingDeg = normalize(e.webkitCompassHeading); // iOS — već tilt-kompenzirano
    isIOSHeading = true;
  } else if (typeof e.alpha === 'number') {
    headingDeg = normalize(360 - e.alpha);         // Android — 0° = sjever gore
    isIOSHeading = false;
  } else {
    return;
  }

  applyHeading(headingDeg, isIOSHeading);

  // Libela
  renderLevel(
    e.beta ? Number(e.beta) : 0,
    e.gamma ? Number(e.gamma) : 0
  );
}

// iOS gumb — samo pozove helper
iosPermBtn?.addEventListener('click', async ()=>{
  await startCompassSensors();
  iosPermBtn.style.display='none';
});

// Start senzora — koristi točno JEDAN event
async function startCompassSensors() {
  if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
    alert('Senzori kompasa rade samo na HTTPS/localhost.');
    return;
  }
  try {
    if (typeof DeviceOrientationEvent !== 'undefined' &&
        typeof DeviceOrientationEvent.requestPermission === 'function') {
      const r = await DeviceOrientationEvent.requestPermission();
      if (r !== 'granted') { alert('Bez dozvole senzora kompas neće raditi na iOS-u.'); return; }
    }
  } catch(e) {}

  // biraj apsolutni ako postoji, inače standardni — ali samo jedan
  if ('ondeviceorientationabsolute' in window) {
    window.addEventListener('deviceorientationabsolute', onOrient3D, true);
    activeOriEvent = 'deviceorientationabsolute';
  } else if ('ondeviceorientation' in window) {
    window.addEventListener('deviceorientation', onOrient3D, true);
    activeOriEvent = 'deviceorientation';
  } else {
    // fallback
    window.addEventListener('deviceorientation', onOrient3D, true);
    activeOriEvent = 'deviceorientation';
  }

  window.addEventListener('orientationchange', ()=> {
    if (headingDeg != null) applyHeading(headingDeg);
  }, {passive:true});
}

    // Otvaranje kompasa
function openArrow(){
  startCompassSensors();                    // upali senzore
  const urlParam=new URL(location.href).searchParams.get('gpx');
  if(urlParam) loadGpxFromUrl(urlParam);    // auto-učitaj GPX iz URL-a
  // dok GPX nije učitan, drži state na NO_TRACK
     setNavState(gpxTrack && gpxTrack.length >= 2 ? NAV.ON_PATH : NAV.NO_TRACK);
  if (!rafId) renderCompassRing();          // pokreni render petlju samo jednom
}

// ---------------------------------------------------
// FUNKCIJE ZA STRELICU (rotacija + boja prema udaljenosti)
// ---------------------------------------------------

   function updateArrowColor(distance) {
  const arrow = document.getElementById('targetArrow');
  if (!arrow) return;

  let color = distance <= 10 ? '#2aa96b'      // zelena (on-track)
            : distance <= 20 ? '#f2c14e'      // žuta (10–20m)
            : '#ff6b6b';                      // crvena (>20m)

  arrow.querySelectorAll('rect, polygon')
       .forEach(el => el.setAttribute('fill', color));
}

/* ---------- GPX parsiranje i učitavanje ---------- */
async function loadGpxFromUrl(url){
  try{
    const res=await fetch(url,{mode:'cors'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const txt=await res.text();
    gpxTrack=parseGpxToTrack(txt);
    afterGpxLoaded(`GPX (URL): ${gpxTrack.length} točaka`);
  }catch(e){
    trackStatusPill.textContent='GPX URL: ne mogu učitati (CORS?)';
    console.error(e);
  }
}
function parseGpxToTrack(xml){
  const dom=new DOMParser().parseFromString(xml,'application/xml');
  let pts=[...dom.querySelectorAll('trkpt')].map(n=>({lat:+n.getAttribute('lat'), lon:+n.getAttribute('lon')}));
  if(!pts.length){
    pts=[...dom.querySelectorAll('rtept')].map(n=>({lat:+n.getAttribute('lat'), lon:+n.getAttribute('lon')}));
  }
  return pts.filter(p=>Number.isFinite(p.lat)&&Number.isFinite(p.lon));
}
function afterGpxLoaded(label){
  if (!gpxTrack || gpxTrack.length < 2) {
    trackStatusPill.textContent = 'GPX: premalo točaka';
    // nema valjane staze → ništa ne navodi
    setNavState(NAV.NO_TRACK);
    targetArrow.style.opacity = 0; // osiguraj da je skriveno
    return;
  }

  trackStatusPill.textContent = label;
  onTrackChip.textContent = '🧭 status: GPX spreman — klikni “Pokreni praćenje”';
  offDistChip.textContent = '↔︎ udaljenost: —';
  toggleTrackBtn.classList.add('alt');
  setTimeout(() => toggleTrackBtn.classList.remove('alt'), 1400);

  // GPX je učitan, ali dok ne dođe PRVI GPS fix ne navodimo ništa
  setNavState(NAV.NO_TRACK);
}
    
loadGpxBtn?.addEventListener('click', async ()=>{
  const f=gpxInput?.files?.[0];
  if(!f){ trackStatusPill.textContent='GPX: nema datoteke'; return; }
  try{ const txt=await f.text(); gpxTrack=parseGpxToTrack(txt); afterGpxLoaded(`GPX (file): ${gpxTrack.length} točaka`); }
  catch(e){ trackStatusPill.textContent='GPX: greška pri učitavanju'; console.error(e); }
});
loadUrlBtn?.addEventListener('click', async ()=>{
  const url=gpxUrl.value.trim();
  if(!url){ trackStatusPill.textContent='GPX URL: prazno'; return; }
  await loadGpxFromUrl(url);
});

/* ---------- GPS praćenje + target ---------- */
let distLP=null; const DIST_ALPHA=0.35;

toggleTrackBtn?.addEventListener('click', ()=>{
  alertMeters=Math.max(5, Number(alertMetersInput.value)||30);
  if(watchId==null){
    if(!gpxTrack || gpxTrack.length<2){ trackStatusPill.textContent='GPX: učitaj trag prvo'; return; }
    startGeoWatch(); toggleTrackBtn.textContent='Zaustavi praćenje';
  } else { stopGeoWatch(); toggleTrackBtn.textContent='Pokreni praćenje'; }
});

function startGeoWatch(){
  try{
    watchId=navigator.geolocation.watchPosition(onPos,onGeoErr,{enableHighAccuracy:true, maximumAge:1000, timeout:10000});
    trackStatusPill.textContent='GPS: praćenje uključeno';
    offBeepArmed=true; showMini();
  }catch(e){ trackStatusPill.textContent='GPS: ne mogu pokrenuti'; }
}
function stopGeoWatch(){
  if(watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
  trackStatusPill.textContent='GPS: zaustavljeno';
  hideMini(); gpsBanner.style.display='none';
  lastFix=null;
}
function onGeoErr(err){
  trackStatusPill.textContent='GPS greška: '+(err?.message||'');
  gpsBanner.style.display='flex';
}

function updateOffTrackUI(dist){
  if(dist<=5){ setArrowMode('ok'); onTrackChip.textContent='🧭 status: na tragu ✓'; }
  else if(dist<=alertMeters){ setArrowMode('warn'); onTrackChip.textContent='🧭 status: blizu ruba'; }
  else { setArrowMode('bad'); onTrackChip.textContent='🧭 status: izvan traga'; if(offBeepArmed){ offBeepArmed=false; beep3(); setTimeout(()=>offBeepArmed=true,8000); } }
  offDistChip.textContent=`↔︎ udaljenost: ${dist.toFixed(0)} m`;
}

function onPos(pos){
  gpsBanner.style.display='none';
  const lat=pos.coords.latitude, lon=pos.coords.longitude, acc=pos.coords.accuracy;
  lastKnownLat=lat; lastKnownLon=lon;

  if(autoDecl && Number.isFinite(lat) && Number.isFinite(lon)){
    const est=estimateDeclination(lat,lon);
    if(Number.isFinite(est)){
      declinationDeg = est; declInput.value = est.toFixed(1);
      localStorage.setItem('ma_declinationDeg', String(declinationDeg));
      if(headingDeg!=null) applyHeading(headingDeg);
    }
  }

  if(!gpxTrack || gpxTrack.length<2){ return; }
  if(Number.isFinite(acc) && acc>50){ onTrackChip.textContent='🧭 status: GPS netočan (>50 m)'; return; }

  const nearest = nearestPointOnTrack({lat, lon}, gpxTrack);

let dist = nearest.distM;
distLP = distLP == null ? dist : (DIST_ALPHA * dist + (1 - DIST_ALPHA) * distLP);

// 1) State: jesmo li “na stazi” ili “izvan”?
if (distLP <= ONPATH_THRESH_M) {
  setNavState(NAV.ON_PATH);     // pokaži zelenu kvačicu
} else {
  setNavState(NAV.OFF_PATH);    // prikaži strelicu (vidjet će se tek kad poravnaš N)
}

// 2) UI pilule i boja strelice (boja je OK prikazati i dok je strelica skrivena)
updateOffTrackUI(distLP);
updateArrowColor(distLP);

// 3) Bearing prema najbližoj točki (čuva se za render)
const brg = bearingBetween(lat, lon, nearest.lat, nearest.lon);
lastBrg = brg;

  miniMeters.textContent=`${distLP.toFixed(0)} m`;
  if(correctedHeading!=null){
    const miniRot = Math.round(((brg - correctedHeading + 360)%360)/5)*5;
    miniNeedle.style.transform=`rotate(${miniRot}deg)`;
  }
  const mode = distLP<=5 ? 'ok' : (distLP<=alertMeters ? 'warn' : 'bad');
  setMiniColor(mode);

  const spd = Number.isFinite(pos.coords.speed)?pos.coords.speed:0;
  if(spd>=COG_MIN_SPEED && lastFix){
    const cog=bearingBetween(lastFix.lat,lastFix.lon,lat,lon);
    if(headingDeg!=null){
      let diff=cog-(useTrueNorth?normalize(headingDeg+declinationDeg):headingDeg);
      if(diff>180) diff-=360; if(diff<-180) diff+=360;
      const blended=(useTrueNorth?normalize(headingDeg+declinationDeg):headingDeg)+0.4*diff;
      correctedHeading = normalize(blended - screenAngle());
    } else {
      correctedHeading = normalize(cog - screenAngle());
    }
  }
  lastFix = {lat,lon,t:Date.now()};

   window.__btOnPosition(pos.coords.latitude, pos.coords.longitude);
}

// zatvaranje panela — ukloni listener koji je stvarno dodan
qs('#arrowClose')?.addEventListener('click', ()=>{
  hide(panelArrow);
  if (activeOriEvent) window.removeEventListener(activeOriEvent, onOrient3D, true);
  if(watchId!=null) navigator.geolocation.clearWatch(watchId);
});

/* ---------- Beep upozorenje ---------- */
function beep3(){
  try{
    audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
    const seq = [900,900,900]; 
    let t = audioCtx.currentTime;
    seq.forEach((f)=>{
      const osc=audioCtx.createOscillator(); 
      const gain=audioCtx.createGain();
      osc.type='sine'; 
      osc.frequency.value=f; 
      osc.connect(gain); 
      gain.connect(audioCtx.destination);

      gain.gain.setValueAtTime(0.0001, t); 
      gain.gain.exponentialRampToValueAtTime(0.25, t+0.02);

      osc.start(t); 
      osc.stop(t+0.15);
      gain.gain.exponentialRampToValueAtTime(0.0001, t+0.15);

      t += 0.27;
    });

    // Dodana vibracija (ako je podržana)
    if (navigator.vibrate) {
      // uzorak: vibracija 150ms → pauza 120ms → vibracija 150ms → pauza 120ms → vibracija 150ms
      navigator.vibrate([150, 120, 150, 120, 150]); 
    }
  }catch(e){}
}


  // ======== BACKTRACK: stanje + postavke ========
  let backtrackActive = false;
  let backtrackPoints = [];
  const BT_MIN_DIST_M = 8; // minimalni pomak da dodamo novu točku

  const btStartBtn = document.getElementById('btStart');
  const btStopBtn  = document.getElementById('btStop');
  const btStatusEl = document.getElementById('btStatus');

  function btUpdateStatus(msg) {
    if (btStatusEl) btStatusEl.textContent = `↩︎ ${msg}`;
  }

  // ======== Start / Stop ========
  function btStart() {
    backtrackActive = true;
    backtrackPoints = [];
    btUpdateStatus('Povratak: snimam…');
  }

  function btStop() {
    backtrackActive = false;
    btUpdateStatus(`Povratak: isključen — točaka: ${backtrackPoints.length}`);
  }

  btStartBtn?.addEventListener('click', btStart);
  btStopBtn?.addEventListener('click',  btStop);

  // ======== Hook koji poziva onPos ========
  window.__btOnPosition = function(lat, lon) {
    if (!backtrackActive) return;
    const last = backtrackPoints[backtrackPoints.length - 1];
    if (!last) {
      backtrackPoints.push([lat, lon]);
      return;
    }
    const d = haversine(last[0], last[1], lat, lon);
    if (d >= BT_MIN_DIST_M) {
      backtrackPoints.push([lat, lon]);
    }
  };

  // (Opcionalno) Izvoz u GPX
  window.exportBacktrackGPX = function() {
    if (!backtrackPoints.length) { alert('Nema backtrack točaka.'); return; }
    const gpxPts = backtrackPoints
      .map(([la,lo]) => `<trkpt lat="${la}" lon="${lo}"></trkpt>`)
      .join('\n    ');
    const gpx =
`<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="Digitalni ruksak" xmlns="http://www.topografix.com/GPX/1/1">
  <trk><name>Backtrack</name><trkseg>
    ${gpxPts}
  </trkseg></trk>
</gpx>`;
    const blob = new Blob([gpx], {type:'application/gpx+xml'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'backtrack.gpx'; a.click();
    URL.revokeObjectURL(url);
  };
    
    /* =========================================================
       NOĆNO NEBO — UPRAVLJANJE I ISTICANJE ASTERIZAMA
       ========================================================= */
    const skyCanvas = qs('#skyCanvas');
    const skyCtx = skyCanvas?.getContext('2d');
    const skyStartBtn = qs('#skyStart');
    const skyNowBtn = qs('#skyNow');
    const skyLegend = qs('#skyLegend');

    let skyHeading = 0; // 0° = sjever gore
    let skyPitch = 0;   // koristimo za “upareno prema gore”

    const STARS = [
      // Orion
      {ra:5.9195, dec:7.4071, mag:0.2, name:'Betelgeuse'},
      {ra:5.2423, dec:-8.2016, mag:0.5, name:'Rigel'},
      {ra:5.5334, dec:-0.2991, mag:0.9, name:'Alnilam'},
      {ra:5.6036, dec:-1.2019, mag:1.7, name:'Mintaka'},
      {ra:5.5856, dec:-1.9426, mag:2.2, name:'Alnitak'},
      // Veliki medvjed (dio kola)
      {ra:11.0621, dec:61.7508, mag:1.8, name:'Alioth'},
      {ra:12.2570, dec:57.0326, mag:1.9, name:'Mizar'},
      {ra:13.7923, dec:49.3133, mag:1.8, name:'Dubhe'},
      {ra:14.2610, dec:19.1825, mag:2.4, name:'Alkaid'},
      {ra:11.8972, dec:53.6948, mag:2.3, name:'Megrez'},
      {ra:12.9004, dec:55.9598, mag:2.4, name:'Phecda'}
    ];

    // Asterizmi (indeksi unutar STARS)
    const ORION_LINES = [
      ['Betelgeuse','Bellatrix'], // (Bellatrix nije u listi; pojednostavimo: vežemo po Oriovu pojasu)
      ['Alnitak','Alnilam'],
      ['Alnilam','Mintaka'],
      ['Rigel','Saiph'] // (Saiph nije u listi; pojednostavimo bez te linije)
    ];
    // Za praktičnost napravimo lookup po imenu:
    const NAME_IDX = {};
    STARS.forEach((s,i)=> NAME_IDX[s.name]=i);

    function drawSky(){
      if(!skyCtx) return;
      const w=skyCanvas.width, h=skyCanvas.height;
      skyCtx.fillStyle='#020309'; skyCtx.fillRect(0,0,w,h);

      skyCtx.strokeStyle='#1f2327'; skyCtx.strokeRect(0.5,0.5,w-1,h-1);

      skyCtx.fillStyle='#9aa6b2'; skyCtx.font='12px Montserrat';
      skyCtx.fillText('N', 6, 14); skyCtx.fillText('E', w-14, 14);
      skyCtx.fillText('S', w-14, h-6); skyCtx.fillText('W', 6, h-6);

      const cx=w/2, cy=h/2;
      const Rk=Math.min(cx,cy)-16;

      skyCtx.strokeStyle='#101317';
      skyCtx.beginPath(); skyCtx.arc(cx,cy,Rk,0,Math.PI*2); skyCtx.stroke();

      // crtamo zvijezde
      const positions = {};
      STARS.forEach(st=>{
        const az = ((st.ra*15 - skyHeading + 360*10) % 360); // vrlo pojednostavljeno
        const rad = az*Math.PI/180;
        const x = cx + Math.sin(rad)*Rk*0.92;
        const y = cy - Math.cos(rad)*Rk*0.92;
        const r = (st.mag < 1.0) ? 3.2 : (st.mag < 2.0) ? 2.6 : 2.1;
        positions[st.name] = {x,y};
        skyCtx.fillStyle='#e7e9ff';
        skyCtx.beginPath(); skyCtx.arc(x,y,r,0,Math.PI*2); skyCtx.fill();
      });

      // ako je kamera uperena prema gore (pitch <= -60°), nacrtaj linije asterizama i nazive
      const lookingUp = skyPitch <= -60;
      if(lookingUp){
        skyCtx.strokeStyle='rgba(58,160,255,.7)';
        skyCtx.lineWidth=2;
        // Orionov pojas (Alnitak-Alnilam-Mintaka)
        ['Alnitak','Alnilam','Mintaka'].reduce((prev,cur)=>{
          if(prev && positions[prev] && positions[cur]){
            skyCtx.beginPath(); skyCtx.moveTo(positions[prev].x,positions[prev].y);
            skyCtx.lineTo(positions[cur].x,positions[cur].y); skyCtx.stroke();
          }
          return cur;
        }, null);

        // Linije na Velikom Medvjedu (dio kola): Dubhe–Megrez–Phecda–Alioth–Mizar–Alkaid
        const umList=['Dubhe','Megrez','Phecda','Alioth','Mizar','Alkaid'];
        umList.reduce((prev,cur)=>{
          if(prev && positions[prev] && positions[cur]){
            skyCtx.beginPath(); skyCtx.moveTo(positions[prev].x,positions[prev].y);
            skyCtx.lineTo(positions[cur].x,positions[cur].y); skyCtx.stroke();
          }
          return cur;
        }, null);

        // nazivi zvijezda (najsjajnije)
        skyCtx.fillStyle='#8fbaff';
        skyCtx.font='11px Montserrat';
        ['Betelgeuse','Rigel','Alnilam','Mintaka','Dubhe','Alioth','Mizar','Alkaid'].forEach(n=>{
          const p=positions[n]; if(p){ skyCtx.fillText(n, p.x+6, p.y-6); }
        });
      }

      skyCtx.fillStyle='#6f7a86';
      skyCtx.fillText(lookingUp?'Orion • Veliki medvjed (linije aktivne)':'Orion • Veliki medvjed (simpl.)', 10, h-10);
    }

    function handleSky(e){
      if(typeof e.webkitCompassHeading === 'number'){
        skyHeading = normalize(e.webkitCompassHeading);
      } else if (typeof e.alpha === 'number'){
        let h = normalize(360 - e.alpha);
        h = normalize(h - screenAngle());
        skyHeading = h;
      }
      if(typeof e.beta === 'number'){ skyPitch = e.beta; } // -180..180
      drawSky();
    }

    function askSkyPermission(){
      if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission().then(r=>{
          if (r === 'granted') window.addEventListener('deviceorientation', handleSky, true);
          else alert('Bez dozvole senzora nebo se neće rotirati na iOS-u.');
        }).catch(()=>{});
      } else {
        window.addEventListener('deviceorientation', handleSky, true);
      }
    }

    qs('#skyStart')?.addEventListener('click', askSkyPermission);
    qs('#skyNow')?.addEventListener('click', ()=>{ skyHeading = 0; drawSky(); });
    drawSky(); // inicijalni crtež

    /* =========================================================
       PROGNOZA — OPEN-METEO (3 DANA)
       ========================================================= */
    const wxGrid=qs('#wxGrid'),
          wxCity=qs('#wxCity'),
          wxFetchBtn=qs('#wxFetch'),
          wxFetchManual=qs('#wxFetchManual'),
          wxLat=qs('#wxLat'),
          wxLon=qs('#wxLon');

    wxFetchBtn?.addEventListener('click', ()=>{
      if(!navigator.geolocation){ alert('Nema geolokacije'); return; }
      navigator.geolocation.getCurrentPosition(async p=>{
        const lat=p.coords.latitude, lon=p.coords.longitude;
        wxLat.value=lat.toFixed(4); wxLon.value=lon.toFixed(4);
        await fetchForecast(lat,lon);
      }, e=>alert('GPS greška: '+e.message), {enableHighAccuracy:true,timeout:10000});
    });
    wxFetchManual?.addEventListener('click', async ()=>{
      const lat=parseFloat(wxLat.value), lon=parseFloat(wxLon.value);
      if(!Number.isFinite(lat)||!Number.isFinite(lon)){ alert('Unesi koordinate'); return; }
      await fetchForecast(lat,lon);
    });

    async function fetchForecast(lat,lon){
      try{
        wxCity.textContent=`Lokacija: ${lat.toFixed(3)}, ${lon.toFixed(3)}`;
        const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,precipitation,wind_speed_10m,uv_index&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,uv_index_max,wind_speed_10m_max&current_weather=true&timezone=auto`;
        const res=await fetch(url); const data=await res.json(); renderWeather(data);
      }catch(e){ wxCity.textContent='Greška dohvaćanja prognoze'; }
    }
    function renderWeather(d){
      wxGrid.innerHTML='';
      if(!d?.daily){ wxGrid.innerHTML='<div class="wx-card">Nema podataka.</div>'; return; }
      const days=d.daily.time.length;
      for(let i=0;i<Math.min(days,3);i++){
        const el=document.createElement('div');
        el.className='wx-card';
        el.innerHTML=`<h5>${d.daily.time[i]}</h5>
          <div class="wx-meta">Tmin/Tmax: ${d.daily.temperature_2m_min[i]}° / ${d.daily.temperature_2m_max[i]}°</div>
          <div class="wx-meta">Vjetar max: ${d.daily.wind_speed_10m_max[i]} m/s</div>
          <div class="wx-meta">Oborina: ${d.daily.precipitation_sum[i]} mm</div>
          <div class="wx-meta">UV max: ${d.daily.uv_index_max[i]??'—'}</div>`;
        wxGrid.appendChild(el);
      }
    }

    /* =========================================================
       BILJKE / ŽIVOTINJE — MANUALNI ID + KAMERA
       ========================================================= */
    const bioOpen=qs('#bioOpenCam'),
          bioSnap=qs('#bioSnap'),
          bioClose=qs('#bioCloseCam'),
          bioVideo=qs('#bioVideo'),
          bioCanvas=qs('#bioCanvas'),
          bioPhoto=qs('#bioPhoto'),
          bioINat=qs('#bioINat');

    let bioStream=null;

    bioOpen?.addEventListener('click', async ()=>{
      try{
        bioStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
        bioVideo.srcObject=bioStream; bioVideo.style.display='block';
        bioSnap.disabled=false; bioClose.disabled=false; await bioVideo.play();
      }catch(e){ alert('Kamera nedostupna: '+e.message); }
    });
    bioClose?.addEventListener('click', ()=>{
      try{
        bioVideo.pause(); bioVideo.style.display='none';
        bioStream?.getTracks()?.forEach(t=>t.stop());
        bioStream=null; bioSnap.disabled=true; bioClose.disabled=true;
      }catch(e){}
    });
    bioSnap?.addEventListener('click', ()=>{
      if(!bioVideo.videoWidth) return;
      bioCanvas.width=bioVideo.videoWidth; bioCanvas.height=bioVideo.videoHeight;
      const ctx=bioCanvas.getContext('2d'); ctx.drawImage(bioVideo,0,0);
      const url=bioCanvas.toDataURL('image/jpeg',0.9);
      bioPhoto.src=url; bioPhoto.style.display='block';
    });
    bioINat?.addEventListener('click', ()=>{ window.open('https://www.inaturalist.org/observations/new','_blank'); });

    /* =========================================================
       SOS — AUDIO
       ========================================================= */
    let sosCtx=null, sosPlay=false;
    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
    function sosBeep(freq=900,dur=150){
      return new Promise(res=>{
        try{
          sosCtx=sosCtx||new (window.AudioContext||window.webkitAudioContext)();
          const t=sosCtx.currentTime;
          const osc=sosCtx.createOscillator(); const gain=sosCtx.createGain();
          osc.frequency.value=freq; osc.type='sine';
          gain.gain.value=0.0001; osc.connect(gain); gain.connect(sosCtx.destination);
          osc.start();
          gain.gain.exponentialRampToValueAtTime(0.25, t+0.02);
          gain.gain.setValueAtTime(0.25, t+dur/1000-0.03);
          gain.gain.exponentialRampToValueAtTime(0.0001, t+dur/1000);
          osc.stop(t+dur/1000+0.02);
          setTimeout(res, dur);
        }catch(e){ res(); }
      });
    }
    async function playSOS(){
      if(sosPlay) return;
      sosPlay=true;
      while(sosPlay){
        await sosBeep(900,150); await sleep(120);
        await sosBeep(900,150); await sleep(120);
        await sosBeep(900,150); await sleep(300);
        await sosBeep(900,450); await sleep(150);
        await sosBeep(900,450); await sleep(150);
        await sosBeep(900,450); await sleep(300);
        await sosBeep(900,150); await sleep(120);
        await sosBeep(900,150); await sleep(120);
        await sosBeep(900,150); await sleep(900);
      }
    }
    function stopSOS(){ sosPlay=false; }
    qs('#playSOS')?.addEventListener('click', playSOS);
    qs('#stopSOS')?.addEventListener('click', stopSOS);

    /* =========================================================
       POP-UP MINI STRELICA (placeholder tipke)
       ========================================================= */
    qs('#openPopupBtn')?.addEventListener('click', ()=> alert('Pop-up demo: možeš otvoriti drugi prozor i nacrtati mini strelicu. (Implementacija po potrebi.)'));
    qs('#closePopupBtn')?.addEventListener('click', ()=> alert('Zatvori pop-up.'));

    /* =========================================================
       VID/FOCUS — ŠTEDI BATERIJU
       ========================================================= */
    document.addEventListener('visibilitychange', ()=>{
      if(document.visibilityState==='hidden'){
        if(watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
      }
    });
  </script>
</body>
</html>
