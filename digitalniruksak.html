<!DOCTYPE html>
<html lang="hr">
<head>
  <!-- =========================================================
       META / PWA
       ========================================================= -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mountain Adventures — Digitalni ruksak</title>
  <meta name="description" content="Digitalni ruksak: laički vodiči, pejzažno snimanje, pametna strelica s GPX praćenjem (file/URL), offline savjeti, check-lista, dnevno svjetlo, SOS. Strelica: 3D level-lock, najbliža točka staze, backtrack mrvice, rezervna kazeta smjerova." />
  <link rel="icon" href="images/mountain-adventures.svg" type="image/svg+xml" />
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0e0f10" />
  <!-- iOS PWA pomoć -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="images/mountain-adventures-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- =========================================================
       STILOVI
       ========================================================= -->
  <style>
    :root {
      --bg: #0e0f10; --fg: #e9eef2; --muted: #9aa6b2; --card: #121416; --line: #1f2327;
      --accent: #2aa96b; --accent-2: #3aa0ff; --accent-3: #e44747;
      --ok: #86d486; --warn: #f2c14e; --bad: #ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:500 16px/1.55 Montserrat,system-ui,Segoe UI,Roboto,Arial,sans-serif;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility}

    header.page-head{position:sticky;top:0;z-index:10;background:linear-gradient(#14171b,#0e0f10);border-bottom:1px solid var(--line);padding:16px 18px}
    header.page-head h1{margin:0;font-size:22px;letter-spacing:.2px}
    header.page-head .intro{margin:6px 0 0;color:var(--muted);font-size:14px}

    main{max-width:1180px;margin:0 auto;padding:22px 18px 28px}
    .tools-grid{display:grid;gap:18px;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));align-items:stretch}
    .tool-card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px 16px 14px;position:relative;box-shadow:0 0 0 1px rgba(255,255,255,.02) inset,0 8px 24px rgba(0,0,0,.25)}
    .eyebrow{font-size:12px;color:var(--muted);letter-spacing:.4px;text-transform:uppercase}
    .tool-card h3{margin:6px 0 8px;font-size:19px}
    .tool-card p,.tool-card ul{color:var(--muted);font-size:14px}
    .tool-card ul{margin:8px 0 12px 20px;padding:0}
    .btn-row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:0;border-radius:12px;padding:.7em 1.05em;font-weight:700;background:var(--accent);color:#fff;cursor:pointer;text-decoration:none;display:inline-block}
    .btn.ghost{background:#2b2f36}
    .btn.alt{background:var(--accent-2)}
    .btn.alert{background:var(--accent-3)}
    .hint{color:var(--muted);font-size:12px}
    section.tool-panel{margin-top:22px;background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
    section.tool-panel h4{margin:0 0 10px;font-size:18px}
    .divider{height:1px;background:var(--line);margin:14px 0 16px}
    .two-col{display:grid;gap:14px;grid-template-columns:1fr}
    @media(min-width:800px){.two-col{grid-template-columns:.9fr 1.1fr}}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);padding:.35em .7em;border-radius:999px;font-size:12px;color:var(--muted)}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}

    /* Kamera */
    .camera-wrap{display:grid;gap:12px}
    video#camVideo{width:100%;aspect-ratio:9/16;max-height:78vh;background:#000;border-radius:12px}
    canvas#camCanvas{display:none}
    .toolbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .dot{width:12px;height:12px;border-radius:50%;background:#a33;box-shadow:0 0 6px #600}
    .dot.ok{background:#3c3;box-shadow:0 0 8px #2a2}
    #camMsg{min-width:220px;color:var(--muted)}
    #camThumb{max-width:260px;border-radius:10px;border:1px solid var(--line)}

    /* Kompas + 3D vodoravna strelica (level-lock) */
    .compass-wrap{display:grid;gap:12px}
    .compass-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .compass{width:160px;height:160px;border-radius:50%;border:1px solid var(--line);background:radial-gradient(transparent 58%,#1b1f25 59%);display:grid;place-items:center;position:relative;perspective:700px}
    .compass .tick{position:absolute;inset:8px;border-radius:50%;border:1px dashed #2a2f36}
    .arrow{width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-bottom:44px solid #2aa96b;filter:drop-shadow(0 2px 2px rgba(0,0,0,.45));transform-origin:50% 90%;transform-style:preserve-3d;transition:transform .18s ease-out,opacity .18s ease-out}
    .arrow.warn{border-bottom-color:#e09f3e}
    .arrow.bad{border-bottom-color:#e44747}
    .deg-pill{padding:.45em .7em;border-radius:999px;background:#2b2f36;color:#fff;font-weight:700;font-size:14px;border:1px solid var(--line)}
    .value{font-variant-numeric:tabular-nums}
    .compass-legend{font-size:12px;color:var(--muted)}
    .field{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type="number"],input[type="time"],input[type="file"],input[type="url"],input[type="text"]{background:#0f1114;border:1px solid var(--line);border-radius:10px;color:#fff;padding:.55em .65em;outline:none}
    input[type="number"]{width:120px}

    /* Mini strelica (HUD) */
    #miniCompass{position:fixed;left:12px;bottom:12px;z-index:9999;width:84px;height:84px;border-radius:16px;padding:8px;background:rgba(18,20,22,.9);border:1px solid var(--line);backdrop-filter:blur(6px);box-shadow:0 8px 24px rgba(0,0,0,.35);touch-action:none;user-select:none}
    #miniCompass .mini-ring{width:100%;height:56px;border-radius:999px;border:1px dashed #2a2f36;display:grid;place-items:center;position:relative;overflow:hidden}
    #miniCompass .mini-needle{width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-bottom:28px solid #2aa96b;filter:drop-shadow(0 2px 2px rgba(0,0,0,.45));transform-origin:50% 90%;transition:transform .18s ease-out,border-bottom-color .2s ease-out}
    #miniCompass .mini-needle.warn{border-bottom-color:#e09f3e}
    #miniCompass .mini-needle.bad{border-bottom-color:#e44747}
    #miniCompass .mini-info{text-align:center;font-size:12px;color:var(--muted);margin-top:4px}
    #miniCompass[hidden]{display:none}

    /* Banneri / modal (GPS loss & kazeta potvrda) */
    .banner{position:fixed;left:0;right:0;bottom:0;background:#2b2f36;border-top:1px solid var(--line);padding:10px 14px;display:flex;align-items:center;gap:10px;z-index:10000}
    .banner .msg{color:#ddd;font-size:14px}
    .banner .actions{margin-left:auto;display:flex;gap:8px}
    .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;place-items:center;z-index:10001}
    .modal{background:#161a1e;border:1px solid var(--line);border-radius:14px;padding:16px;max-width:520px;width:92%}
    .modal h5{margin:0 0 8px;font-size:18px}
    .modal p{margin:0 0 12px;color:var(--muted)}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end}
  </style>
</head>

<body>
  <!-- =========================================================
       HEADER
       ========================================================= -->
  <header class="page-head">
    <h1>Digitalni ruksak</h1>
    <p class="intro">Jasni vodiči, kamera, pametna strelica s GPX-om (offline), backtrack mrvice, dnevno svjetlo i SOS.</p>
  </header>

  <!-- =========================================================
       MAIN
       ========================================================= -->
  <main>
    <section class="tools-grid" aria-label="Alati">
      <!-- 1) DIGITALNA POMOĆ -->
      <article class="tool-card" id="tool-aid">
        <div class="eyebrow">Prioritet</div>
        <h3>Digitalna pomoć (jasni, laički vodiči)</h3>
        <p>Brzi postupci koje svatko može slijediti. Prvo sigurnost mjesta, zatim 112.</p>
        <div class="btn-row">
          <button class="btn alt" id="openAidPanel">Otvori vodiče</button>
          <span class="chip">⛰️ Podsjetnici pri ruci</span>
        </div>
      </article>

      <!-- 2) KAMERA -->
      <article class="tool-card" id="tool-camera">
        <div class="eyebrow">Foto</div>
        <h3>Pejzažno snimanje uživo</h3>
        <p>Stabilan kadar → blago pojačanje kontrasta/boje/oštrine → snimka (offline).</p>
        <ul>
          <li>Auto-stabilnost (snima kad se umiri)</li>
          <li>Radi na HTTPS/localhost</li>
          <li>Bez slanja na server</li>
        </ul>
        <div class="btn-row">
          <button class="btn" id="openCamPanel">Otvori alat</button>
          <a class="btn ghost" href="tools/camera-auto-enhance.html">U novoj kartici</a>
        </div>
        <p class="hint">Privatnost: slika ostaje u tvom pregledniku.</p>
      </article>

      <!-- 3) PAMETNA STRELICA -->
      <article class="tool-card" id="tool-arrow">
        <div class="eyebrow">Orijentacija</div>
        <h3>Pametna strelica (kompas) — GPX praćenje</h3>
        <p>Učitaj GPX (file ili URL). Strelica je <b>3D level-lock</b> i <b>cilja točno najbližu točku staze</b>. Žuta/crvena upozorenja + beep.</p>
        <div class="btn-row">
          <button class="btn" id="openArrowPanel">Otvori alat</button>
        </div>
        <p class="hint">iOS traži “Motion & Orientation” dopuštenje; radi na HTTPS-u.</p>
      </article>

      <!-- 4) OFFLINE SAVJETI -->
      <article class="tool-card" id="tool-offline">
        <div class="eyebrow">Navigacija</div>
        <h3>Offline karte & GPX</h3>
        <p>Preuzmi regiju u OSMand/Organic Maps; GPX spremi lokalno.</p>
        <div class="btn-row">
          <button class="btn ghost" id="openOfflinePanel">Brzi savjeti</button>
        </div>
      </article>

      <!-- 5) DNEVNIK -->
      <article class="tool-card" id="tool-log">
        <div class="eyebrow">Sigurnost</div>
        <h3>Planinarski dnevnik</h3>
        <p>Zapiši rutu, vrijeme polaska i smjer kretanja (za slučaj potrebe).</p>
        <div class="btn-row">
          <button class="btn ghost" id="openLogPanel">Otvori dnevnik</button>
        </div>
      </article>

      <!-- 6) CHECK-LISTA -->
      <article class="tool-card" id="tool-check">
        <div class="eyebrow">Priprema</div>
        <h3>Check-lista prije polaska</h3>
        <p>Voda, slojevi, prva pomoć, svjetlo, GPX, baterija…</p>
        <div class="btn-row">
          <button class="btn ghost" id="openChecklistPanel">Otvori listu</button>
        </div>
      </article>

      <!-- 7) DNEVNO SVJETLO -->
      <article class="tool-card" id="tool-light">
        <div class="eyebrow">Vrijeme</div>
        <h3>Dnevno svjetlo</h3>
        <p>Odaberi zalazak ili auto-lokalno i prati koliko je svjetla preostalo.</p>
        <div class="btn-row">
          <button class="btn ghost" id="openSunPanel">Tajmer svjetla</button>
        </div>
      </article>

      <!-- 8) SOS -->
      <article class="tool-card" id="tool-sos">
        <div class="eyebrow">SOS</div>
        <h3>SOS zviždaljka</h3>
        <p>Glasan ton (••• — — — •••). 112 je prioritet.</p>
        <div class="btn-row">
          <button class="btn alert" id="playSOS">Pokreni SOS</button>
          <button class="btn ghost" id="stopSOS">Zaustavi</button>
        </div>
      </article>
    </section>

    <!-- =========================================================
         PANELI
         ========================================================= -->

    <!-- PANEL: Digitalna pomoć -->
    <section id="panelAid" class="tool-panel" hidden>
      <h4>Digitalna pomoć — laički vodiči (brzo i jasno)</h4>
      <div class="two-col">
        <div>
          <div class="chip">ℹ️ Podsjetnik — ne zamjenjuje tečaj prve pomoći</div>
          <div class="divider"></div>
          <div class="aid-accordion" id="aidAcc">
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">🚑 KPR (odrasli) — “guraš prsa”</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li><b>Najprije:</b> sigurno mjesto, pozovi <b>112</b>.</li>
                  <li><b>Ne diše normalno?</b> Kreni s KPR: dlan na sredinu prsnog koša, drugi dlan preko, laktovi ravno.</li>
                  <li><b>Ritam:</b> 100–120/min; <b>dubina 5–6 cm</b>. Pusti da se prsa vrate gore.</li>
                  <li>Omjer <b>30:2</b> samo ako znaš i imaš masku — inače samo pritisci.</li>
                </ul>
              </div>
            </div>
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">🩸 Jako krvarenje — “stisni i drži”</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li><b>Stisni direktno</b> na mjesto krvarenja 10 min bez provjeravanja.</li>
                  <li>Ako promoči, <b>dodaj</b> preko (ne skidaj prvu gazu).</li>
                  <li>Za udove: kompresivni zavoj ili turniket (zabilježi vrijeme).</li>
                </ul>
              </div>
            </div>
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">🧊 Hladnoća (hipotermija)</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li>Makni od vjetra i vlage; suho i toplo slojevito.</li>
                  <li>Astrofolija: srebrna strana <b>prema tijelu</b> grije (zlatna vani).</li>
                </ul>
              </div>
            </div>
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">🦴 Uganuće / prijelom</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li>Imobiliziraj kako jest; hladni oblog (ne direktno) 10–15 min.</li>
                </ul>
              </div>
            </div>
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">📢 112 — što reći</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li>Lokacija (koordinate / oznaka staze), što se dogodilo, broj osoba, stanje, pristup.</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="divider"></div>
          <div class="hint">Ovo su sažeti podsjetnici. Pohađanje tečaja prve pomoći je preporučeno.</div>
        </div>
        <div>
          <h4 style="margin-top:0">Brzi podsjetnici</h4>
          <ul>
            <li>Astrofolija: <b>srebrna prema tijelu</b> grije.</li>
            <li>KPR: <b>30:2</b> (ako znaš), 100–120/min; 5–6 cm。</li>
            <li>Krvarenje: <b>stisni 10 min</b>; dodaj preko.</li>
          </ul>
          <div class="chip" style="margin-top:10px">📞 112 — hitna pomoć i spašavanje</div>
        </div>
      </div>
    </section>

    <!-- PANEL: Kamera -->
    <section id="panelCamera" class="tool-panel" hidden>
      <h4>Pejzažno snimanje uživo (ugrađeno)</h4>
      <div class="camera-wrap">
        <video id="camVideo" autoplay playsinline></video>
        <canvas id="camCanvas"></canvas>
        <div class="toolbar">
          <div id="camDot" class="dot" title="Pokazatelj mirnoće"></div>
          <div id="camMsg">Tražim stabilnost…</div>
          <button id="camManual" class="btn ghost">Snimi sada</button>
          <button id="camAuto" class="btn">Auto snimanje: ON</button>
          <button id="camClose" class="btn ghost">Zatvori</button>
        </div>
        <div class="result">
          <img id="camThumb" alt="Pregled snimljene fotografije" />
          <div class="hint">Radi samo na HTTPS/localhost. Slika ostaje lokalno dok je ne preuzmeš.</div>
        </div>
      </div>
    </section>

    <!-- PANEL: Pametna strelica -->
    <section id="panelArrow" class="tool-panel" hidden>
      <h4>Pametna strelica — kompas + GPX (file/URL)</h4>
      <div class="compass-wrap">
        <div class="compass-row">
          <div class="compass" aria-label="Kompas">
            <div class="tick"></div>
            <div id="arrowNeedle" class="arrow" style="transform: rotateZ(0deg);"></div>
          </div>
          <div>
            <div class="deg-pill">Tvoj yaw: <span id="valueHeading" class="value">—</span>°</div>
            <div class="deg-pill" style="margin-top:8px">Ciljni yaw: <span id="valueTarget" class="value">0</span>°</div>
            <div class="deg-pill" style="margin-top:8px">Okreni još: <span id="valueDelta" class="value">—</span>°</div>
            <div class="compass-legend" id="deltaHint" style="margin-top:6px"><span class="ok">Poravnato ✓</span></div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="compass-row">
          <div class="field">
            <label for="gpxInput">GPX file:</label>
            <input id="gpxInput" type="file" accept=".gpx,application/gpx+xml" />
            <button class="btn ghost" id="loadGpxBtn">Učitaj</button>
          </div>
          <div class="field">
            <label for="gpxUrl">GPX URL:</label>
            <input id="gpxUrl" type="url" placeholder="https://…/ruta.gpx" style="width:260px" />
            <button class="btn ghost" id="loadUrlBtn">Učitaj URL</button>
          </div>
          <div class="field">
            <label for="alertMeters">Prag (m) zvuka:</label>
            <input id="alertMeters" type="number" min="5" step="5" value="30" />
            <button class="btn" id="toggleTrackBtn">Pokreni praćenje</button>
          </div>
        </div>

        <div class="status-line" style="margin-top:6px">
          <span class="deg-pill" id="trackStatusPill">GPX: —</span>
          <span class="chip" id="onTrackChip">🧭 status: —</span>
          <span class="chip" id="offDistChip">↔︎ udaljenost: —</span>
        </div>

        <div class="divider"></div>

        <!-- Backtrack (mrvice) -->
        <div class="compass-row">
          <div class="btn-row">
            <button class="btn ghost" id="btStart">Započni povratak</button>
            <button class="btn ghost" id="btStop">Zaustavi povratak</button>
          </div>
          <span class="chip" id="btStatus">↩︎ Povratak: isključen</span>
        </div>

        <p class="hint" style="margin-top:6px">Možeš i dodati parametar u URL: <code>?gpx=https://…/ruta.gpx</code></p>

        <div><button class="btn" id="arrowClose">Zatvori</button></div>
      </div>
    </section>

    <!-- PANEL: Offline savjeti -->
    <section id="panelOffline" class="tool-panel" hidden>
      <h4>Offline savjeti (kratko)</h4>
      <ul>
        <li>Preuzmi <b>offline kartu</b> (OSMand/Organic Maps) i GPX rute.</li>
        <li>Uključi <b>zrakoplovni način</b> + GPS (štedi bateriju; GPS radi i offline).</li>
        <li>Ponesi <b>power bank</b>; čuvaj toplinu baterije zimi.</li>
        <li>Provjeri <b>vrijeme</b> i zalazak sunca prije polaska.</li>
      </ul>
    </section>

    <!-- PANEL: Dnevnik -->
    <section id="panelLog" class="tool-panel" hidden>
      <h4>Planinarski dnevnik</h4>
      <div class="two-col">
        <div>
          <div class="field"><input id="logRoute" type="text" placeholder="Ruta / planina" style="width:100%"></div>
          <div class="field"><input id="logStart" type="time"> <input id="logPeople" type="number" min="1" value="1" style="width:100px"> osoba</div>
          <div class="field"><input id="logNote" type="text" placeholder="Smjer, plan B, napomena" style="width:100%"></div>
          <div class="btn-row"><button class="btn" id="logSave">Spremi lokalno</button> <button class="btn ghost" id="logClear">Obriši</button></div>
          <div class="hint">Podaci ostaju lokalno u pregledniku (LocalStorage).</div>
        </div>
        <div>
          <h4 style="margin-top:0">Tvoja zadnja prijava</h4>
          <pre id="logView" style="background:#0f1114;border:1px solid var(--line);border-radius:10px;padding:10px;white-space:pre-wrap;min-height:88px"></pre>
        </div>
      </div>
    </section>

    <!-- PANEL: Check-lista -->
    <section id="panelChecklist" class="tool-panel" hidden>
      <h4>Check-lista prije polaska</h4>
      <ul id="checkList">
        <li><label><input type="checkbox"> Voda + hrana</label></li>
        <li><label><input type="checkbox"> Slojevita odjeća / kišna zaštita</label></li>
        <li><label><input type="checkbox"> Prva pomoć + astrofolija</label></li>
        <li><label><input type="checkbox"> Svjetlo + baterije</label></li>
        <li><label><input type="checkbox"> GPX ruta + offline karta</label></li>
        <li><label><input type="checkbox"> Napunjena baterija / power bank</label></li>
      </ul>
      <div class="btn-row"><button class="btn ghost" id="checkReset">Resetiraj</button></div>
    </section>

    <!-- PANEL: Dnevno svjetlo -->
    <section id="panelSun" class="tool-panel" hidden>
      <h4>Dnevno svjetlo — jednostavni tajmer</h4>
      <div class="two-col">
        <div>
          <div class="field"><label for="sunsetTime">Zalazak:</label> <input id="sunsetTime" type="time"></div>
          <div class="btn-row"><button class="btn" id="sunStart">Pokreni</button> <button class="btn ghost" id="sunStop">Zaustavi</button></div>
          <div class="hint">Opcija: dopusti lokaciju pa ću pokušati auto-postaviti zalazak (grubo).</div>
        </div>
        <div><div class="deg-pill" id="sunLeft">Preostalo: —</div></div>
      </div>
    </section>
  </main>

  <!-- MINI STRELICA WIDGET (HUD) -->
  <div id="miniCompass" aria-label="Mini strelica" hidden>
    <div class="mini-ring"><div id="miniNeedle" class="mini-needle"></div></div>
    <div class="mini-info"><span id="miniMeters">— m</span></div>
  </div>

  <!-- BANNER: GPS lost -->
  <div id="gpsBanner" class="banner" style="display:none">
    <div class="msg">📡 Nema GPS signala — čekam fix. Navigacija ograničena.</div>
    <div class="actions">
      <button class="btn ghost" id="bannerHide">Sakrij</button>
    </div>
  </div>

  <!-- MODAL: Rezervna “kazeta smjerova” potvrda (samo krajnja nužda) -->
  <div id="tapeModalBack" class="modal-back">
    <div class="modal">
      <h5>Rezervni način — bez GPS-a</h5>
      <p>Ovo je <b>orijentacijski</b> povratak koristeći ranije snimljene smjerove (bez udaljenosti). Koristi samo u krajnjoj nuždi dok se GPS ne vrati.</p>
      <div class="actions">
        <button class="btn ghost" id="tapeCancel">Odustani</button>
        <button class="btn alert" id="tapeConfirm">Uključi privremeno</button>
      </div>
    </div>
  </div>

  <!-- =========================================================
       SCRIPT
       ========================================================= -->
  <script>
    /* ---------------------------------
       PWA: service worker (offline)
       --------------------------------- */
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(()=>{});
    }

    /* ---------------------------------
       Helperi i otvaranje panela
       --------------------------------- */
    const qs = s => document.querySelector(s);
    const show = el => { el.hidden = false; el.scrollIntoView({ behavior: 'smooth', block: 'start' }); };
    const hide = el => { el.hidden = true; };

    const panelAid = qs('#panelAid');
    const panelCamera = qs('#panelCamera');
    const panelArrow = qs('#panelArrow');
    const panelOffline = qs('#panelOffline');
    const panelLog = qs('#panelLog');
    const panelChecklist = qs('#panelChecklist');
    const panelSun = qs('#panelSun');

    qs('#openAidPanel')?.addEventListener('click', () => show(panelAid));
    qs('#openCamPanel')?.addEventListener('click', async () => { show(panelCamera); await startCam(); });
    qs('#openArrowPanel')?.addEventListener('click', () => { show(panelArrow); openArrow(); });
    qs('#openOfflinePanel')?.addEventListener('click', () => show(panelOffline));
    qs('#openLogPanel')?.addEventListener('click', () => show(panelLog));
    qs('#openChecklistPanel')?.addEventListener('click', () => show(panelChecklist));
    qs('#openSunPanel')?.addEventListener('click', () => show(panelSun));

    /* ---------------------------------
       Akordeon (Digitalna pomoć)
       --------------------------------- */
    (function () {
      const acc = qs('#aidAcc'); if (!acc) return;
      acc.querySelectorAll('.aid-head').forEach(btn => {
        btn.addEventListener('click', () => {
          const body = btn.parentElement.querySelector('.aid-body');
          const open = btn.classList.toggle('open');
          body.style.display = open ? 'block' : 'none';
        });
      });
    })();

    /* ---------------------------------
       Kamera — auto-pejzaž
       --------------------------------- */
    const camClose = qs('#camClose'), camVideo = qs('#camVideo'),
          camCanvas = qs('#camCanvas'), camCtx = camCanvas?.getContext?.('2d', { willReadFrequently: true }),
          camDot = qs('#camDot'), camMsg = qs('#camMsg'), camThumb = qs('#camThumb'),
          camManual = qs('#camManual'), camAutoBtn = qs('#camAuto');

    const STABILITY_FRAMES = 8, DIFF_THRESHOLD = 6, CAPTURE_WIDTH = 2048;
    let camAutoMode = true, camPrev = null, camSteady = 0, camLastAuto = 0, camLoopOn = false;

    camClose?.addEventListener('click', stopCam);
    camAutoBtn?.addEventListener('click', () => {
      camAutoMode = !camAutoMode; camAutoBtn.textContent = camAutoMode ? 'Auto snimanje: ON' : 'Auto snimanje: OFF';
    });
    camManual?.addEventListener('click', captureCam);

    async function startCam(){
      if (camLoopOn) return;
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
        camVideo.srcObject = stream; await camVideo.play();
        camCanvas.width = Math.min(1280, camVideo.videoWidth || 1280);
        camCanvas.height = Math.min(720, camVideo.videoHeight || 720);
        camLoopOn = true; requestAnimationFrame(camLoop);
      }catch(e){ camMsg.textContent = 'Greška s kamerom: ' + e.message; }
    }
    function stopCam(){ hide(panelCamera); camLoopOn = false; try{ camVideo.pause(); camVideo.srcObject?.getTracks?.().forEach(t => t.stop()); camVideo.srcObject = null; }catch(e){} }
    function lumaAt(d,i){ return 0.2126*d[i]+0.7152*d[i+1]+0.0722*d[i+2]; }
    function frameDiff(a,b){ const da=a.data, db=b.data; let s=0, n=da.length/4; for(let p=0,i=0;p<n;p++,i+=4){ s+=Math.abs(lumaAt(da,i)-lumaAt(db,i)); } return s/n; }
    function autoContrast(img){ const d=img.data, n=d.length/4; let lo=255, hi=0; for(let i=0;i<n;i++){ const idx=i*4, L=lumaAt(d,idx); if(L<lo) lo=L; if(L>hi) hi=L; } const range=Math.max(1,hi-lo), scale=255/range;
      for(let i=0;i<n;i++){ const idx=i*4; d[idx]=Math.min(255,Math.max(0,(d[idx]-lo)*scale)); d[idx+1]=Math.min(255,Math.max(0,(d[idx+1]-lo)*scale)); d[idx+2]=Math.min(255,Math.max(0,(d[idx+2]-lo)*scale)); } return img; }
    function unsharp(img, amount=.6, radius=1){ const w=img.width,h=img.height,s=img.data,out=new Uint8ClampedArray(s.length);
      for(let y=0;y<h;y++){ for(let x=0;x<w;x++){ let r=0,g=0,b=0,c=0;
        for(let oy=-radius;oy<=radius;oy++){ const yy=Math.min(h-1,Math.max(0,y+oy));
          for(let ox=-radius;ox<=radius;ox++){ const xx=Math.min(w-1,Math.max(0,x+ox)), i=(yy*w+xx)*4; r+=s[i]; g+=s[i+1]; b+=s[i+2]; c++; } }
        const i=(y*w+x)*4, br=r/c, bg=g/c, bb=b/c;
        out[i]=Math.min(255,Math.max(0,s[i]+amount*(s[i]-br))); out[i+1]=Math.min(255,Math.max(0,s[i+1]+amount*(s[i+1]-bg))); out[i+2]=Math.min(255,Math.max(0,s[i+2]+amount*(s[i+2]-bb))); out[i+3]=s[i+3];
      } } img.data.set(out); return img; }
    async function camLoop(){ if(!camLoopOn) return;
      if(camVideo.readyState>=2){ camCtx.drawImage(camVideo,0,0,camCanvas.width,camCanvas.height); const cur=camCtx.getImageData(0,0,camCanvas.width,camCanvas.height);
        if(camPrev){ const diff=frameDiff(cur,camPrev);
          if(diff<DIFF_THRESHOLD){ camSteady++; camDot.classList.add('ok'); camMsg.textContent=`Mirno — ${camSteady}/${STABILITY_FRAMES}`; }
          else{ camSteady=0; camDot.classList.remove('ok'); camMsg.textContent=`Nemirno (${Math.round(diff)}), drži mirnije`; }
          if(camSteady>=STABILITY_FRAMES && camAutoMode){ const now=Date.now(); if(now-camLastAuto>3000){ camLastAuto=now; await captureCam(); } camSteady=0; }
        } camPrev=cur; }
      requestAnimationFrame(camLoop);
    }
    async function captureCam(){
      camMsg.textContent='Snimam i obrađujem…';
      try{
        const track = camVideo.srcObject?.getVideoTracks?.[0];
        if(track && window.ImageCapture){ const ic=new ImageCapture(track);
          if(ic.takePhoto){ const blob=await ic.takePhoto(); const bmp=await createImageBitmap(blob); const r=bmp.width/bmp.height;
            const W=Math.min(CAPTURE_WIDTH,bmp.width), H=Math.round(W/r); camCanvas.width=W; camCanvas.height=H;
            camCtx.drawImage(bmp,0,0,W,H); camCtx.filter='contrast(1.06) saturate(1.08)'; camCtx.drawImage(camCanvas,0,0); camCtx.filter='none';
            let id=camCtx.getImageData(0,0,W,H); id=autoContrast(id); id=unsharp(id,.6,1); camCtx.putImageData(id,0,0);
            const url=camCanvas.toDataURL('image/jpeg',0.92); camThumb.src=url; camMsg.innerHTML='Gotovo (ImageCapture). <a style="margin-left:10px" download="mountain-adventures-photo.jpg" href="'+url+'">Preuzmi</a>'; return; }
        } }catch(e){}
      const r=(camVideo.videoWidth||1080)/(camVideo.videoHeight||1920);
      const W=Math.min(CAPTURE_WIDTH,camVideo.videoWidth||1280), H=Math.round(W/r);
      camCanvas.width=W; camCanvas.height=H; camCtx.drawImage(camVideo,0,0,W,H);
      camCtx.filter='contrast(1.06) saturate(1.08)'; camCtx.drawImage(camCanvas,0,0); camCtx.filter='none';
      let id=camCtx.getImageData(0,0,W,H); id=autoContrast(id); id=unsharp(id,.6,1); camCtx.putImageData(id,0,0);
      const url=camCanvas.toDataURL('image/jpeg',0.92); camThumb.src=url; camMsg.innerHTML='Gotovo. <a style="margin-left:10px" download="mountain-adventures-photo.jpg" href="'+url+'">Preuzmi</a>';
    }

    /* ---------------------------------
       Strelica + GPX + Backtrack + Rezervna kazeta
       --------------------------------- */
    // UI refs
    const arrowClose = qs('#arrowClose'), arrowNeedle = qs('#arrowNeedle'),
          valueHeading = qs('#valueHeading'), valueTarget = qs('#valueTarget'),
          valueDelta = qs('#valueDelta'), deltaHint = qs('#deltaHint'),
          gpxInput = qs('#gpxInput'), loadGpxBtn = qs('#loadGpxBtn'),
          gpxUrl = qs('#gpxUrl'), loadUrlBtn = qs('#loadUrlBtn'),
          alertMetersInput = qs('#alertMeters'), toggleTrackBtn = qs('#toggleTrackBtn'),
          trackStatusPill = qs('#trackStatusPill'), onTrackChip = qs('#onTrackChip'), offDistChip = qs('#offDistChip');

    const mini = qs('#miniCompass'), miniNeedle = qs('#miniNeedle'), miniMeters = qs('#miniMeters');

    const btStart = qs('#btStart'), btStop = qs('#btStop'), btStatus = qs('#btStatus');

    const gpsBanner = qs('#gpsBanner'), bannerHide = qs('#bannerHide');
    const tapeModalBack = qs('#tapeModalBack'), tapeConfirm = qs('#tapeConfirm'), tapeCancel = qs('#tapeCancel');

    // Stanje
    const EARTH_R = 6371000;
    const RAD = Math.PI/180, DEG = 180/Math.PI;

    let deviceHeading = null;        // 2D fallback (stari heading)
    let lastMatrix = null;           // 3x3 world->device orijentacija
    let useAOS = false;
    let gpxTrack = null;             // [{lat,lon}]
    let watchId = null;
    let alertMeters = 30;

    // Level-lock kut
    let lastAngleDeg = null;
    const SMOOTHING = 0.18;

    // Offtrack pragovi
    const OK_THRESHOLD_M = 5;        // “na tragu”
    const YELLOW_MAX_M = 10;         // žuta zona do 10 m

    // Beep kontrola
    let audioCtx = null, offBeepArmed = false;

    // Zadnja poznata pozicija
    let lastKnownLat = null, lastKnownLon = null;

    // Backtrack (mrvice) — 10 m ILI 30 s
    let breadcrumbs = [];            // [{lat,lon,t,acc}]
    let lastCrumb = null;
    let backtrackOn = false;
    let backIdx = null;
    const CRUMB_MIN_DIST = 10;
    const CRUMB_MAX_ACC  = 35;
    const CRUMB_MIN_INTERVAL_MS = 30000;
    const AUTO_ADVANCE_RADIUS = 8;

    // Rezervna “kazeta smjerova” (skriveno; samo nužda)
    let headingTape = [];            // [{t, yawWorldDeg, speed}]
    let hbOn = false;
    let hbIdx = null;
    const HEADING_SAMPLE_MS = 1000;
    let lastHeadingSampleAt = 0;
    let gpsLostSince = null;         // ms timestamp kad je GPS pao
    const GPS_LOST_MODAL_AFTER_MS = 120000; // 2 min bez fixa → pitaj za kazetu
    let tapeTick = null;

    // Helperi
    const toRad = x => x*RAD;
    const mulMatVec = (M,v)=>[ M[0][0]*v[0]+M[0][1]*v[1]+M[0][2]*v[2],
                               M[1][0]*v[0]+M[1][1]*v[1]+M[1][2]*v[2],
                               M[2][0]*v[0]+M[2][1]*v[1]+M[2][2]*v[2] ];
    const transpose3 = M => [[M[0][0],M[1][0],M[2][0]],[M[0][1],M[1][1],M[2][1]],[M[0][2],M[1][2],M[2][2]]];
    const dot3 = (a,b)=>a[0]*b[0]+a[1]*b[1]+a[2]*b[2];
    const norm3 = ([x,y,z]) => { const L = Math.hypot(x,y,z)||1e-9; return [x/L,y/L,z/L]; };

    function eulerToMatrix(alpha, beta, gamma){
      const z = alpha*RAD, x = beta*RAD, y = gamma*RAD;
      const cZ=Math.cos(z), sZ=Math.sin(z);
      const cX=Math.cos(x), sX=Math.sin(x);
      const cY=Math.cos(y), sY=Math.sin(y);
      return [
        [ cZ*cY - sZ*sX*sY,   -cX*sZ,           cY*sZ*sX + cZ*sY ],
        [ cY*sZ + cZ*sX*sY,    cZ*cX,           sZ*sY - cZ*cY*sX ],
        [ -cX*sY,              sX,              cX*cY            ]
      ];
    }
    function quatToMatrix(x, y, z, w){
      const xx=x*x, yy=y*y, zz=z*z;
      const xy=x*y, xz=x*z, yz=y*z;
      const wx=w*x, wy=w*y, wz=w*z;
      return [
        [1-2*(yy+zz), 2*(xy-wz),   2*(xz+wy)],
        [2*(xy+wz),   1-2*(xx+zz), 2*(yz-wx)],
        [2*(xz-wy),   2*(yz+wx),   1-2*(xx+yy)]
      ];
    }

    function enuVector(lat,lon,lat2,lon2){
      const φ1=lat*RAD, φ2=lat2*RAD, dλ=(lon2-lon)*RAD;
      return [ EARTH_R * dλ * Math.cos((φ1+φ2)/2), EARTH_R * (φ2-φ1), 0 ];
    }
    function bearingBetween(lat1,lon1,lat2,lon2){
      const φ1=toRad(lat1), φ2=toRad(lat2), Δλ=toRad(lon2-lon1);
      const y=Math.sin(Δλ)*Math.cos(φ2), x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
      return ((Math.atan2(y,x)*DEG)+360)%360;
    }
    function haversine(lat1,lon1,lat2,lon2){
      const dφ=toRad(lat2-lat1), dλ=toRad(lon2-lon1);
      const a=Math.sin(dφ/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dλ/2)**2;
      return 2*EARTH_R*Math.asin(Math.sqrt(a));
    }
    function nearestPointOnTrack(p,track){
      let best={lat:track[0].lat,lon:track[0].lon,distM:Infinity,segIndex:0};
      const lat0=p.lat, P=toXY(p.lat,p.lon,lat0);
      for(let i=0;i<track.length-1;i++){
        const A=toXY(track[i].lat,track[i].lon,lat0), B=toXY(track[i+1].lat,track[i+1].lon,lat0);
        const ABx=B.x-A.x, ABy=B.y-A.y, APx=P.x-A.x, APy=P.y-A.y;
        const ab2=ABx*ABx + ABy*ABy || 1; let t=(APx*ABx + APy*ABy)/ab2; t=Math.max(0,Math.min(1,t));
        const Qx=A.x+t*ABx, Qy=A.y+t*ABy;
        const lon=(Qx/(EARTH_R*Math.cos(toRad(lat0))))*(180/Math.PI), lat=(Qy/EARTH_R)*(180/Math.PI);
        const d=haversine(p.lat,p.lon,lat,lon);
        if(d<best.distM) best={lat,lon,distM:d,segIndex:i};
      } return best;
    }
    function toXY(lat,lon,lat0){ const x=toRad(lon)*Math.cos(toRad(lat0))*EARTH_R, y=toRad(lat)*EARTH_R; return {x,y}; }

    function angularDelta(current,target){ return ((target-current+540)%360)-180; }

    function beepOnce(freq=1000,durMs=250){
      try{
        audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
        const t=audioCtx.currentTime, osc=audioCtx.createOscillator(), g=audioCtx.createGain();
        osc.frequency.value=freq; osc.type='sine'; g.gain.value=0.0001; osc.connect(g); g.connect(audioCtx.destination);
        osc.start(); g.gain.exponentialRampToValueAtTime(0.2, t+0.02);
        g.gain.setValueAtTime(0.2, t+durMs/1000-0.04); g.gain.exponentialRampToValueAtTime(0.0001, t+durMs/1000);
        osc.stop(t+durMs/1000+0.01);
      }catch(e){}
    }

    function setArrowColor(mode){
      arrowNeedle.classList.remove('warn','bad');
      if(mode==='ok'){ arrowNeedle.style.borderBottomColor='#2aa96b'; }
      else if(mode==='warn'){ arrowNeedle.classList.add('warn'); }
      else if(mode==='bad'){ arrowNeedle.classList.add('bad'); }
    }
    function showMini(){ if(mini) mini.hidden=false; }
    function hideMini(){ if(mini) mini.hidden=true; }
    function setMiniColor(mode){
      miniNeedle.classList.remove('warn','bad');
      if(mode==='ok') miniNeedle.style.borderBottomColor='#2aa96b';
      else if(mode==='warn') miniNeedle.classList.add('warn');
      else if(mode==='bad') miniNeedle.classList.add('bad');
    }

    // Breadcrumbs (mrvice)
    function loadCrumbs(){ try{ breadcrumbs = JSON.parse(localStorage.getItem('ma_crumbs')||'[]') || []; }catch{ breadcrumbs = []; } }
    function saveCrumbs(){ try{ localStorage.setItem('ma_crumbs', JSON.stringify(breadcrumbs)); }catch{} }
    function pushCrumb(lat,lon,acc){ const c = { lat, lon, t: Date.now(), acc: acc ?? null }; breadcrumbs.push(c); lastCrumb = c; if (breadcrumbs.length>2000) breadcrumbs.shift(); saveCrumbs(); }
    function maybeAddCrumb(lat, lon, acc){
      if (!Number.isFinite(lat) || !Number.isFinite(lon)) return;
      if (acc!=null && acc > CRUMB_MAX_ACC) return;
      const now = Date.now();
      if (!lastCrumb){ pushCrumb(lat,lon,acc); return; }
      const dist = haversine(lastCrumb.lat, lastCrumb.lon, lat, lon);
      const dt = now - (lastCrumb.t || 0);
      if (dist >= CRUMB_MIN_DIST || dt >= CRUMB_MIN_INTERVAL_MS) pushCrumb(lat,lon,acc);
    }
    loadCrumbs(); if (breadcrumbs.length) lastCrumb = breadcrumbs[breadcrumbs.length-1];

    // Rezervna kazeta
    function deviceWorldYawDeg(){
      if (!lastMatrix) return deviceHeading ?? 0;
      const M = transpose3(lastMatrix); // device->world
      const fw = mulMatVec(M, [0,0,-1]); // forward u svijetu
      const L = Math.hypot(fw[0], fw[1]) || 1e-9;
      return (Math.atan2(fw[0]/L, fw[1]/L) * DEG + 360) % 360; // atan2(E,N)
    }

    /* --------------- Otvaranje strelice i senzori --------------- */
    function openArrow(){
      // AbsoluteOrientationSensor
      try{
        if('AbsoluteOrientationSensor' in window){
          const aos = new AbsoluteOrientationSensor({ frequency: 30, referenceFrame: 'device' });
          aos.addEventListener('reading', () => {
            const [qx,qy,qz,qw] = aos.quaternion;
            lastMatrix = quatToMatrix(qx,qy,qz,qw);
            const yaw = deviceWorldYawDeg();
            valueHeading.textContent = yaw.toFixed(0);
          });
          aos.start(); useAOS = true;
        }
      }catch(e){ useAOS = false; }
      // Fallback: DeviceOrientation
      if(!useAOS){
        if(typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function'){
          const btn = document.createElement('button');
          btn.textContent = 'Omogući kompas (iOS)';
          btn.className = 'btn ghost';
          panelArrow.querySelector('.compass-wrap').appendChild(btn);
          btn.addEventListener('click', async ()=>{
            try{
              const state = await DeviceOrientationEvent.requestPermission();
              if(state==='granted'){ window.addEventListener('deviceorientation', onOrient3D, true); btn.remove(); }
            }catch(e){ btn.remove(); }
          }, { once:true });
        } else {
          window.addEventListener('deviceorientation', onOrient3D, true);
        }
      }
      // auto-učitaj GPX iz ?gpx=
      const urlParam = new URL(location.href).searchParams.get('gpx');
      if(urlParam) { loadGpxFromUrl(urlParam); }
    }
    function onOrient3D(e){
      if(e.alpha==null || e.beta==null || e.gamma==null) return;
      lastMatrix = eulerToMatrix(e.alpha, e.beta, e.gamma);
      const yaw = deviceWorldYawDeg();
      valueHeading.textContent = Number.isFinite(yaw) ? yaw.toFixed(0) : '—';
    }

    /* --------------- GPX učitavanje --------------- */
    loadGpxBtn?.addEventListener('click', async ()=>{
      const f = gpxInput?.files?.[0];
      if(!f){ trackStatusPill.textContent='GPX: nema datoteke'; return; }
      try{
        const txt = await f.text();
        gpxTrack = parseGpxToTrack(txt);
        afterGpxLoaded(`GPX (file): ${gpxTrack.length} točaka`);
      }catch(e){ trackStatusPill.textContent='GPX: greška pri učitavanju'; console.error(e); }
    });
    loadUrlBtn?.addEventListener('click', async ()=>{
      const url = gpxUrl.value.trim(); if(!url){ trackStatusPill.textContent='GPX URL: prazno'; return; }
      await loadGpxFromUrl(url);
    });
    async function loadGpxFromUrl(url){
      try{
        const res = await fetch(url, { mode:'cors' });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const txt = await res.text();
        gpxTrack = parseGpxToTrack(txt);
        afterGpxLoaded(`GPX (URL): ${gpxTrack.length} točaka`);
      }catch(e){
        trackStatusPill.textContent='GPX URL: ne mogu učitati (CORS?)';
        console.error(e);
      }
    }
    function parseGpxToTrack(xml){
      const dom = new DOMParser().parseFromString(xml,'application/xml');
      let pts = [...dom.querySelectorAll('trkpt')].map(n=>({lat:+n.getAttribute('lat'), lon:+n.getAttribute('lon')}));
      if(!pts.length){ pts = [...dom.querySelectorAll('rtept')].map(n=>({lat:+n.getAttribute('lat'), lon:+n.getAttribute('lon')})); }
      return pts.filter(p=>Number.isFinite(p.lat)&&Number.isFinite(p.lon));
    }
    function afterGpxLoaded(label){
      if(!gpxTrack || gpxTrack.length<2){ trackStatusPill.textContent='GPX: premalo točaka'; return; }
      trackStatusPill.textContent = label;
      onTrackChip.textContent = '🧭 status: GPX spreman — klikni “Pokreni praćenje”';
      offDistChip.textContent = '↔︎ udaljenost: —';
      toggleTrackBtn.classList.add('alt'); setTimeout(()=>toggleTrackBtn.classList.remove('alt'), 1800);
    }

    /* --------------- Praćenje / GPS --------------- */
    toggleTrackBtn?.addEventListener('click', ()=>{
      alertMeters = Math.max(5, Number(alertMetersInput.value)||30);
      if(watchId==null){
        if(!gpxTrack || gpxTrack.length<2){ trackStatusPill.textContent='GPX: učitaj trag prvo'; return; }
        startGeoWatch(); toggleTrackBtn.textContent='Zaustavi praćenje';
      } else {
        stopGeoWatch(); toggleTrackBtn.textContent='Pokreni praćenje';
      }
    });

    function startGeoWatch(){
      try{
        watchId = navigator.geolocation.watchPosition(onPos, onGeoErr, { enableHighAccuracy:true, maximumAge:1000, timeout:10000 });
        trackStatusPill.textContent='GPS: praćenje uključeno';
        offBeepArmed = true; showMini();
      }catch(e){ trackStatusPill.textContent='GPS: ne mogu pokrenuti'; }
    }
    function stopGeoWatch(){
      if(watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
      trackStatusPill.textContent='GPS: zaustavljeno'; setArrowColor('ok'); hideMini(); hideGpsBanner(); stopTapeTick();
    }
    function onGeoErr(err){
      trackStatusPill.textContent='GPS greška: '+(err?.message||'');
      // GPS izgubljen
      if (!gpsLostSince) gpsLostSince = Date.now();
      showGpsBanner();
      maybeAskForTape();
    }
    function showGpsBanner(){ gpsBanner.style.display='flex'; }
    function hideGpsBanner(){ gpsBanner.style.display='none'; gpsLostSince = null; }
    bannerHide?.addEventListener('click', hideGpsBanner);

    function maybeAskForTape(){
      if (hbOn) return;
      if (!gpsLostSince) return;
      const noFixMs = Date.now() - gpsLostSince;
      if (noFixMs >= GPS_LOST_MODAL_AFTER_MS){
        // pitaj korisnika samo jednom po izgubljenom periodu
        if (tapeModalBack.style.display!=='grid'){
          tapeModalBack.style.display = 'grid';
        }
      }
    }
    tapeCancel?.addEventListener('click', ()=>{
      tapeModalBack.style.display='none';
    });
    tapeConfirm?.addEventListener('click', ()=>{
      tapeModalBack.style.display='none';
      startTapeMode(); // pokreni rezervni mod (bez GPS-a)
    });

    function onPos(pos){
      // GPS stigao: reset bannera i rezervnog moda
      hideGpsBanner();
      if (hbOn){ hbOn=false; stopTapeTick(); }

      const lat=pos.coords.latitude, lon=pos.coords.longitude;
      lastKnownLat = lat; lastKnownLon = lon;

      // snimi yaw/speed svake 1 s (za rezervni mod)
      const now = Date.now();
      if (now - lastHeadingSampleAt >= HEADING_SAMPLE_MS){
        lastHeadingSampleAt = now;
        const yaw = deviceWorldYawDeg();
        const spd = Number.isFinite(pos.coords.speed) ? Math.max(0, pos.coords.speed) : null;
        headingTape.push({ t: now, yawWorldDeg: yaw, speed: spd });
        if (headingTape.length > 7200) headingTape.shift();
      }

      // mrvice
      maybeAddCrumb(lat, lon, pos.coords.accuracy);

      if(!gpxTrack || gpxTrack.length<2) return;

      // Najbliža točka staze (cilj = točno ta projekcija)
      const nearest = nearestPointOnTrack({lat,lon}, gpxTrack);
      const dist = nearest.distM;
      updateOfftrackBar(dist);

      // Level-lock yaw: cilj je najbliža točka projicirana (bez “malo naprijed”)
      const tgt = { lat: nearest.lat, lon: nearest.lon };

      // yaw cilja u svijetu (horizontalna ravan)
      const vWorld = enuVector(lat, lon, tgt.lat, tgt.lon);
      const yawTarget = Math.atan2(vWorld[0], vWorld[1]) * DEG;
      valueTarget.textContent = Math.round((yawTarget+360)%360);

      // yaw uređaja u svijetu (neovisno o pitch/roll)
      let yawDevice = deviceWorldYawDeg();
      const dAng = ((yawTarget - yawDevice + 540) % 360) - 180;

      // delta UI
      valueDelta.textContent = Math.abs(dAng).toFixed(0);
      deltaHint.textContent = dAng>0 ? 'Okreći udesno →' : (dAng<0 ? 'Okreći ulijevo ←' : 'Poravnato ✓');
      deltaHint.className = dAng===0 ? 'ok' : 'warn';

      // glatka rotacija (rotateZ samo — level-lock)
      if (lastAngleDeg==null) lastAngleDeg = dAng;
      let delta = dAng - lastAngleDeg;
      if (delta>180) delta -= 360;
      if (delta<-180) delta += 360;
      lastAngleDeg = (lastAngleDeg + SMOOTHING*delta + 360) % 360;

      arrowNeedle.style.opacity = '1';
      arrowNeedle.style.transform = `rotateZ(${lastAngleDeg}deg)`;
      miniNeedle.style.transform  = `rotate(${lastAngleDeg}deg)`;

      // mini info
      miniMeters.textContent = `${dist.toFixed(0)} m`;
      if (dist <= OK_THRESHOLD_M) setMiniColor('ok'); else if (dist <= YELLOW_MAX_M) setMiniColor('warn'); else setMiniColor('bad');

      // Backtrack aktivan? vodi mrvicama (ali ovdje koristimo GPX mod; Backtrack ima svoju funkciju kad je uključen)
      if (backtrackOn){
        doBacktrackStep(lat, lon); // preusmjerava na mrvicu i UI setira
      }
    }

    function updateOfftrackBar(dist){
      if(dist<=OK_THRESHOLD_M){ setArrowColor('ok'); onTrackChip.textContent='🧭 status: na tragu ✓'; }
      else if(dist<=alertMeters){ setArrowColor('warn'); onTrackChip.textContent='🧭 status: blizu ruba'; }
      else {
        setArrowColor('bad'); onTrackChip.textContent='🧭 status: izvan traga';
        if(offBeepArmed){ offBeepArmed=false; // tri brza beepa
          beepOnce(1200,180); setTimeout(()=>beepOnce(1200,180),220); setTimeout(()=>beepOnce(1200,180),440);
          setTimeout(()=>offBeepArmed=true,8000);
        }
      }
      offDistChip.textContent = `↔︎ udaljenost: ${dist.toFixed(0)} m`;
    }

    // Backtrack
    btStart?.addEventListener('click', ()=>{
      if (!breadcrumbs.length){ btStatus.textContent = '↩︎ Povratak: nema zapisanih mrvica'; return; }
      backtrackOn = true;
      backIdx = findNearestCrumbIndex(lastKnownLat ?? breadcrumbs.at(-1)?.lat, lastKnownLon ?? breadcrumbs.at(-1)?.lon);
      btStatus.textContent = '↩︎ Povratak: uključen';
      onTrackChip.textContent = '🧭 status: povratak istim putem';
    });
    btStop?.addEventListener('click', ()=>{
      backtrackOn = false; backIdx = null;
      btStatus.textContent = '↩︎ Povratak: isključen';
      onTrackChip.textContent = '🧭 status: GPX način';
    });
    function findNearestCrumbIndex(lat,lon){
      if (!breadcrumbs.length || !Number.isFinite(lat) || !Number.isFinite(lon)) return 0;
      let bestI = 0, bestD = Infinity;
      for (let i=0;i<breadcrumbs.length;i++){
        const d = haversine(lat,lon, breadcrumbs[i].lat, breadcrumbs[i].lon);
        if (d < bestD){ bestD = d; bestI = i; }
      }
      return bestI;
    }
    function doBacktrackStep(lat, lon){
      if (breadcrumbs.length===0){ btStatus.textContent='↩︎ Povratak: nema mrvica'; return; }
      if (backIdx==null){ backIdx = findNearestCrumbIndex(lat,lon); }

      if (backIdx<=0){
        onTrackChip.textContent='🧭 status: stigao na start';
        btStatus.textContent='↩︎ Povratak: gotov';
        setArrowColor('ok'); offDistChip.textContent='↔︎ udaljenost: 0 m';
        return;
      }
      const tgt = breadcrumbs[backIdx];
      const distM = haversine(lat,lon, tgt.lat, tgt.lon);
      updateOfftrackBar(distM);

      // yaw cilja u svijetu
      const vWorld = enuVector(lat, lon, tgt.lat, tgt.lon);
      const yawTarget = Math.atan2(vWorld[0], vWorld[1]) * DEG;
      let yawDevice = deviceWorldYawDeg();

      let angle2D = ((yawTarget - yawDevice + 540) % 360) - 180;
      if (lastAngleDeg==null) lastAngleDeg = angle2D;
      let d = angle2D - lastAngleDeg; if (d>180) d-=360; if (d<-180) d+=360;
      lastAngleDeg = (lastAngleDeg + SMOOTHING*d + 360) % 360;

      arrowNeedle.style.display = 'block';
      arrowNeedle.style.transform = `rotateZ(${lastAngleDeg}deg)`;
      miniNeedle.style.transform  = `rotate(${lastAngleDeg}deg)`;
      miniMeters.textContent = `${Math.round(distM)} m`;

      if (distM <= AUTO_ADVANCE_RADIUS){ backIdx = Math.max(0, backIdx - 1); }
      btStatus.textContent = `↩︎ Povratak: ${backIdx}/${breadcrumbs.length-1}`;
      onTrackChip.textContent = '🧭 status: povratak istim putem';
    }

    // Rezervni mod bez GPS-a (kazeta smjerova) — skriven i samo uz potvrdu
    function startTapeMode(){
      if (!headingTape.length){ // ako ničeg nema, nema smisla
        onTrackChip.textContent='🧭 status: bez GPS-a — nema zapisa';
        return;
      }
      hbOn = true; hbIdx = headingTape.length - 1;
      onTrackChip.textContent='🧭 status: bez GPS-a — orijentacijski povratak';
      // tick
      if (tapeTick) clearInterval(tapeTick);
      tapeTick = setInterval(()=>{
        if (!hbOn || hbIdx==null || headingTape.length===0) return;
        const sample = headingTape[hbIdx];
        if (!sample){ stopTapeTick(); return; }
        const targetYaw = (sample.yawWorldDeg + 180) % 360; // suprotno
        const yawDevice = deviceWorldYawDeg();

        let angle2D = ((targetYaw - yawDevice + 540) % 360) - 180;
        if (lastAngleDeg==null) lastAngleDeg = angle2D;
        let d = angle2D - lastAngleDeg; if (d>180) d-=360; if (d<-180) d+=360;
        lastAngleDeg = (lastAngleDeg + SMOOTHING*d + 360) % 360;

        arrowNeedle.style.display = 'block';
        arrowNeedle.style.transform = `rotateZ(${lastAngleDeg}deg)`;
        miniNeedle.style.transform  = `rotate(${lastAngleDeg}deg)`;

        offDistChip.textContent = '↔︎ udaljenost: —';
        // postupno “odmotavaj” kazetu
        hbIdx = Math.max(0, hbIdx - 1);
      }, 220);
    }
    function stopTapeTick(){ if (tapeTick){ clearInterval(tapeTick); tapeTick=null; } }

    // Zatvaranje panela
    qs('#arrowClose')?.addEventListener('click', ()=>{
      hide(panelArrow);
      window.removeEventListener('deviceorientation', onOrient3D, true);
      stopGeoWatch();
    });

    // Pauza u pozadini (štedi bateriju)
    document.addEventListener('visibilitychange', ()=>{
      if(document.visibilityState==='hidden'){
        if(watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
        if(!useAOS){ window.removeEventListener('deviceorientation', onOrient3D, true); }
      } else {
        if(!useAOS){ window.addEventListener('deviceorientation', onOrient3D, true); }
        if(gpxTrack && gpxTrack.length>1 && toggleTrackBtn?.textContent?.includes('Zaustavi')) startGeoWatch();
      }
    });

    /* ---------------------------------
       Offline savjeti, dnevnik, checklista
       --------------------------------- */
    const logView = qs('#logView');
    function refreshLogView(){
      const saved = localStorage.getItem('ma_log') || '';
      logView.textContent = saved ? saved : '—';
    }
    refreshLogView();
    qs('#logSave')?.addEventListener('click', ()=>{
      const r=qs('#logRoute').value.trim(), t=qs('#logStart').value, n=qs('#logPeople').value, note=qs('#logNote').value.trim();
      const entry = `Ruta: ${r || '—'}\nPolazak: ${t || '—'}\nOsoba: ${n || '—'}\nNapomena: ${note || '—'}\nVrijeme spremanja: ${new Date().toLocaleString()}`;
      localStorage.setItem('ma_log', entry); refreshLogView();
    });
    qs('#logClear')?.addEventListener('click', ()=>{ localStorage.removeItem('ma_log'); refreshLogView(); });
    qs('#checkReset')?.addEventListener('click', ()=>{ qs('#checkList')?.querySelectorAll('input[type=checkbox]')?.forEach(c=>c.checked=false); });

    /* ---------------------------------
       Dnevno svjetlo — jednostavni tajmer
       --------------------------------- */
    const sunLeft = qs('#sunLeft');
    let sunTimer = null;
    qs('#sunStart')?.addEventListener('click', ()=>{
      const t = qs('#sunsetTime').value;
      if(!t){ sunLeft.textContent='Preostalo: — (postavi zalazak)'; return; }
      const [hh,mm] = t.split(':').map(Number);
      const now = new Date(); const tgt = new Date(); tgt.setHours(hh,mm,0,0);
      clearInterval(sunTimer);
      const tick = ()=>{
        const ms = tgt - new Date();
        if(ms<=0){ clearInterval(sunTimer); sunLeft.textContent = 'Preostalo: 0h 0m'; return; }
        const m = Math.floor(ms/60000), h = Math.floor(m/60), min = m%60;
        sunLeft.textContent = `Preostalo: ${h}h ${min}m`;
      };
      tick(); sunTimer = setInterval(tick, 15000);
    });
    qs('#sunStop')?.addEventListener('click', ()=>{ clearInterval(sunTimer); sunLeft.textContent='Preostalo: —'; });

    /* ---------------------------------
       SOS — morse (••• — — — •••)
       --------------------------------- */
    let sosCtx=null, sosOsc=null, sosGain=null, sosPlay=false;
    function sosBeep(freq=1000, dur=150){ return new Promise(res=>{ try{
      sosCtx = sosCtx || new (window.AudioContext||window.webkitAudioContext)();
      const t=sosCtx.currentTime; sosOsc=sosCtx.createOscillator(); sosGain=sosCtx.createGain();
      sosOsc.frequency.value=freq; sosOsc.type='sine'; sosGain.gain.value=0.0001; sosOsc.connect(sosGain); sosGain.connect(sosCtx.destination);
      sosOsc.start(); sosGain.gain.exponentialRampToValueAtTime(0.25, t+0.02);
      sosGain.gain.setValueAtTime(0.25, t+dur/1000-0.03); sosGain.gain.exponentialRampToValueAtTime(0.0001, t+dur/1000);
      sosOsc.stop(t+dur/1000+0.02); setTimeout(res, dur);
    }catch(e){ res(); } }); }
    async function playSOS(){
      if(sosPlay) return; sosPlay=true;
      while(sosPlay){
        await sosBeep(900,150); await sleep(120);
        await sosBeep(900,150); await sleep(120);
        await sosBeep(900,150); await sleep(300);
        await sosBeep(900,450); await sleep(150);
        await sosBeep(900,450); await sleep(150);
        await sosBeep(900,450); await sleep(300);
        await sosBeep(900,150); await sleep(120);
        await sosBeep(900,150); await sleep(120);
        await sosBeep(900,150); await sleep(900);
      }
    }
    function stopSOS(){ sosPlay=false; }
    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
    qs('#playSOS')?.addEventListener('click', playSOS);
    qs('#stopSOS')?.addEventListener('click', stopSOS);

    /* ---------------------------------
       Mini widget drag
       --------------------------------- */
    (function enableMiniDrag(){
      if(!mini) return;
      let sx=0, sy=0, ox=mini.offsetLeft, oy=mini.offsetTop, dragging=false;
      function start(ev){ dragging=true; const pt=ev.touches?ev.touches[0]:ev; sx=pt.clientX; sy=pt.clientY; ox=mini.offsetLeft; oy=mini.offsetTop; ev.preventDefault(); }
      function move(ev){ if(!dragging) return; const pt=ev.touches?ev.touches[0]:ev; const dx=pt.clientX-sx, dy=pt.clientY-sy; mini.style.left=Math.max(6, ox+dx)+'px'; mini.style.top=Math.max(6, oy+dy)+'px'; }
      function end(){ dragging=false; }
      mini.addEventListener('mousedown', start); mini.addEventListener('touchstart', start, {passive:false});
      window.addEventListener('mousemove', move); window.addEventListener('touchmove', move, {passive:false});
      window.addEventListener('mouseup', end); window.addEventListener('touchend', end);
    })();
  </script>
</body>
</html>
