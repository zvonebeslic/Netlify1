<!DOCTYPE html>
<html lang="hr">
<head>
  <!-- =========================================================
       META / PWA
       ========================================================= -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mountain Adventures — Digitalni ruksak</title>
  <meta name="description" content="Digitalni ruksak: vodiči, kamera, 3D vodoravna strelica s GPX praćenjem (file/URL), backtrack mrvice, offline savjeti, dnevno svjetlo i SOS." />
  <link rel="icon" href="images/mountain-adventures.svg" type="image/svg+xml" />
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0e0f10" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="images/mountain-adventures-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- =========================================================
       STIL
       ========================================================= -->
  <style>
    :root{
      --bg:#0e0f10; --fg:#e9eef2; --muted:#9aa6b2; --card:#121416; --line:#1f2327;
      --accent:#2aa96b; --accent-2:#3aa0ff; --accent-3:#e44747;
      --ok:#86d486; --warn:#f2c14e; --bad:#ff6b6b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--fg);
      font:500 15px/1.5 Montserrat,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;
    }

    /* NAVBAR */
    .navbar{
      position:sticky;top:0;z-index:1000;
      background:linear-gradient(#14171b,#0e0f10);border-bottom:1px solid var(--line);
      display:flex;align-items:center;gap:12px;justify-content:space-between;
      padding:10px 14px;
    }
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{width:22px;height:22px}
    .brand span{font-weight:700;font-size:15px;letter-spacing:.2px}
    .navgroup{display:flex;align-items:center;gap:10px}
    .navlink{color:var(--muted);text-decoration:none;font-size:14px;padding:6px 8px;border-radius:8px}
    .navlink:hover{background:#1a1d22;color:#fff}
    .flag{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:13px;color:var(--muted)}
    .flag img{width:16px;height:12px;object-fit:cover;border-radius:2px}

    header.page-head{padding:10px 14px;border-bottom:1px solid var(--line)}
    header.page-head h1{margin:0;font-size:18px}
    header.page-head .intro{margin:4px 0 0;color:var(--muted);font-size:13px}

    main{max-width:1100px;margin:0 auto;padding:18px 14px 28px}
    .tools-grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(310px,1fr))}
    .tool-card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px 12px 12px}
    .eyebrow{font-size:11px;color:var(--muted);letter-spacing:.3px;text-transform:uppercase}
    .tool-card h3{margin:6px 0 6px;font-size:16px}
    .tool-card p,.tool-card ul{color:var(--muted);font-size:13px}
    .tool-card ul{margin:6px 0 8px 18px;padding:0}
    .btn-row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:0;border-radius:10px;padding:.55em .9em;font-weight:700;background:var(--accent);color:#fff;cursor:pointer;text-decoration:none;display:inline-block;font-size:13px}
    .btn.ghost{background:#2b2f36}
    .btn.alt{background:var(--accent-2)}
    .btn.alert{background:var(--accent-3)}
    .hint{color:var(--muted);font-size:12px}
    section.tool-panel{margin-top:16px;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
    section.tool-panel h4{margin:0 0 8px;font-size:16px}
    .divider{height:1px;background:var(--line);margin:10px 0 12px}
    .two-col{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:800px){.two-col{grid-template-columns:.9fr 1.1fr}}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);padding:.3em .6em;border-radius:999px;font-size:12px;color:var(--muted)}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .bad{color:var(--bad)}

    /* Kamera */
    .camera-wrap{display:grid;gap:10px}
    video#camVideo{width:100%;aspect-ratio:9/16;max-height:72vh;background:#000;border-radius:10px}
    canvas#camCanvas{display:none}
    .toolbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .dot{width:10px;height:10px;border-radius:50%;background:#a33;box-shadow:0 0 6px #600}
    .dot.ok{background:#3c3;box-shadow:0 0 8px #2a2}
    #camMsg{min-width:200px;color:var(--muted);font-size:12px}
    #camThumb{max-width:220px;border-radius:8px;border:1px solid var(--line)}

    /* Kompas + 3D strelica */
    .compass-wrap{display:grid;gap:10px}
    .compass-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .compass{
      width:150px;height:150px;border-radius:50%;border:1px solid var(--line);
      background:
        radial-gradient(closest-side, rgba(255,255,255,.06), rgba(0,0,0,0) 60%),
        radial-gradient(transparent 58%, #1b1f25 59%);
      display:grid;place-items:center;position:relative;perspective:800px;
    }
    .compass .tick{position:absolute;inset:8px;border-radius:50%;border:1px dashed #2a2f36}
    .arrow3d{
      width:68px;height:12px;position:relative;transform-style:preserve-3d;
      transition:transform .14s ease-out, opacity .14s ease-out, filter .2s ease-out;
      filter: drop-shadow(0 10px 14px rgba(0,0,0,.35));
    }
    .arrow3d::after{ /* tijelo */
      content:"";position:absolute;left:0;top:2px;bottom:2px;width:58px;border-radius:6px;
      background:linear-gradient(180deg,#36c286,#1e915f);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.2), inset 0 -1px 0 rgba(0,0,0,.2);
      transform:translateZ(0.6px);
    }
    .arrow3d::before{ /* vrh */
      content:"";position:absolute;right:-14px;top:-6px;border-left:14px solid #36c286;
      border-top:12px solid transparent;border-bottom:12px solid transparent;transform:translateZ(0.8px);
      filter:drop-shadow(0 2px 2px rgba(0,0,0,.4));
    }
    .arrow3d.warn::after{background:linear-gradient(180deg,#f4c35f,#c78f2a)}
    .arrow3d.warn::before{border-left-color:#f4c35f}
    .arrow3d.bad::after{background:linear-gradient(180deg,#ff7a7a,#d84e4e)}
    .arrow3d.bad::before{border-left-color:#ff7a7a}

    .status-line{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .field{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type="number"],input[type="time"],input[type="file"],input[type="url"],input[type="text"]{
      background:#0f1114;border:1px solid var(--line);border-radius:8px;color:#fff;padding:.5em .6em;outline:none;font-size:13px
    }
    input[type="number"]{width:110px}

    /* Mini strelica (HUD) */
    #miniCompass{position:fixed;left:10px;bottom:10px;z-index:9999;width:78px;height:78px;border-radius:14px;padding:8px;background:rgba(18,20,22,.9);border:1px solid var(--line);backdrop-filter:blur(6px);box-shadow:0 8px 24px rgba(0,0,0,.35);touch-action:none;user-select:none}
    #miniCompass .mini-ring{width:100%;height:52px;border-radius:999px;border:1px dashed #2a2f36;display:grid;place-items:center;position:relative;overflow:hidden}
    #miniCompass .mini-needle{width:40px;height:6px;background:#2aa96b;border-radius:4px;transform-origin:0% 50%;transition:transform .14s ease-out, background .2s ease-out}
    #miniCompass .mini-needle.warn{background:#e09f3e}
    #miniCompass .mini-needle.bad{background:#e44747}
    #miniCompass .mini-info{text-align:center;font-size:11px;color:var(--muted);margin-top:4px}
    #miniCompass[hidden]{display:none}

    /* Banner & modal */
    .banner{position:fixed;left:0;right:0;bottom:0;background:#2b2f36;border-top:1px solid var(--line);padding:8px 12px;display:flex;align-items:center;gap:8px;z-index:10000}
    .banner .msg{color:#ddd;font-size:13px}
    .banner .actions{margin-left:auto;display:flex;gap:8px}
    .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;place-items:center;z-index:10001}
    .modal{background:#161a1e;border:1px solid var(--line);border-radius:12px;padding:14px;max-width:520px;width:92%}
    .modal h5{margin:0 0 6px;font-size:16px}
    .modal p{margin:0 0 10px;color:var(--muted);font-size:13px}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end}

    /* FOOTER */
    footer{margin-top:26px;border-top:1px solid var(--line);padding:14px;color:var(--muted);font-size:12px;text-align:center}
  </style>
</head>

<body>
  <!-- NAVBAR -->
  <nav class="navbar" aria-label="Glavna navigacija">
    <div class="brand">
      <img src="images/mountain-adventures.svg" alt="Logo">
      <span>Digitalni ruksak</span>
    </div>
    <div class="navgroup">
      <a class="navlink" href="#tool-aid">Vodiči</a>
      <a class="navlink" href="#tool-camera">Kamera</a>
      <a class="navlink" href="#tool-arrow">Strelica</a>
      <a class="navlink" href="#tool-offline">Offline</a>
      <a class="navlink" href="#tool-sos">SOS</a>
      <span class="flag" title="Jezik: Bosanski/Hrvatski/Srpski">
        <img src="https://flagcdn.com/w20/ba.png" alt="BA"> BA/HR/SR
      </span>
    </div>
  </nav>

  <header class="page-head">
    <h1>Digitalni ruksak</h1>
    <p class="intro">Vodiči, kamera, 3D vodoravna strelica za GPX, backtrack, offline savjeti i SOS.</p>
  </header>

  <!-- MAIN -->
  <main>
    <section class="tools-grid" aria-label="Alati">
      <!-- 1) DIGITALNA POMOĆ -->
      <article class="tool-card" id="tool-aid">
        <div class="eyebrow">Prioritet</div>
        <h3>Digitalna pomoć (jasni, laički vodiči)</h3>
        <p>Brzi postupci koje svatko može slijediti. Prvo sigurnost mjesta, zatim 112.</p>
        <div class="btn-row">
          <button class="btn alt" id="openAidPanel">Otvori vodiče</button>
          <span class="chip">⛰️ Podsjetnici pri ruci</span>
        </div>
      </article>

      <!-- 2) KAMERA -->
      <article class="tool-card" id="tool-camera">
        <div class="eyebrow">Foto</div>
        <h3>Pejzažno snimanje uživo</h3>
        <p>Stabilan kadar → blago pojačanje kontrasta/boje/oštrine → snimka (offline).</p>
        <ul>
          <li>Auto-stabilnost (snima kad se umiri)</li>
          <li>Radi na HTTPS/localhost</li>
          <li>Bez slanja na server</li>
        </ul>
        <div class="btn-row">
          <button class="btn" id="openCamPanel">Otvori alat</button>
          <a class="btn ghost" href="tools/camera-auto-enhance.html">U novoj kartici</a>
        </div>
        <p class="hint">Privatnost: slika ostaje u tvom pregledniku.</p>
      </article>

      <!-- 3) PAMETNA STRELICA -->
      <article class="tool-card" id="tool-arrow">
        <div class="eyebrow">Orijentacija</div>
        <h3>Pametna strelica (3D, uvijek vodoravna) — GPX</h3>
        <p>Učitaj GPX (file ili URL). Strelica cilja <b>točno najbližu točku staze</b>. Žuta/crvena upozorenja + 3x beep.</p>
        <div class="btn-row">
          <button class="btn" id="openArrowPanel">Otvori alat</button>
          <button class="btn ghost" id="openPopupBtn" title="Mali odvojeni prozor s mini strelicom">Pop-up strelica</button>
          <button class="btn ghost" id="closePopupBtn" title="Zatvori pop-up" style="display:none">Zatvori pop-up</button>
        </div>
        <p class="hint">iOS traži “Motion & Orientation” dopuštenje; radi na HTTPS-u.</p>
      </article>

      <!-- 4) OFFLINE SAVJETI -->
      <article class="tool-card" id="tool-offline">
        <div class="eyebrow">Navigacija</div>
        <h3>Offline karte & GPX</h3>
        <p>Preuzmi regiju u OSMand/Organic Maps; GPX spremi lokalno.</p>
        <div class="btn-row">
          <button class="btn ghost" id="openOfflinePanel">Brzi savjeti</button>
        </div>
      </article>

      <!-- 5) DNEVNIK -->
      <article class="tool-card" id="tool-log">
        <div class="eyebrow">Sigurnost</div>
        <h3>Planinarski dnevnik</h3>
        <p>Zapiši rutu, vrijeme polaska i smjer kretanja (za slučaj potrebe).</p>
        <div class="btn-row">
          <button class="btn ghost" id="openLogPanel">Otvori dnevnik</button>
        </div>
      </article>

      <!-- 6) CHECK-LISTA -->
      <article class="tool-card" id="tool-check">
        <div class="eyebrow">Priprema</div>
        <h3>Check-lista prije polaska</h3>
        <p>Voda, slojevi, prva pomoć, svjetlo, GPX, baterija…</p>
        <div class="btn-row">
          <button class="btn ghost" id="openChecklistPanel">Otvori listu</button>
        </div>
      </article>

      <!-- 7) DNEVNO SVJETLO -->
      <article class="tool-card" id="tool-light">
        <div class="eyebrow">Vrijeme</div>
        <h3>Dnevno svjetlo</h3>
        <p>Odaberi zalazak ili auto-lokalno i prati koliko je svjetla preostalo.</p>
        <div class="btn-row">
          <button class="btn ghost" id="openSunPanel">Tajmer svjetla</button>
        </div>
      </article>

      <!-- 8) SOS -->
      <article class="tool-card" id="tool-sos">
        <div class="eyebrow">SOS</div>
        <h3>SOS zviždaljka</h3>
        <p>Glasan ton (••• — — — •••). 112 je prioritet.</p>
        <div class="btn-row">
          <button class="btn alert" id="playSOS">Pokreni SOS</button>
          <button class="btn ghost" id="stopSOS">Zaustavi</button>
        </div>
      </article>
    </section>

    <!-- PANELI -->
    <!-- PANEL: Digitalna pomoć -->
    <section id="panelAid" class="tool-panel" hidden>
      <h4>Digitalna pomoć — laički vodiči</h4>
      <div class="two-col">
        <div>
          <div class="chip">ℹ️ Podsjetnik — ne zamjenjuje tečaj prve pomoći</div>
          <div class="divider"></div>
          <div class="aid-accordion" id="aidAcc">
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">🚑 KPR (odrasli)</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li><b>Najprije:</b> sigurno mjesto, pozovi <b>112</b>.</li>
                  <li><b>Ne diše normalno?</b> Kreni s KPR: dlan na sredinu prsnog koša, drugi dlan preko, laktovi ravno.</li>
                  <li><b>Ritam:</b> 100–120/min; <b>dubina 5–6 cm</b>. Pusti da se prsa vrate gore.</li>
                  <li>Omjer <b>30:2</b> samo ako znaš i imaš masku — inače samo pritisci.</li>
                </ul>
              </div>
            </div>
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">🩸 Jako krvarenje</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li><b>Stisni</b> direktno 10 minuta bez provjeravanja.</li>
                  <li>Ako promoči, <b>dodaj</b> preko (ne skidaj prvu gazu).</li>
                  <li>Za udove: kompresivni zavoj/turniket (zabilježi vrijeme).</li>
                </ul>
              </div>
            </div>
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">🧊 Hladnoća (hipotermija)</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li>Suho i toplo slojevito; vjetar/vlaga out.</li>
                  <li>Astrofolija: srebrna <b>prema tijelu</b> grije (zlatna vani).</li>
                </ul>
              </div>
            </div>
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">📢 112 — što reći</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li>Lokacija (koordinate/oznaka staze), što se dogodilo, broj osoba, pristup.</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="divider"></div>
          <div class="hint">Ovo su sažeti podsjetnici. Tečaj prve pomoći je preporučljiv.</div>
        </div>
        <div>
          <h4 style="margin-top:0">Brzi podsjetnici</h4>
          <ul>
            <li>Astrofolija: <b>srebrna prema tijelu</b>.</li>
            <li>KPR: <b>30:2</b> (ako znaš), 100–120/min.</li>
            <li>Krvarenje: <b>stisni 10 min</b>; dodaj preko.</li>
          </ul>
          <div class="chip" style="margin-top:8px">📞 112 — hitna pomoć i spašavanje</div>
        </div>
      </div>
    </section>

    <!-- PANEL: Kamera -->
    <section id="panelCamera" class="tool-panel" hidden>
      <h4>Pejzažno snimanje (ugrađeno)</h4>
      <div class="camera-wrap">
        <video id="camVideo" autoplay playsinline></video>
        <canvas id="camCanvas"></canvas>
        <div class="toolbar">
          <div id="camDot" class="dot" title="Pokazatelj mirnoće"></div>
          <div id="camMsg">Tražim stabilnost…</div>
          <button id="camManual" class="btn ghost">Snimi sada</button>
          <button id="camAuto" class="btn">Auto snimanje: ON</button>
          <button id="camClose" class="btn ghost">Zatvori</button>
        </div>
        <div class="result">
          <img id="camThumb" alt="Pregled snimljene fotografije" />
          <div class="hint">Radi samo na HTTPS/localhost. Slika ostaje lokalno.</div>
        </div>
      </div>
    </section>

    <!-- PANEL: Pametna strelica -->
    <section id="panelArrow" class="tool-panel" hidden>
      <h4>Pametna strelica — GPX (file/URL) + Backtrack</h4>
      <div class="compass-wrap">
        <div class="compass-row">
          <div class="compass" aria-label="Kompas">
            <div class="tick"></div>
            <div id="arrow3d" class="arrow3d" style="opacity:0"></div>
          </div>
          <div class="hint">Strelica je uvijek vodoravna (level-lock). Cilja točno najbližu točku staze.</div>
        </div>

        <div class="divider"></div>

        <div class="compass-row">
          <div class="field">
            <label for="gpxInput">GPX file:</label>
            <input id="gpxInput" type="file" accept=".gpx,application/gpx+xml" />
            <button class="btn ghost" id="loadGpxBtn">Učitaj</button>
          </div>
          <div class="field">
            <label for="gpxUrl">GPX URL:</label>
            <input id="gpxUrl" type="url" placeholder="https://…/ruta.gpx" style="width:260px" />
            <button class="btn ghost" id="loadUrlBtn">Učitaj URL</button>
          </div>
          <div class="field">
            <label for="alertMeters">Prag (m) zvuka:</label>
            <input id="alertMeters" type="number" min="5" step="5" value="30" />
            <button class="btn" id="toggleTrackBtn">Pokreni praćenje</button>
          </div>
        </div>

        <div class="status-line" style="margin-top:6px">
          <span class="chip" id="trackStatusPill">GPX: —</span>
          <span class="chip" id="onTrackChip">🧭 status: —</span>
          <span class="chip" id="offDistChip">↔︎ udaljenost: —</span>
        </div>

        <div class="divider"></div>

        <!-- Backtrack (mrvice) -->
        <div class="compass-row">
          <div class="btn-row">
            <button class="btn ghost" id="btStart">Započni povratak</button>
            <button class="btn ghost" id="btStop">Zaustavi povratak</button>
          </div>
          <span class="chip" id="btStatus">↩︎ Povratak: isključen</span>
        </div>

        <p class="hint" style="margin-top:6px">URL može imati parametar: <code>?gpx=https://…/ruta.gpx</code></p>

        <div><button class="btn" id="arrowClose">Zatvori</button></div>
      </div>
    </section>

    <!-- PANEL: Offline savjeti (DODANO) -->
    <section id="panelOffline" class="tool-panel" hidden>
      <h4>Offline savjeti</h4>
      <ul>
        <li>U aplikaciji <b>Organic Maps</b> ili <b>OSMand</b> preuzmi regiju za offline.</li>
        <li>GPX spremi lokalno na uređaj i otvori iz aplikacije (bez interneta).</li>
        <li>Uključi “Airplane mode” + GPS radi štednje baterije.</li>
      </ul>
      <button class="btn ghost" onclick="this.closest('section').hidden=true">Zatvori</button>
    </section>

    <!-- PANEL: Dnevnik (DODANO) -->
    <section id="panelLog" class="tool-panel" hidden>
      <h4>Planinarski dnevnik</h4>
      <div class="two-col">
        <div>
          <div class="field"><label for="logRoute">Ruta:</label><input id="logRoute" type="text" placeholder="npr. Barzonja → Jelinak" /></div>
          <div class="field"><label for="logStart">Polazak:</label><input id="logStart" type="time" /></div>
          <div class="field"><label for="logPeople">Osoba/e:</label><input id="logPeople" type="text" placeholder="npr. 2 + pas" /></div>
          <div class="field"><label for="logNote">Napomena:</label><input id="logNote" type="text" placeholder="smjer kretanja, vremenska prognoza…" /></div>
          <div class="btn-row"><button class="btn" id="logSave">Spremi</button><button class="btn ghost" id="logClear">Obriši</button></div>
        </div>
        <div>
          <h4 style="margin-top:0">Zadnji zapis</h4>
          <pre id="logView" style="white-space:pre-wrap;background:#0f1114;border:1px solid var(--line);border-radius:8px;padding:8px;min-height:90px"></pre>
        </div>
      </div>
      <button class="btn ghost" onclick="this.closest('section').hidden=true">Zatvori</button>
    </section>

    <!-- PANEL: Check-lista (DODANO) -->
    <section id="panelChecklist" class="tool-panel" hidden>
      <h4>Check-lista prije polaska</h4>
      <div id="checkList" class="two-col">
        <label><input type="checkbox"> Voda (min. 2 L)</label>
        <label><input type="checkbox"> Hrana/energetske pločice</label>
        <label><input type="checkbox"> Topli slojevi / kabanica</label>
        <label><input type="checkbox"> Prva pomoć / astrofolija</label>
        <label><input type="checkbox"> Svjetlo + baterije</label>
        <label><input type="checkbox"> GPX + offline karta</label>
        <label><input type="checkbox"> Napunjena baterija / power bank</label>
      </div>
      <div class="btn-row" style="margin-top:8px">
        <button class="btn ghost" id="checkReset">Poništi</button>
        <button class="btn" onclick="this.closest('section').hidden=true">Zatvori</button>
      </div>
    </section>

    <!-- PANEL: Dnevno svjetlo (DODANO) -->
    <section id="panelSun" class="tool-panel" hidden>
      <h4>Dnevno svjetlo — tajmer</h4>
      <div class="field">
        <label for="sunsetTime">Zalazak:</label>
        <input id="sunsetTime" type="time" />
        <button class="btn" id="sunStart">Pokreni</button>
        <button class="btn ghost" id="sunStop">Zaustavi</button>
      </div>
      <div class="chip" id="sunLeft">Preostalo: —</div>
      <div style="margin-top:8px"><button class="btn ghost" onclick="this.closest('section').hidden=true">Zatvori</button></div>
    </section>
  </main>

  <!-- MINI STRELICA WIDGET (HUD) -->
  <div id="miniCompass" aria-label="Mini strelica" hidden>
    <div class="mini-ring"><div id="miniNeedle" class="mini-needle"></div></div>
    <div class="mini-info"><span id="miniMeters">— m</span></div>
  </div>

  <!-- BANNER: GPS lost -->
  <div id="gpsBanner" class="banner" style="display:none">
    <div class="msg">📡 Nema GPS signala — čekam fix. Navigacija ograničena.</div>
    <div class="actions"><button class="btn ghost" id="bannerHide">Sakrij</button></div>
  </div>

  <!-- MODAL: Rezervna “kazeta smjerova” (krajnja nužda) -->
  <div id="tapeModalBack" class="modal-back">
    <div class="modal">
      <h5>Rezervni način — bez GPS-a</h5>
      <p>Orijentacijski povratak koristeći ranije snimljene smjerove (bez udaljenosti). Koristi samo u krajnjoj nuždi dok se GPS ne vrati.</p>
      <div class="actions">
        <button class="btn ghost" id="tapeCancel">Odustani</button>
        <button class="btn alert" id="tapeConfirm">Uključi privremeno</button>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer>
    © Mountain Adventures · Offline spremno (PWA) · Ako je opasno: zaustavi se i zovi 112.
  </footer>

  <!-- =========================================================
       SCRIPT
       ========================================================= -->
  <script>
    
    /* PWA SW */
if ('serviceWorker' in navigator){
  navigator.serviceWorker.register('/sw.js').catch(()=>{});
}

    /* Helpers / paneli */
    const qs = s => document.querySelector(s);
    const show = el => { if(!el) return; el.hidden=false; el.scrollIntoView({ behavior:'smooth', block:'start' }); };
    const hide = el => { if(!el) return; el.hidden=true; };

    const panelAid=qs('#panelAid'), panelCamera=qs('#panelCamera'), panelArrow=qs('#panelArrow'),
          panelOffline=qs('#panelOffline'), panelLog=qs('#panelLog'), panelChecklist=qs('#panelChecklist'), panelSun=qs('#panelSun');

    qs('#openAidPanel')?.addEventListener('click', () => show(panelAid));
    qs('#openCamPanel')?.addEventListener('click', async () => { show(panelCamera); await startCam(); });
    qs('#openArrowPanel')?.addEventListener('click', () => { show(panelArrow); openArrow(); });
    qs('#openOfflinePanel')?.addEventListener('click', () => show(panelOffline));
    qs('#openLogPanel')?.addEventListener('click', () => show(panelLog));
    qs('#openChecklistPanel')?.addEventListener('click', () => show(panelChecklist));
    qs('#openSunPanel')?.addEventListener('click', () => show(panelSun));

    /* Akordeon */
    (function(){ const acc=qs('#aidAcc'); if(!acc) return;
      acc.querySelectorAll('.aid-head').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const body=btn.parentElement.querySelector('.aid-body');
          const open=btn.classList.toggle('open'); body.style.display=open?'block':'none';
        });
      });
    })();

    /* Kamera */
    const camClose=qs('#camClose'), camVideo=qs('#camVideo'),
          camCanvas=qs('#camCanvas'), camCtx=camCanvas?.getContext?.('2d',{willReadFrequently:true}),
          camDot=qs('#camDot'), camMsg=qs('#camMsg'), camThumb=qs('#camThumb'),
          camManual=qs('#camManual'), camAutoBtn=qs('#camAuto');

    const STABILITY_FRAMES=8, DIFF_THRESHOLD=6, CAPTURE_WIDTH=1600;
    let camAutoMode=true, camPrev=null, camSteady=0, camLastAuto=0, camLoopOn=false;

    camClose?.addEventListener('click', stopCam);
    camAutoBtn?.addEventListener('click', ()=>{ camAutoMode=!camAutoMode; camAutoBtn.textContent=camAutoMode?'Auto snimanje: ON':'Auto snimanje: OFF'; });
    camManual?.addEventListener('click', captureCam);

    async function startCam(){
      if(camLoopOn) return;
      try{
        const stream=await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
        camVideo.srcObject=stream; await camVideo.play();
        camCanvas.width=Math.min(1280,camVideo.videoWidth||1280);
        camCanvas.height=Math.min(720,camVideo.videoHeight||720);
        camLoopOn=true; requestAnimationFrame(camLoop);
      }catch(e){ camMsg.textContent='Greška s kamerom: '+e.message; }
    }
    function stopCam(){ hide(panelCamera); camLoopOn=false; try{ camVideo.pause(); camVideo.srcObject?.getTracks?.().forEach(t=>t.stop()); camVideo.srcObject=null; }catch(e){} }
    function lumaAt(d,i){ return 0.2126*d[i]+0.7152*d[i+1]+0.0722*d[i+2]; }
    function frameDiff(a,b){ const da=a.data, db=b.data; let s=0,n=da.length/4; for(let p=0,i=0;p<n;p++,i+=4){ s+=Math.abs(lumaAt(da,i)-lumaAt(db,i)); } return s/n; }
    function autoContrast(img){ const d=img.data,n=d.length/4; let lo=255,hi=0; for(let i=0;i<n;i++){const idx=i*4,L=lumaAt(d,idx); if(L<lo)lo=L; if(L>hi)hi=L;} const range=Math.max(1,hi-lo),scale=255/range;
      for(let i=0;i<n;i++){const idx=i*4; d[idx]=Math.min(255,Math.max(0,(d[idx]-lo)*scale)); d[idx+1]=Math.min(255,Math.max(0,(d[idx+1]-lo)*scale)); d[idx+2]=Math.min(255,Math.max(0,(d[idx+2]-lo)*scale)); } return img; }
    function unsharp(img,a=.55,r=1){ const w=img.width,h=img.height,s=img.data,out=new Uint8ClampedArray(s.length);
      for(let y=0;y<h;y++){ for(let x=0;x<w;x++){ let rsum=0,gsum=0,bsum=0,c=0;
        for(let oy=-r;oy<=r;oy++){const yy=Math.min(h-1,Math.max(0,y+oy));
          for(let ox=-r;ox<=r;ox++){const xx=Math.min(w-1,Math.max(0,x+ox)),i=(yy*w+xx)*4; rsum+=s[i]; gsum+=s[i+1]; bsum+=s[i+2]; c++;}}
        const i=(y*w+x)*4, br=rsum/c, bg=gsum/c, bb=bsum/c;
        out[i]=Math.min(255,Math.max(0,s[i]+a*(s[i]-br))); out[i+1]=Math.min(255,Math.max(0,s[i+1]+a*(s[i+1]-bg))); out[i+2]=Math.min(255,Math.max(0,s[i+2]+a*(s[i+2]-bb))); out[i+3]=s[i+3];
      }} img.data.set(out); return img; }
    async function camLoop(){ if(!camLoopOn) return;
      if(camVideo.readyState>=2){ camCtx.drawImage(camVideo,0,0,camCanvas.width,camCanvas.height); const cur=camCtx.getImageData(0,0,camCanvas.width,camCanvas.height);
        if(camPrev){ const diff=frameDiff(cur,camPrev);
          if(diff<DIFF_THRESHOLD){ camSteady++; camDot.classList.add('ok'); camMsg.textContent=`Mirno — ${camSteady}/${STABILITY_FRAMES}`; }
          else{ camSteady=0; camDot.classList.remove('ok'); camMsg.textContent=`Nemirno (${Math.round(diff)}), drži mirnije`; }
          if(camSteady>=STABILITY_FRAMES && camAutoMode){ const now=Date.now(); if(now-camLastAuto>2500){ camLastAuto=now; await captureCam(); } camSteady=0; }
        } camPrev=cur; }
      requestAnimationFrame(camLoop);
    }
    async function captureCam(){
      camMsg.textContent='Snimam i obrađujem…';
      try{
        const track=camVideo.srcObject?.getVideoTracks?.()[0];
        if(track && window.ImageCapture){
          const ic=new ImageCapture(track);
          if(ic.takePhoto){
            const blob=await ic.takePhoto(); const bmp=await createImageBitmap(blob); const r=bmp.width/bmp.height;
            const W=Math.min(CAPTURE_WIDTH,bmp.width), H=Math.round(W/r); camCanvas.width=W; camCanvas.height=H;
            camCtx.drawImage(bmp,0,0,W,H);
            camCtx.filter='contrast(1.06) saturate(1.08)'; camCtx.drawImage(camCanvas,0,0); camCtx.filter='none';
            let id=camCtx.getImageData(0,0,W,H); id=autoContrast(id); id=unsharp(id,.6,1); camCtx.putImageData(id,0,0);
            const url=camCanvas.toDataURL('image/jpeg',0.92); camThumb.src=url; camMsg.innerHTML='Gotovo. <a style="margin-left:8px" download="mountain-photo.jpg" href="'+url+'">Preuzmi</a>'; return;
          }
        }
      }catch(e){}
      const r=(camVideo.videoWidth||1080)/(camVideo.videoHeight||1920);
      const W=Math.min(CAPTURE_WIDTH,camVideo.videoWidth||1280), H=Math.round(W/r);
      camCanvas.width=W; camCanvas.height=H; camCtx.drawImage(camVideo,0,0,W,H);
      camCtx.filter='contrast(1.06) saturate(1.08)'; camCtx.drawImage(camCanvas,0,0); camCtx.filter='none';
      let id=camCtx.getImageData(0,0,W,H); id=autoContrast(id); id=unsharp(id,.6,1); camCtx.putImageData(id,0,0);
      const url=camCanvas.toDataURL('image/jpeg',0.92); camThumb.src=url; camMsg.innerHTML='Gotovo. <a style="margin-left:8px" download="mountain-photo.jpg" href="'+url+'">Preuzmi</a>';
    }

    /* =========================================================
       STRELICA 3D + GPX + Backtrack + Rezervna kazeta + POP-UP
       ========================================================= */
    // UI refs
    const arrowEl=qs('#arrow3d'),
          gpxInput=qs('#gpxInput'), loadGpxBtn=qs('#loadGpxBtn'),
          gpxUrl=qs('#gpxUrl'), loadUrlBtn=qs('#loadUrlBtn'),
          alertMetersInput=qs('#alertMeters'), toggleTrackBtn=qs('#toggleTrackBtn'),
          trackStatusPill=qs('#trackStatusPill'), onTrackChip=qs('#onTrackChip'), offDistChip=qs('#offDistChip'),
          gpsBanner=qs('#gpsBanner'), bannerHide=qs('#bannerHide'),
          tapeModalBack=qs('#tapeModalBack'), tapeConfirm=qs('#tapeConfirm'), tapeCancel=qs('#tapeCancel'),
          openPopupBtn=qs('#openPopupBtn'), closePopupBtn=qs('#closePopupBtn');

    const mini=qs('#miniCompass'), miniNeedle=qs('#miniNeedle'), miniMeters=qs('#miniMeters');

    // Pop-up window handle
    let miniWin = null;

    // Stanje
    const R=6371000, RAD=Math.PI/180, DEG=180/Math.PI;
    let useAOS=false, lastMatrix=null;
    let gpxTrack=null, watchId=null, alertMeters=30;
    let audioCtx=null, offBeepArmed=false;
    let lastKnownLat=null, lastKnownLon=null;

    // Level-lock & smoothing
    let lastAngleDeg=0;
    const SMOOTHING=0.18;
    const DEAD_BAND_DEG=3;
    const MAX_ROT_SPEED_DPS=240;

    // pragovi
    const OK_THRESHOLD_M=5, YELLOW_MAX_M=10;

    // mrvice
    let breadcrumbs=[]; let lastCrumb=null; const CRUMB_MIN_DIST=10, CRUMB_MAX_ACC=35, CRUMB_MIN_INTERVAL_MS=30000, AUTO_ADVANCE_RADIUS=8;
    let backtrackOn=false, backIdx=null;

    // rezervna kazeta
    let headingTape=[]; let hbOn=false; let hbIdx=null; const HEADING_SAMPLE_MS=1000;
    let lastHeadingSampleAt=0, gpsLostSince=null, tapeTick=null; const GPS_LOST_MODAL_AFTER_MS=120000;

    // GPS heading fallback (COG)
    let lastFix=null; // {lat,lon,t}
    const COG_MIN_SPEED=0.5; // m/s

    // Helpers
    const toRad=x=>x*RAD;
    function quatToMatrix(x,y,z,w){
      const xx=x*x,yy=y*y,zz=z*z; const xy=x*y,xz=x*z,yz=y*z; const wx=w*x,wy=w*y,wz=w*z;
      return [
        [1-2*(yy+zz), 2*(xy-wz),  2*(xz+wy)],
        [2*(xy+wz),   1-2*(xx+zz),2*(yz-wx)],
        [2*(xz-wy),   2*(yz+wx),  1-2*(xx+yy)]
      ];
    }
    function eulerToMatrix(alpha,beta,gamma){
      const z=alpha*RAD,x=beta*RAD,y=gamma*RAD;
      const cZ=Math.cos(z),sZ=Math.sin(z), cX=Math.cos(x),sX=Math.sin(x), cY=Math.cos(y),sY=Math.sin(y);
      return [
        [ cZ*cY - sZ*sX*sY,   -cX*sZ,           cY*sZ*sX + cZ*sY ],
        [ cY*sZ + cZ*sX*sY,    cZ*cX,           sZ*sY - cZ*cY*sX ],
        [ -cX*sY,              sX,              cX*cY            ]
      ];
    }
    function extractYPR(M){
      const r11=M[0][0], r12=M[0][1], r13=M[0][2];
      const r21=M[1][0], r22=M[1][1], r23=M[1][2];
      const r31=M[2][0], r32=M[2][1], r33=M[2][2];
      const pitch = Math.asin(-r31);
      const roll  = Math.atan2(r32, r33);
      const yaw   = Math.atan2(r21, r11);
      return { yaw: yaw*DEG, pitch: pitch*DEG, roll: roll*DEG };
    }
    function enuVector(lat,lon,lat2,lon2){
      const φ1=lat*RAD, φ2=lat2*RAD, dλ=(lon2-lon)*RAD;
      return [ R * dλ * Math.cos((φ1+φ2)/2), R * (φ2-φ1), 0 ];
    }
    function bearingBetween(lat1,lon1,lat2,lon2){
      const φ1=toRad(lat1), φ2=toRad(lat2), Δλ=toRad(lon2-lon1);
      const y=Math.sin(Δλ)*Math.cos(φ2), x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
      return ((Math.atan2(y,x)*DEG)+360)%360;
    }
    function haversine(lat1,lon1,lat2,lon2){
      const dφ=toRad(lat2-lat1), dλ=toRad(lon2-lon1);
      const a=Math.sin(dφ/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*sin2(dλ/2);
      return 2*R*Math.asin(Math.sqrt(a));
      function sin2(x){ const s=Math.sin(x); return s*s; }
    }
    function toXY(lat,lon,lat0){ const x=(lon*RAD)*Math.cos(lat0*RAD)*R, y=(lat*RAD)*R; return {x,y}; }
    function nearestPointOnTrack(p,track){
      let best={lat:track[0].lat,lon:track[0].lon,distM:Infinity,segIndex:0};
      const lat0=p.lat, P=toXY(p.lat,p.lon,lat0);
      for(let i=0;i<track.length-1;i++){
        const A=toXY(track[i].lat,track[i].lon,lat0), B=toXY(track[i+1].lat,track[i+1].lon,lat0);
        const ABx=B.x-A.x, ABy=B.y-A.y, APx=P.x-A.x, APy=P.y-A.y;
        const ab2=ABx*ABx + ABy*ABy || 1; let t=(APx*ABx + APy*ABy)/ab2; t=Math.max(0,Math.min(1,t));
        const Qx=A.x+t*ABx, Qy=A.y+t*ABy;
        const lon=(Qx/(R*Math.cos(lat0*RAD)))*(180/Math.PI), lat=(Qy/R)*(180/Math.PI);
        const d=haversine(p.lat,p.lon,lat,lon);
        if(d<best.distM) best={lat,lon,distM:d,segIndex:i};
      } return best;
    }
    function clamp(v,min,max){ return Math.min(max,Math.max(min,v)); }

    /* Strelica: set boje */
    function setArrowMode(mode){
      arrowEl.classList.remove('warn','bad');
      arrowEl.style.filter = (mode==='bad') ? 'drop-shadow(0 0 10px rgba(228,71,71,.45))' :
                             (mode==='warn')? 'drop-shadow(0 0 10px rgba(242,193,78,.35))' : 'drop-shadow(0 10px 14px rgba(0,0,0,.35))';
      if(mode==='ok'){ /* default zelena */ }
      else if(mode==='warn'){ arrowEl.classList.add('warn'); }
      else if(mode==='bad'){ arrowEl.classList.add('bad'); }
    }
    function showMini(){ mini.hidden=false; }
    function hideMini(){ mini.hidden=true; }
    function setMiniColor(mode){
      miniNeedle.classList.remove('warn','bad');
      if(mode==='ok') { /* zelena */ }
      else if(mode==='warn') miniNeedle.classList.add('warn');
      else if(mode==='bad') miniNeedle.classList.add('bad');
    }

    /* Mrvice */
    function loadCrumbs(){ try{ breadcrumbs=JSON.parse(localStorage.getItem('ma_crumbs')||'[]')||[]; }catch{ breadcrumbs=[]; } }
    function saveCrumbs(){ try{ localStorage.setItem('ma_crumbs', JSON.stringify(breadcrumbs)); }catch{} }
    function pushCrumb(lat,lon,acc){ const c={lat,lon,t:Date.now(),acc:acc??null}; breadcrumbs.push(c); lastCrumb=c; if(breadcrumbs.length>2000) breadcrumbs.shift(); saveCrumbs(); }
    function maybeAddCrumb(lat,lon,acc){
      if(!Number.isFinite(lat)||!Number.isFinite(lon)) return;
      if(acc!=null && acc>CRUMB_MAX_ACC) return;
      const now=Date.now(); if(!lastCrumb){ pushCrumb(lat,lon,acc); return; }
      const dist=haversine(lastCrumb.lat,lastCrumb.lon,lat,lon); const dt=now-(lastCrumb.t||0);
      if(dist>=CRUMB_MIN_DIST || dt>=CRUMB_MIN_INTERVAL_MS) pushCrumb(lat,lon,acc);
    }
    loadCrumbs(); if(breadcrumbs.length) lastCrumb=breadcrumbs.at(-1);

    /* Rezervna kazeta: world yaw iz matrice */
    function deviceWorldYPR(){ if(!lastMatrix) return {yaw:0,pitch:0,roll:0}; return extractYPR(lastMatrix); }

    /* Otvaranje strelice + senzori */
    function openArrow(){
      // AOS
      try{
        if('AbsoluteOrientationSensor' in window){
          const aos=new AbsoluteOrientationSensor({frequency:30, referenceFrame:'device'});
          aos.addEventListener('reading', ()=>{
            const [qx,qy,qz,qw]=aos.quaternion;
            lastMatrix=quatToMatrix(qx,qy,qz,qw);
          });
          aos.start(); useAOS=true;
        }
      }catch(e){ useAOS=false; }
      // Fallback: DeviceOrientation
      if(!useAOS){
        if(typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function'){
          const btn=document.createElement('button'); btn.textContent='Omogući kompas (iOS)'; btn.className='btn ghost';
          panelArrow.querySelector('.compass-wrap').appendChild(btn);
          btn.addEventListener('click', async ()=>{
            try{ const state=await DeviceOrientationEvent.requestPermission();
              if(state==='granted'){ window.addEventListener('deviceorientation', onOrient3D, true); btn.remove(); }
            }catch(e){ btn.remove(); }
          }, {once:true});
        } else { window.addEventListener('deviceorientation', onOrient3D, true); }
      }
      const urlParam=new URL(location.href).searchParams.get('gpx'); if(urlParam) loadGpxFromUrl(urlParam);
    }
    function onOrient3D(e){
      if(e.alpha==null||e.beta==null||e.gamma==null) return;
      lastMatrix=eulerToMatrix(e.alpha,e.beta,e.gamma);
    }

    /* GPX učitavanje */
    loadGpxBtn?.addEventListener('click', async ()=>{
      const f=gpxInput?.files?.[0]; if(!f){ trackStatusPill.textContent='GPX: nema datoteke'; return; }
      try{ const txt=await f.text(); gpxTrack=parseGpxToTrack(txt); afterGpxLoaded(`GPX (file): ${gpxTrack.length} točaka`); }
      catch(e){ trackStatusPill.textContent='GPX: greška pri učitavanju'; console.error(e); }
    });
    loadUrlBtn?.addEventListener('click', async ()=>{
      const url=gpxUrl.value.trim(); if(!url){ trackStatusPill.textContent='GPX URL: prazno'; return; }
      await loadGpxFromUrl(url);
    });
    async function loadGpxFromUrl(url){
      try{
        const res=await fetch(url,{mode:'cors'}); if(!res.ok) throw new Error('HTTP '+res.status);
        const txt=await res.text(); gpxTrack=parseGpxToTrack(txt); afterGpxLoaded(`GPX (URL): ${gpxTrack.length} točaka`);
      }catch(e){ trackStatusPill.textContent='GPX URL: ne mogu učitati (CORS?)'; console.error(e); }
    }
    function parseGpxToTrack(xml){
      const dom=new DOMParser().parseFromString(xml,'application/xml');
      let pts=[...dom.querySelectorAll('trkpt')].map(n=>({lat:+n.getAttribute('lat'), lon:+n.getAttribute('lon')}));
      if(!pts.length){ pts=[...dom.querySelectorAll('rtept')].map(n=>({lat:+n.getAttribute('lat'), lon:+n.getAttribute('lon')})); }
      return pts.filter(p=>Number.isFinite(p.lat)&&Number.isFinite(p.lon));
    }
    function afterGpxLoaded(label){
      if(!gpxTrack || gpxTrack.length<2){ trackStatusPill.textContent='GPX: premalo točaka'; return; }
      trackStatusPill.textContent=label;
      onTrackChip.textContent='🧭 status: GPX spreman — klikni “Pokreni praćenje”';
      offDistChip.textContent='↔︎ udaljenost: —';
      toggleTrackBtn.classList.add('alt'); setTimeout(()=>toggleTrackBtn.classList.remove('alt'),1400);
    }

    /* Praćenje / GPS */
    toggleTrackBtn?.addEventListener('click', ()=>{
      alertMeters=Math.max(5, Number(alertMetersInput.value)||30);
      if(watchId==null){
        if(!gpxTrack || gpxTrack.length<2){ trackStatusPill.textContent='GPX: učitaj trag prvo'; return; }
        startGeoWatch(); toggleTrackBtn.textContent='Zaustavi praćenje';
      } else { stopGeoWatch(); toggleTrackBtn.textContent='Pokreni praćenje'; }
    });

    function startGeoWatch(){
      try{
        watchId=navigator.geolocation.watchPosition(onPos,onGeoErr,{enableHighAccuracy:true, maximumAge:1000, timeout:10000});
        trackStatusPill.textContent='GPS: praćenje uključeno';
        offBeepArmed=true; showMini();
      }catch(e){ trackStatusPill.textContent='GPS: ne mogu pokrenuti'; }
    }
    function stopGeoWatch(){
      if(watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
      trackStatusPill.textContent='GPS: zaustavljeno'; hideMini(); hideGpsBanner(); stopTapeTick();
      lastFix=null;
    }
    function onGeoErr(err){
      trackStatusPill.textContent='GPS greška: '+(err?.message||'');
      if(!gpsLostSince) gpsLostSince=Date.now();
      showGpsBanner(); maybeAskForTape();
    }
    function showGpsBanner(){ gpsBanner.style.display='flex'; }
    function hideGpsBanner(){ gpsBanner.style.display='none'; gpsLostSince=null; }
    bannerHide?.addEventListener('click', hideGpsBanner);
    function maybeAskForTape(){
      if(hbOn || !gpsLostSince) return;
      const noFixMs=Date.now()-gpsLostSince;
      if(noFixMs>=GPS_LOST_MODAL_AFTER_MS && tapeModalBack.style.display!=='grid'){ tapeModalBack.style.display='grid'; }
    }
    tapeCancel?.addEventListener('click', ()=>{ tapeModalBack.style.display='none'; });
    tapeConfirm?.addEventListener('click', ()=>{ tapeModalBack.style.display='none'; startTapeMode(); });

    // Distance smoothing (LPF)
    let distLP=null;
    const DIST_ALPHA=0.35;

    // Pop-up: otvaranje/zatvaranje
    openPopupBtn?.addEventListener('click', ()=>{
      try{
        const feat='width=300,height=180,menubar=0,toolbar=0,location=0,status=0';
        miniWin = window.open('', 'strelicaPopup', feat);
        if(!miniWin){ alert('Preglednik je blokirao pop-up. Dozvoli pop-up za ovu stranicu.'); return; }
        miniWin.document.write(`
          <!doctype html><html><head>
            <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
            <title>Strelica</title>
            <style>
              body{margin:0;background:#0e0f10;color:#e9eef2;font:500 14px/1.4 system-ui,Segoe UI,Roboto,Arial,sans-serif;display:grid;place-items:center;height:100vh}
              .wrap{width:260px}
              .ring{width:100%;height:64px;border-radius:14px;padding:8px;background:rgba(18,20,22,.95);border:1px solid #1f2327;box-shadow:0 8px 24px rgba(0,0,0,.35);display:grid;place-items:center}
              .needle{width:56px;height:8px;background:#2aa96b;border-radius:5px;transform-origin:0% 50%;transition:transform .12s ease-out}
              .needle.warn{background:#e09f3e}.needle.bad{background:#e44747}
              .info{text-align:center;font-size:12px;color:#9aa6b2;margin-top:6px}
              .title{font-size:12px;color:#9aa6b2;margin:0 0 6px}
              button{appearance:none;border:0;background:#2b2f36;color:#fff;border-radius:8px;padding:.4em .6em;font-weight:700;cursor:pointer}
              .row{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
            </style>
          </head><body>
            <div class="wrap">
              <p class="title">Pametna strelica — mini</p>
              <div class="ring"><div id="pNeedle" class="needle"></div></div>
              <div class="info"><span id="pMeters">— m</span></div>
              <div class="row"><span id="pStatus">•</span><button onclick="window.close()">Zatvori</button></div>
            </div>
            <script>
              const needle=document.getElementById('pNeedle');
              const meters=document.getElementById('pMeters');
              const statusEl=document.getElementById('pStatus');
              function setMode(mode){
                needle.classList.remove('warn','bad');
                if(mode==='warn') needle.classList.add('warn');
                else if(mode==='bad') needle.classList.add('bad');
              }
              window.addEventListener('message',(ev)=>{
                try{
                  const d=ev.data||{};
                  if(typeof d.bearing==='number'){ needle.style.transform='rotate('+d.bearing+'deg)'; }
                  if(typeof d.meters==='number'){ meters.textContent = Math.round(d.meters)+' m'; }
                  if(d.mode){ setMode(d.mode); statusEl.textContent = d.mode==='ok'?'Na tragu ✓':(d.mode==='warn'?'Blizu ruba':'Izvan traga'); }
                }catch(e){}
              });
            </script>
          </body></html>
        `);
        miniWin.document.close();
        openPopupBtn.style.display='none';
        closePopupBtn.style.display='inline-block';
      }catch(e){
        console.error(e);
        alert('Pop-up nije mogao biti otvoren.');
      }
    });
    closePopupBtn?.addEventListener('click', ()=>{
      if(miniWin && !miniWin.closed){ miniWin.close(); }
      miniWin=null;
      closePopupBtn.style.display='none';
      openPopupBtn.style.display='inline-block';
    });
    function sendToPopup(bearing, meters, mode){
      try{
        if(miniWin && !miniWin.closed){
          miniWin.postMessage({bearing, meters, mode}, '*');
        }
      }catch(e){}
    }

    function onPos(pos){
      hideGpsBanner();
      if(hbOn){ hbOn=false; stopTapeTick(); }

      const lat=pos.coords.latitude, lon=pos.coords.longitude, acc=pos.coords.accuracy;
      lastKnownLat=lat; lastKnownLon=lon;

      // heading kazeta (svake 1 s)
      const now=Date.now();
      if(now-lastHeadingSampleAt>=HEADING_SAMPLE_MS){
        lastHeadingSampleAt=now;
        const {yaw}=deviceWorldYPR();
        const spd=Number.isFinite(pos.coords.speed)?Math.max(0,pos.coords.speed):null;
        headingTape.push({t:now,yawWorldDeg:((yaw%360)+360)%360, speed:spd});
        if(headingTape.length>7200) headingTape.shift();
      }

      // mrvice
      maybeAddCrumb(lat,lon,acc);

      if(!gpxTrack || gpxTrack.length<2){ arrowEl.style.opacity='1'; return; }

      // najbliža točka staze
      const nearest=nearestPointOnTrack({lat,lon}, gpxTrack);

      // ignoriraj ekstremno lošu točnost
      if(Number.isFinite(acc) && acc>50){
        onTrackChip.textContent='🧭 status: GPS netočan (>50 m)';
        return;
      }

      // distancija (LPF)
      let dist=nearest.distM;
      distLP = distLP==null ? dist : (DIST_ALPHA*dist + (1-DIST_ALPHA)*distLP);
      updateOffTrackUI(distLP);

      // cilj yaw = prema najbližoj točki staze
      const vWorld=enuVector(lat,lon,nearest.lat,nearest.lon);
      const yawTarget=(Math.atan2(vWorld[0], vWorld[1])*DEG+360)%360;

      // heading uređaja ili GPS COG
      const useGPSCourse = Number.isFinite(pos.coords.speed) && pos.coords.speed>=COG_MIN_SPEED && lastFix;
      let yawDevice = deviceWorldYPR().yaw;
      if(useGPSCourse){
        const cog = bearingBetween(lastFix.lat,lastFix.lon,lat,lon);
        yawDevice = (0.7*cog + 0.3*yawDevice + 360)%360;
      }
      lastFix = {lat,lon,t:now};

      // delta yaw s deadband/cap
      let dYaw = ((yawTarget - yawDevice + 540) % 360) - 180;
      if(Math.abs(dYaw) < DEAD_BAND_DEG) dYaw = 0;
      const maxStep = MAX_ROT_SPEED_DPS / 60;
      dYaw = clamp(dYaw, -maxStep, maxStep);

      // glatko
      let delta = dYaw - lastAngleDeg; if(delta>180) delta-=360; if(delta<-180) delta+=360;
      lastAngleDeg=(lastAngleDeg + SMOOTHING*delta + 360)%360;

      // 3D transform
      const {pitch, roll}=deviceWorldYPR();
      arrowEl.style.opacity='1';
      arrowEl.style.transform = `rotateX(${-pitch}deg) rotateY(${-roll}deg) rotateZ(${lastAngleDeg}deg)`;

      // mini HUD
      miniMeters.textContent=`${distLP.toFixed(0)} m`;
      const miniRot = Math.round(lastAngleDeg/5)*5;
      miniNeedle.style.transform=`rotate(${miniRot}deg)`;
      const mode = distLP<=OK_THRESHOLD_M ? 'ok' : (distLP<=YELLOW_MAX_M ? 'warn' : 'bad');
      setMiniColor(mode);

      // pop-up sync
      sendToPopup(miniRot, distLP, mode);

      // backtrack
      if(backtrackOn) doBacktrackStep(lat,lon);
    }

    function updateOffTrackUI(dist){
      if(dist<=OK_THRESHOLD_M){ setArrowMode('ok'); onTrackChip.textContent='🧭 status: na tragu ✓'; }
      else if(dist<=alertMeters){ setArrowMode('warn'); onTrackChip.textContent='🧭 status: blizu ruba'; }
      else{ setArrowMode('bad'); onTrackChip.textContent='🧭 status: izvan traga'; if(offBeepArmed){ offBeepArmed=false; beep3(); setTimeout(()=>offBeepArmed=true,8000); } }
      offDistChip.textContent=`↔︎ udaljenost: ${dist.toFixed(0)} m`;
    }

    // Backtrack
    function findNearestCrumbIndex(lat,lon){
      if(!breadcrumbs.length||!Number.isFinite(lat)||!Number.isFinite(lon)) return 0;
      let bestI=0,bestD=Infinity;
      for(let i=0;i<breadcrumbs.length;i++){ const d=haversine(lat,lon,breadcrumbs[i].lat,breadcrumbs[i].lon); if(d<bestD){ bestD=d; bestI=i; } }
      return bestI;
    }
    function doBacktrackStep(lat,lon){
      if(breadcrumbs.length===0){ return; }
      if(backIdx==null){ backIdx=findNearestCrumbIndex(lat,lon); }
      if(backIdx<=0){ onTrackChip.textContent='🧭 status: stigao na start'; setArrowMode('ok'); offDistChip.textContent='↔︎ udaljenost: 0 m'; return; }
      const tgt=breadcrumbs[backIdx]; const distM=haversine(lat,lon,tgt.lat,tgt.lon); updateOffTrackUI(distM);

      const vWorld=enuVector(lat,lon,tgt.lat,tgt.lon);
      const yawTarget=(Math.atan2(vWorld[0], vWorld[1])*DEG+360)%360;

      let yawDevice = deviceWorldYPR().yaw;
      if(lastFix){ const cog=bearingBetween(lastFix.lat,lastFix.lon,lat,lon); yawDevice=(0.7*cog+0.3*yawDevice+360)%360; }

      let dYaw=((yawTarget - yawDevice + 540) % 360) - 180;
      if(Math.abs(dYaw)<DEAD_BAND_DEG) dYaw=0;
      const maxStep = MAX_ROT_SPEED_DPS/60;
      dYaw=clamp(dYaw,-maxStep,maxStep);

      let delta=dYaw - lastAngleDeg; if(delta>180) delta-=360; if(delta<-180) delta+=360;
      lastAngleDeg=(lastAngleDeg + SMOOTHING*delta + 360)%360;

      const {pitch,roll}=deviceWorldYPR();
      arrowEl.style.transform=`rotateX(${-pitch}deg) rotateY(${-roll}deg) rotateZ(${lastAngleDeg}deg)`;
      const miniRot = Math.round(lastAngleDeg/5)*5;
      miniNeedle.style.transform=`rotate(${miniRot}deg)`;
      miniMeters.textContent=`${Math.round(distM)} m`;

      if(distM<=AUTO_ADVANCE_RADIUS){ backIdx=Math.max(0, backIdx-1); }
      onTrackChip.textContent='🧭 status: povratak istim putem';

      // pop-up sync
      const mode = distM<=OK_THRESHOLD_M ? 'ok' : (distM<=YELLOW_MAX_M ? 'warn' : 'bad');
      sendToPopup(miniRot, distM, mode);
    }
    qs('#btStart')?.addEventListener('click', ()=>{
      if(!breadcrumbs.length){ qs('#btStatus').textContent='↩︎ Povratak: nema mrvica'; return; }
      backtrackOn=true; backIdx=findNearestCrumbIndex(lastKnownLat??breadcrumbs.at(-1)?.lat,lastKnownLon??breadcrumbs.at(-1)?.lon);
      qs('#btStatus').textContent='↩︎ Povratak: uključen';
    });
    qs('#btStop')?.addEventListener('click', ()=>{ backtrackOn=false; backIdx=null; qs('#btStatus').textContent='↩︎ Povratak: isključen'; });

    // Rezervni mod (krajnja nužda)
    function startTapeMode(){
      if(!headingTape.length){ onTrackChip.textContent='🧭 status: bez GPS-a — nema zapisa'; return; }
      hbOn=true; hbIdx=headingTape.length-1; onTrackChip.textContent='🧭 status: bez GPS-a — orijentacijski povratak';
      if(tapeTick) clearInterval(tapeTick);
      tapeTick=setInterval(()=>{
        if(!hbOn || hbIdx==null || headingTape.length===0) return;
        const sample=headingTape[hbIdx]; if(!sample){ stopTapeTick(); return; }
        const targetYaw=(sample.yawWorldDeg+180)%360;
        const {yaw,pitch,roll}=deviceWorldYPR();
        let dYaw=((targetYaw - yaw + 540) % 360) - 180;
        if(Math.abs(dYaw)<DEAD_BAND_DEG) dYaw=0;
        const maxStep = MAX_ROT_SPEED_DPS/60; dYaw=clamp(dYaw,-maxStep,maxStep);
        let delta=dYaw - lastAngleDeg; if(delta>180) delta-=360; if(delta<-180) delta+=360;
        lastAngleDeg=(lastAngleDeg + SMOOTHING*delta + 360)%360;
        arrowEl.style.transform=`rotateX(${-pitch}deg) rotateY(${-roll}deg) rotateZ(${lastAngleDeg}deg)`;
        const miniRot = Math.round(lastAngleDeg/5)*5;
        miniNeedle.style.transform=`rotate(${miniRot}deg)`;
        offDistChip.textContent='↔︎ udaljenost: —';
        hbIdx=Math.max(0,hbIdx-1);

        // pop-up sync
        sendToPopup(miniRot, NaN, 'warn');
      }, 220);
    }
    function stopTapeTick(){ if(tapeTick){ clearInterval(tapeTick); tapeTick=null; } }

    // UI close
    qs('#arrowClose')?.addEventListener('click', ()=>{ hide(panelArrow); window.removeEventListener('deviceorientation', onOrient3D, true); stopGeoWatch(); });

    // Visibility: štedi bateriju
    document.addEventListener('visibilitychange', ()=>{
      if(document.visibilityState==='hidden'){
        if(watchId!=null){ navigator.geolocation.clearWatch(watchId); watchId=null; }
        if(!useAOS){ window.removeEventListener('deviceorientation', onOrient3D, true); }
      } else {
        if(!useAOS){ window.addEventListener('deviceorientation', onOrient3D, true); }
        if(gpxTrack && gpxTrack.length>1 && toggleTrackBtn?.textContent?.includes('Zaustavi')) startGeoWatch();
      }
    });

    /* Banner i modal */
    bannerHide?.addEventListener('click', hideGpsBanner);
    tapeCancel?.addEventListener('click', ()=>{ tapeModalBack.style.display='none'; });
    tapeConfirm?.addEventListener('click', ()=>{ tapeModalBack.style.display='none'; startTapeMode(); });

    /* Offline savjeti, dnevnik, checklista */
    const logView=qs('#logView');
    function refreshLogView(){ const saved=localStorage.getItem('ma_log')||''; if(logView) logView.textContent=saved?saved:'—'; }
    refreshLogView?.();
    qs('#logSave')?.addEventListener('click', ()=>{
      const r=qs('#logRoute').value.trim(), t=qs('#logStart').value, n=qs('#logPeople').value, note=qs('#logNote').value.trim();
      const entry=`Ruta: ${r||'—'}\nPolazak: ${t||'—'}\nOsoba: ${n||'—'}\nNapomena: ${note||'—'}\nVrijeme: ${new Date().toLocaleString()}`;
      localStorage.setItem('ma_log', entry); refreshLogView();
    });
    qs('#logClear')?.addEventListener('click', ()=>{ localStorage.removeItem('ma_log'); refreshLogView(); });
    qs('#checkReset')?.addEventListener('click', ()=>{ qs('#checkList')?.querySelectorAll('input[type=checkbox]')?.forEach(c=>c.checked=false); });

    /* Dnevno svjetlo */
    const sunLeft=qs('#sunLeft'); let sunTimer=null;
    qs('#sunStart')?.addEventListener('click', ()=>{
      const t=qs('#sunsetTime').value; if(!t){ sunLeft.textContent='Preostalo: — (postavi zalazak)'; return; }
      const [hh,mm]=t.split(':').map(Number); const tgt=new Date(); tgt.setHours(hh,mm,0,0);
      clearInterval(sunTimer);
      const tick=()=>{ const ms=tgt - new Date(); if(ms<=0){ clearInterval(sunTimer); sunLeft.textContent='Preostalo: 0h 0m'; return; }
        const m=Math.floor(ms/60000), h=Math.floor(m/60), min=m%60; sunLeft.textContent=`Preostalo: ${h}h ${min}m`; };
      tick(); sunTimer=setInterval(tick,15000);
    });
    qs('#sunStop')?.addEventListener('click', ()=>{ clearInterval(sunTimer); sunLeft.textContent='Preostalo: —'; });

    /* SOS */
    let sosCtx=null, sosOsc=null, sosGain=null, sosPlay=false;
    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
    function sosBeep(freq=1000,dur=150){ return new Promise(res=>{ try{
      sosCtx=sosCtx||new (window.AudioContext||window.webkitAudioContext)();
      const t=sosCtx.currentTime; sosOsc=sosCtx.createOscillator(); sosGain=sosCtx.createGain();
      sosOsc.frequency.value=freq; sosOsc.type='sine'; sosGain.gain.value=0.0001; sosOsc.connect(sosGain); sosGain.connect(sosCtx.destination);
      sosOsc.start(); sosGain.gain.exponentialRampToValueAtTime(0.25, t+0.02);
      sosGain.gain.setValueAtTime(0.25, t+dur/1000-0.03); sosGain.gain.exponentialRampToValueAtTime(0.0001, t+dur/1000);
      sosOsc.stop(t+dur/1000+0.02); setTimeout(res, dur);
    }catch(e){ res(); } }); }
    async function playSOS(){
      if(sosPlay) return; sosPlay=true;
      while(sosPlay){
        await sosBeep(900,150); await sleep(120);
        await sosBeep(900,150); await sleep(120);
        await sosBeep(900,150); await sleep(300);
        await sosBeep(900,450); await sleep(150);
        await sosBeep(900,450); await sleep(150);
        await sosBeep(900,450); await sleep(300);
        await sosBeep(900,150); await sleep(120);
        await sosBeep(900,150); await sleep(120);
        await sosBeep(900,150); await sleep(900);
      }
    }
    function stopSOS(){ sosPlay=false; }
    qs('#playSOS')?.addEventListener('click', playSOS);
    qs('#stopSOS')?.addEventListener('click', stopSOS);

    /* Mini widget drag */
    (function(){
      const mini=qs('#miniCompass'); if(!mini) return;
      let sx=0,sy=0,ox=mini.offsetLeft,oy=mini.offsetTop,drag=false;
      function start(ev){ drag=true; const pt=ev.touches?ev.touches[0]:ev; sx=pt.clientX; sy=pt.clientY; ox=mini.offsetLeft; oy=mini.offsetTop; ev.preventDefault(); }
      function move(ev){ if(!drag) return; const pt=ev.touches?ev.touches[0]:ev; const dx=pt.clientX-sx, dy=pt.clientY-sy; mini.style.left=Math.max(6,ox+dx)+'px'; mini.style.top=Math.max(6,oy+dy)+'px'; }
      function end(){ drag=false; }
      mini.addEventListener('mousedown', start); mini.addEventListener('touchstart', start, {passive:false});
      window.addEventListener('mousemove', move); window.addEventListener('touchmove', move, {passive:false});
      window.addEventListener('mouseup', end); window.addEventListener('touchend', end);
    })();

    /* Beep pri off-tracku */
    function beep3(){
      try{
        audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
        const sequence = [900,900,900];
        let t = audioCtx.currentTime;
        sequence.forEach((f,i)=>{
          const osc=audioCtx.createOscillator();
          const gain=audioCtx.createGain();
          osc.type='sine'; osc.frequency.value=f; osc.connect(gain); gain.connect(audioCtx.destination);
          gain.gain.setValueAtTime(0.0001, t);
          gain.gain.exponentialRampToValueAtTime(0.25, t+0.02);
          osc.start(t);
          osc.stop(t+0.15);
          gain.gain.exponentialRampToValueAtTime(0.0001, t+0.15);
          t += 0.27;
        });
      }catch(e){}
    }
  </script>
</body>
</html>
