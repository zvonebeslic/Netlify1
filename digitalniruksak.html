<!DOCTYPE html>
<html lang="hr">
<head>
  <!-- =========================================================
       META / PWA / OSNOVNO (SEO: lang=hr, title, description)
       ========================================================= -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Mountain Adventures — Digitalni ruksak</title>
  <meta name="description" content="Digitalni ruksak: vodiči, kamera, kompas s fiksnim N/E/S/W (igla fiksna, brojčanik se rotira), strelica prema najbližoj točki GPX staze, povratna ruta (backtrack), savjeti izvan mreže, SOS, meteoprognoza, noćno nebo i terenski vodič.">
  <link rel="icon" href="images/mountain-adventures.svg" type="image/svg+xml">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0e0f10">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="images/mountain-adventures-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="season.css" />
  <!-- =========================================================
       STILOVI (format: jedno svojstvo u jednom redu)
       ========================================================= -->
  <style>
    :root {
      --bg: #0e0f10;
      --fg: #e9eef2;
      --muted: #9aa6b2;
      --card: #121416;
      --line: #1f2327;
      --accent: #2aa96b;
      --accent-2: #3aa0ff;
      --accent-3: #e44747;
      --ok: #86d486;
      --warn: #f2c14e;
      --bad: #ff6b6b;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font: 500 15px/1.5 Montserrat, system-ui, Segoe UI, Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    /* =========================================================
       NAVBAR
       ========================================================= */
    .navbar {
      position: fixed;
      z-index: 1000;
      top: 0;
      right: 0;
      left: 0;
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 15px;
      border-bottom: 1px solid var(--line);
      background: rgba(0, 0, 0, 0.55);
    }
    .navbar-left img {
      position: relative;
      height: 16px;
      width: 24px;
      cursor: pointer;
    }
    .navbar-left img:hover::after {
      position: absolute;
      top: 30px;
      left: 0;
      content: attr(data-tooltip);
      padding: 4px 8px;
      border-radius: 5px;
      background: #ffffff;
      color: #000;
      font-size: 12px;
      white-space: nowrap;
      box-shadow: 0 0 6px rgba(0, 0, 0, .2);
    }
    .navbar-center {
      flex: 1;
      display: flex;
      justify-content: center;
      z-index: 1;
      transform: translateY(12px);
    }
    .search-container {
      width: 250px;
      position: relative;
      padding-top: 10px;
      z-index: 1;
    }
    .search-wrapper {
      position: relative;
      z-index: 2;
      width: 100%;
      height: 30px; /* ili 55px ako dodaješ prostor za sliku */
      background: #fff;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
      padding: 0 15px;
      display: flex;
      align-items: flex-end;
      justify-content: center;
      overflow: visible;
      border-radius: 20px;
    }
    /* === UKRASNA PLANINA IZNAD TRAŽILICE === */
    .search-top-decoration {
      position: absolute;
      top: -212.7px;
      left: 108px;
      width: 1600%;
      height: 30px;
      object-fit: cover;
      display: block;
      z-index: -10;
      transform: scale(19);
      transform-origin: top center;
      pointer-events: none;
    }
    /* === UNUTARNJI INPUT POLJE === */
    .mountain-search {
      width: 100%;
      padding: 14px 40px 8px 12px;
      font-size: 14px;
      border: none;
      background: transparent;
      color: #333;
      outline: none;
    }
    /* === IKONA UNUTAR TRAŽILICE === */
    .search-wrapper img {
      position: absolute;
      right: 12px;
      bottom: 8px;
      width: 19px;
      height: 19px;
      pointer-events: none;
    }
    .navbar-right {
      display: flex;
      flex-direction: column;
      gap: 5px;
      padding: 8px;
      border: 1px solid rgba(255, 255, 255, .35);
      border-radius: 8px;
      background: rgba(255, 255, 255, .05);
      cursor: pointer;
    }
    .burger-line {
      width: 26px;
      height: 3px;
      border-radius: 2px;
      background: #fff;
    }
    .menu-overlay {
      position: fixed;
      top: 70px;
      right: 0;
      width: 35vw;
      background-color: rgba(17, 17, 17, 0.95);
      color: white;
      padding: 20px;
      display: none;
      flex-direction: column;
      align-items: flex-start;
      z-index: 9999;
    }
    .menu-overlay.open { display: flex; }
    .menu-overlay a {
      margin: 10px 0;
      text-decoration: none;
      color: white;
      font-size: 1.1em;
      font-family: Arial, sans-serif;
    }
    header.page-head {
      padding: 10px 14px;
      border-bottom: 1px solid var(--line);
      margin-top: 70px;
    }
    header.page-head h1 {
      margin: 0;
      font-size: 18px;
      text-align: center;
    }
    header.page-head .intro {
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 10px;
      text-align: center;
    }
    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 14px 28px;
    }
    .tools-grid {
      margin: 10px 0 0;
      display: grid;
      gap: 14px;
      grid-template-columns: repeat(auto-fill, minmax(310px, 1fr));
    }
    .tool-card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
    }
    .eyebrow {
      font-size: 11px;
      color: var(--muted);
      letter-spacing: .3px;
      text-transform: uppercase;
    }
    .tool-card h3 { margin: 5px 0 20px; font-size: 16px; }
    .tool-card p, .tool-card ul { color: var(--muted); font-size: 13px; }
    .tool-card ul { margin: 6px 0 8px 18px; padding: 0; }
    .btn-row { display: flex; gap: 8px; flex-wrap: wrap; }
    .btn {
      appearance: none;
      border: 0;
      border-radius: 10px;
      padding: .55em .9em;
      font-weight: 700;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      font-size: 13px;
    }
    .btn.ghost { background: #2b2f36; }
    .btn.alt { background: var(--accent-2); }
    .btn.alert { background: var(--accent-3); }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid var(--line);
      padding: .3em .6em;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
    }
    .ok { color: var(--ok); }
    .warn { color: var(--warn); }
    .bad { color: var(--bad); }
    .hint { color: var(--muted); font-size: 12px; }
    section.tool-panel {
      margin-top: 18px;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
    }
    /* da panel ‘stane’ ispod fiksnog navbara kada se scroll-a */
    .tool-panel { scroll-margin-top: 84px; }
    section.tool-panel h4 { margin: 0 0 15px; font-size: 16px; }
    .divider { height: 1px; background: var(--line); margin: 10px 0 12px; }
    .two-col { display: grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 800px) {
      .two-col { grid-template-columns: .9fr 1.1fr; }
    }
    /* ---------------- Kamera ---------------- */
    .camera-wrap { display: grid; gap: 10px; }
    video#camVideo {
      width: 100%;
      aspect-ratio: 9 / 16;
      max-height: 72vh;
      background: #000;
      border-radius: 10px;
    }
    canvas#camCanvas { display: none; }
    .toolbar { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: #a33; box-shadow: 0 0 6px #600; }
    .dot.ok { background: #3c3; box-shadow: 0 0 8px #2a2; }
    #camMsg { min-width: 200px; color: var(--muted); font-size: 12px; }
    #camThumb { max-width: 220px; border-radius: 8px; border: 1px solid var(--line); }
    /* ---------------- Kompas + Libela ---------------- */
    .compass-wrap { display: grid; gap: 10px; }
    .compass-row { display: flex; gap: 14px; align-items: center; flex-wrap: wrap; }
    .compass {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      border: 1px solid var(--line);
      background: radial-gradient(closest-side, rgba(255,255,255,.06), rgba(0,0,0,0) 60%), radial-gradient(transparent 58%, #1b1f25 59%);
      display: grid;
      place-items: center;
      position: relative;
      perspective: 800px;
    }
    .compass .tick { position: absolute; inset: 8px; border-radius: 50%; border: 1px dashed #2a2f36; }
    .compass-ring {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,.18);
      box-shadow: 0 0 24px rgba(0,0,0,.25) inset;
      transform-origin: 50% 50%;
      transform: rotate(0deg);
      will-change: transform;
      backface-visibility: hidden;
    }
    .compass-ring .mark {
      position: absolute;
      font: 700 12px/1 Montserrat, system-ui;
      letter-spacing: .12em;
      color: #fff;
      text-shadow: 0 1px 2px rgba(0,0,0,.6);
      user-select: none;
    }
    .compass-ring .n { top: 4px; left: 50%; transform: translateX(-50%); color: #ff3b3b; }
    .compass-ring .s { bottom: 4px; left: 50%; transform: translateX(-50%); }
    .compass-ring .e { right: 4px; top: 50%; transform: translateY(-50%); }
    .compass-ring .w { left: 4px; top: 50%; transform: translateY(-50%); }
    .compass-ring .ticks {
      position: absolute;
      inset: 10px;
      border-radius: 50%;
      -webkit-mask: radial-gradient(transparent 56%, #000 56.3%);
      mask: radial-gradient(transparent 56%, #000 56.3%);
      background: conic-gradient(from 0deg, rgba(255,255,255,.18) 0 1deg, transparent 1deg 9deg);
    }
    .north-needle {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 4px;
      height: 120px;
      transform-origin: 50% 92%;
      transform: translate(-50%, -92%) rotate(0deg);
      filter: drop-shadow(0 0 4px rgba(255,0,0,.35));
      pointer-events: none;
    }
    .north-needle .tip {
      position: absolute;
      left: -6px;
      top: -6px;
      width: 16px;
      height: 35px;
      background: linear-gradient(#ff6464, #d30000);
      clip-path: polygon(50% 0, 100% 100%, 50% 78%, 0 100%);
      border-radius: 2px;
    }
    .target-arrow {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 40px;
      height: 80px;
      transform: translate(-50%, -50%) rotate(0deg);
      transform-origin: 50% 50%;
      transform-box: fill-box;
      will-change: transform;
      filter: drop-shadow(0 0 6px rgba(0,224,255,.5));
      opacity: 1;
      transition: opacity .25s ease;
      pointer-events: none;
    }
    .arrow3d {
      width: 68px;
      height: 12px;
      position: relative;
      transform-style: preserve-3d;
      transition: transform .14s ease-out, opacity .14s ease-out, filter .2s ease-out;
      filter: drop-shadow(0 10px 14px rgba(0,0,0,.35));
    }
    .arrow3d::after {
      content: "";
      position: absolute;
      left: 0;
      top: 2px;
      bottom: 2px;
      width: 58px;
      border-radius: 6px;
      background: linear-gradient(180deg, #36c286, #1e915f);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.2), inset 0 -1px 0 rgba(0,0,0,.2);
      transform: translateZ(0.6px);
    }
    .arrow3d::before {
      content: "";
      position: absolute;
      right: -14px;
      top: -6px;
      border-left: 14px solid #36c286;
      border-top: 12px solid transparent;
      border-bottom: 12px solid transparent;
      transform: translateZ(0.8px);
      filter: drop-shadow(0 2px 2px rgba(0,0,0,.4));
    }
    .arrow3d.warn::after { background: linear-gradient(180deg, #f4c35f, #c78f2a); }
    .arrow3d.warn::before { border-left-color: #f4c35f; }
    .arrow3d.bad::after { background: linear-gradient(180deg, #ff7a7a, #d84e4e); }
    .arrow3d.bad::before { border-left-color: #ff7a7a; }
    .level-wrap { width: 140px; display: flex; flex-direction: column; align-items: center; gap: 8px; }
    .level-ring {
      position: relative;
      width: 132px;
      height: 132px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,.18);
      box-shadow: inset 0 0 18px rgba(0,0,0,.25);
      background: radial-gradient(circle at 50% 50%, rgba(255,255,255,.06) 0 55%, transparent 56% 100%);
      overflow: hidden;
    }
    .lvl-cross { position: absolute; background: rgba(255,255,255,.18); pointer-events: none; }
    .lvl-h { left: 8%; right: 8%; top: 50%; height: 1px; transform: translateY(-0.5px); }
    .lvl-v { top: 8%; bottom: 8%; left: 50%; width: 1px; transform: translateX(-0.5px); }
    .level-bubble {
      position: absolute;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #fff;
      box-shadow: none !important;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }
    .level-readout { display: flex; gap: 8px; font: 600 11px/1.2 Montserrat, system-ui; color: #fff; opacity: .8; }
    /* ---------------- Mini HUD strelica ---------------- */
    #miniCompass {
      position: fixed;
      left: 10px;
      bottom: 10px;
      z-index: 9999;
      width: 78px;
      height: 78px;
      border-radius: 14px;
      padding: 8px;
      background: rgba(18,20,22,.9);
      border: 1px solid var(--line);
      backdrop-filter: blur(6px);
      box-shadow: 0 8px 24px rgba(0,0,0,.35);
      touch-action: none;
      user-select: none;
    }
    #miniCompass .mini-ring {
      width: 100%;
      height: 52px;
      border-radius: 999px;
      border: 1px dashed #2a2f36;
      display: grid;
      place-items: center;
      position: relative;
      overflow: hidden;
    }
    #miniCompass .mini-needle {
      width: 40px;
      height: 6px;
      background: #2aa96b;
      border-radius: 4px;
      transform-origin: 0% 50%;
      transition: transform .14s ease-out, background .2s ease-out;
    }
    #miniCompass .mini-needle.warn { background: #e09f3e; }
    #miniCompass .mini-needle.bad { background: #e44747; }
    #miniCompass .mini-info { text-align: center; font-size: 11px; color: var(--muted); margin-top: 4px; }
    #miniCompass[hidden] { display: none; }
    #targetArrow { display: none; }
    #onPathOK { display: none; }
    .hidden { display: none !important; }
    /* ---------------- Banner / Modal ---------------- */
    .banner {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: #2b2f36;
      border-top: 1px solid var(--line);
      padding: 8px 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      z-index: 10000;
    }
    .banner .msg { color: #ddd; font-size: 13px; }
    .banner .actions { margin-left: auto; display: flex; gap: 8px; }
    .modal-back {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display: none;
      place-items: center;
      z-index: 10001;
    }
    .modal {
      background: #161a1e;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 14px;
      max-width: 520px;
      width: 92%;
    }
    .modal h5 { margin: 0 0 6px; font-size: 16px; }
    .modal p { margin: 0 0 10px; color: var(--muted); font-size: 13px; }
    .modal .actions { display: flex; gap: 8px; justify-content: flex-end; }
    /* ---------------- Meteo kartice ---------------- */
    .weather-grid { display: grid; gap: 10px; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); }
    .wx-card { background: #14171b; border: 1px solid var(--line); border-radius: 10px; padding: 10px; }
    .wx-card h5 { margin: 0 0 4px; font-size: 14px; }
    .wx-meta { font-size: 12px; color: var(--muted); }
    /* ---------------- Nebo (platno) ---------------- */
    #skyCanvas {
      width: 100%;
      max-width: 520px;
      height: 300px;
      background: #020309;
      border: 1px solid var(--line);
      border-radius: 10px;
      display: block;
    }
    .sky-legend { font-size: 12px; color: var(--muted); }
    /* ---------------- Flora/Fauna vodič ---------------- */
    .id-grid { display: grid; gap: 8px; grid-template-columns: 1fr; }
    .id-row { display: flex; flex-wrap: wrap; gap: 8px; }
    .tag {
      padding: .35em .6em;
      background: #1a1d22;
      border: 1px solid var(--line);
      border-radius: 999px;
      font-size: 12px;
      color: #d8dee6;
    }
    /* === PeakCam (pc-*) — panel stilovi, bez kolizija === */
    .pc-wrap { display: grid; gap: 12px; }
    .pc-toolbar { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 8px; }
    .pc-inline { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; color: var(--muted); margin-right: 10px; }
    .pc-stage { position: relative; width: 100%; background: #000; border-radius: 12px; border: 1px solid var(--line); overflow: hidden; }
    #pc-video, #pc-overlay { width: 100%; height: auto; display: block; }
    #pc-overlay { position: absolute; inset: 0; pointer-events: none; }
    .pc-hint { position: absolute; left: 0; right: 0; top: 50%; transform: translateY(-50%); text-align: center; color: #fff; opacity: .9; padding: 10px; }
    .pc-legend { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
    .pc-attrib { font-size: 12px; color: var(--muted); }
    /* =========================================================
       FOOTER / BACK TO TOP
       ========================================================= */
    #backToTop {
      position: fixed;
      bottom: 22px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 99999;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(12px);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      outline: none;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      align-items: center;
      justify-content: center;
      transition: background 0.3s ease, transform 0.3s ease;
    }
    #backToTop:hover { background-color: rgba(255, 255, 255, 0.3); transform: translateX(-50%) scale(1.1); }
    #backToTop svg { width: 24px; height: 24px; }
    footer {
      background: #111;
      color: #ccc;
      font-family: Arial, sans-serif !important;
      text-align: center;
      padding: 20px 10px;
      font-size: 14px;
      position: relative;
      margin-top: 60px;
    }
    .footer-icons { margin: 10px 0; }
    .footer-icons svg {
      width: 32px;
      height: 32px;
      margin: 0 10px;
      vertical-align: middle;
      opacity: 0.8;
      transition: opacity 0.3s, transform 0.3s;
    }
    .footer-icons svg:hover { opacity: 1; transform: scale(1.1); }
 
  </style>
  
</head>

<body>
  <!-- === NAVIGACIJA (gore) === -->
  <div class="navbar">
    <div class="navbar-left">
      <img src="images/flag-uk.svg" alt="promjena jezika na engleski" id="language-toggle" data-tooltip="Promijeni jezik">
    </div>
    <div class="navbar-center">
      <div class="search-container">
        <div class="search-wrapper">
          <img src="images/planine-za-trazilicu.png" alt="planinski-vrhovi" class="search-top-decoration" />
          <input type="text" class="mountain-search" id="search" placeholder="Pretraži...">
          <img src="images/search.svg" alt="ikona za tražilicu">
        </div>
      </div>
    </div>
    <div class="navbar-right" id="menu-toggle">
      <div class="burger-line"></div>
      <div class="burger-line"></div>
      <div class="burger-line"></div>
    </div>
  </div>

  <!-- === HAMBURGER MENI === -->
  <div class="menu-overlay" id="menu">
    <a href="index.html" data-hr="Naslovna" data-en="Home">Naslovna</a>
    <a href="staze.html" data-hr="Staze" data-en="Trails">Staze</a>
    <a href="avantura.html" data-hr="Avantura" data-en="Adventure">Avantura</a>
    <a href="webshop.html" data-hr="Web shop" data-en="Web Shop">Web shop</a>
    <a href="planinarskevijesti.html" data-hr="Blog" data-en="Blog">Blog</a>
    <a href="digitalniruksak.html" data-hr="Digitalni ruksak" data-en="Digital backpack">Digitalni ruksak</a>
    <a href="kontakt.html" data-hr="Kontakt" data-en="Contact">Kontakt</a>
  </div>

  <!-- === SEASON TOGGLE IKONE === -->
  <div id="season-toggle-wrapper">
    <img src="images/seasonchange.svg" id="season-toggle" alt="odabir godišnjeg doba" />
    <div id="season-strike" class="hidden"></div>
    <!-- KOSA CRTA -->
    <div id="season-icons">
      <div class="season-icon" data-season="winter">❄️</div>
      <div class="season-icon" data-season="spring">🌸</div>
      <div class="season-icon" data-season="summer">☀️</div>
      <div class="season-icon" data-season="autumn">🍂</div>
    </div>
  </div>

  <!-- =========================================================
       NASLOV
       ========================================================= -->
  <header class="page-head">
    <h1>Digitalni ruksak</h1>
    <p class="intro">Vaš Digitalni Vodič na jednom mjestu. Upute za Prvu Pomoć, Pametna Kamera, Pametni Kompas, Noćno nebo, Vremenska prognoza i Vodič za biljni i životinjski svijet te još dosta korisnih stvari.</p>
  </header>

  <!-- =========================================================
       GLAVNI SADRŽAJ — KARTICE ALATA
       ========================================================= -->
  <main>
    <section class="tools-grid" aria-label="Alati">
      <!-- Kartica: Vodiči -->
      <article class="tool-card" id="tool-aid">
        <div class="eyebrow">Prioritet</div>
        <h3>Upute za Prvu Pomoć</h3>
        <p>Brzi koraci koje svatko može slijediti. Prvo sigurnost mjesta, zatim 112.</p>
        <div class="btn-row">
          <button class="btn alt" id="openAidPanel">Otvori vodiče</button>
          <span class="chip">⛰️ Podsjetnici pri ruci</span>
        </div>
      </article>

      <!-- Kartica: Kamera -->
      <article class="tool-card" id="tool-camera">
        <div class="eyebrow">Foto</div>
        <h3>Pametna Kamera</h3>
        <p>Stabilan kadar → blago pojačanje kontrasta/boje/oštrine → snimka (izvan mreže).</p>
        <ul>
          <li>Samookidanje kad se kadar umiri</li>
          <li>Radi na HTTPS/localhost</li>
          <li>Bez slanja na poslužitelj</li>
        </ul>
        <div class="btn-row">
          <button class="btn" id="openCamPanel">Otvori alat</button>
          <a class="btn ghost" href="tools/camera-auto-enhance.html">U novoj kartici</a>
        </div>
        <p class="hint">Privatnost: snimka ostaje u tvom pregledniku.</p>
      </article>

      <!-- Kartica: Kompas/GPX -->
      <article class="tool-card" id="tool-arrow">
        <div class="eyebrow">Orijentacija</div>
        <h3>Pametni Kompas</h3>
        <p>Oznake N/E/S/W rotiraju prema smjeru kretanja, crvena igla je fiksna i pokazuje <b>geografski sjever</b> (s deklinacijom). Kad poravnaš s N (±5°), plava strelica pokazuje najbližu točku GPX staze.</p>
        <div class="btn-row">
          <button class="btn" id="openArrowPanel">Otvori alat</button>
          <button class="btn ghost" id="openPopupBtn" title="Iskočni prozor sa mini strelicom">Iskočni prozor</button>
          <button class="btn ghost" id="closePopupBtn" title="Zatvori iskočni prozor" style="display:none">Zatvori iskočni prozor</button>
        </div>
        <p class="hint">iOS traži dopuštenje za “Motion &amp; Orientation”; radi na HTTPS-u.</p>
      </article>

      <!-- Kartica: Nebo -->
      <article class="tool-card" id="tool-sky">
        <div class="eyebrow">Noć</div>
        <h3>Noćno nebo</h3>
        <p>Prikaz svjetlijih zvijezda. Kad telefon uperiš prema gore, asterizmi se <b>naglašavaju i spajaju linijama</b>.</p>
        <div class="btn-row">
          <button class="btn" id="openSkyPanel">Otvori nebo</button>
        </div>
        <p class="hint">Za preciznije: Stellarium Mobile ili Sky Map.</p>
      </article>

      <!-- Kartica: Vrijeme -->
      <article class="tool-card" id="tool-weather">
        <div class="eyebrow">Meteo</div>
        <h3>Vremenska prognoza</h3>
        <p>Brza lokalna prognoza: temperatura, vjetar, oborina, UV.</p>
        <div class="btn-row">
          <button class="btn" id="openWeatherPanel">Otvori prognozu</button>
        </div>
        <p class="hint">Izvor: open-meteo.com (bez API ključa).</p>
      </article>

      <!-- Kartica: Flora/Fauna -->
      <article class="tool-card" id="tool-bio">
        <div class="eyebrow">Vodič za biljni i životinjski svijet</div>
        <h3>Biljke i životinje (ručno prepoznavanje)</h3>
        <p>Snimi fotku i usporedi s mini vodičem. (Za AI prepoznavanje preporuka: iNaturalist / Pl@ntNet.)</p>
        <div class="btn-row">
          <button class="btn" id="openBioPanel">Otvori vodič</button>
        </div>
        <p class="hint">Radi izvan mreže kao pomoć pri opažanju; na mreži može otvoriti iNaturalist.</p>
      </article>

      <!-- Kartica: Izvan mreže -->
      <article class="tool-card" id="tool-offline">
        <div class="eyebrow">Navigacija</div>
        <h3>Vanmrežni dodaci</h3>
        <p>Preuzmi regiju u OSMand/Organic Maps; GPX spremi lokalno.</p>
        <div class="btn-row">
          <button class="btn ghost" id="openOfflinePanel">Brzi savjeti</button>
        </div>
      </article>

      <!-- Kartica: SOS -->
      <article class="tool-card" id="tool-sos">
        <div class="eyebrow">SOS</div>
        <h3>SOS svijetlo i zviždaljka</h3>
        <p>Glasan ton (••• — — — •••). Broj 112 je prioritet.</p>
        <div class="btn-row">
          <button class="btn alert" id="playSOS">Pokreni SOS</button>
          <button class="btn ghost" id="stopSOS">Zaustavi</button>
        </div>
      </article>

      <!-- Kartica: PeakCam (OSM vrhovi preko kamere) -->
      <article class="tool-card" id="tool-peakcam">
        <div class="eyebrow">AR</div>
        <h3>PeakCam — vrhovi u kameri</h3>
        <p>Uperi kameru prema horizontu: strelice i oznake imena vrhova (OSM) pojavljuju se u kadru.</p>
        <ul>
          <li>Potrebno: HTTPS + lokacija + orijentacija</li>
          <li>Automatski dohvat vrhova (30 km) s Overpass/OSM</li>
        </ul>
        <div class="btn-row">
          <button class="btn" id="openPeakCamPanel">Otvori PeakCam</button>
        </div>
        <p class="hint">Licenca podataka: © OpenStreetMap contributors (ODbL 1.0).</p>
      </article>
    </section>

    <!-- =========================================================
         PANEL: VODIČI
         ========================================================= -->
    <section id="panelAid" class="tool-panel" hidden>
      <h4>Digitalna pomoć — vodiči za planinare</h4>
      <!-- Uvodno pravilo i preporuka -->
      <div class="chip" style="margin-bottom:12px">🥾 <b>Prvo i osnovno pravilo:</b> uvijek nosite komplet prve pomoći u ruksaku kada idete na planinarenje i pohađajte tečajeve prve pomoći. Samo tako možete pravovremeno i pravilno reagirati u situacijama kada je pomoć najpotrebnija.</div>
      <div class="chip" style="margin-bottom:18px">ℹ️ <b>Raspitajte se u svom mjestu ili šire:</b> tečajevi prve pomoći često se organiziraju u sklopu planinarskih društava, gorskih službi spašavanja, Crvenog križa ili kroz edukacije koje provodi medicinsko osoblje. Sudjelovanjem stječete znanje i sigurnost za sebe i svoje suplaninare.</div>
      <div class="two-col">
        <!-- Lijevi stupac: vodiči (akordeon) -->
        <div>
          <div class="chip">ℹ️ Ovaj vodič ne zamjenjuje tečaj prve pomoći niti liječnički savjet. U hitnim slučajevima odmah nazovi 112.</div>
          <div class="divider"></div>
          <div class="aid-accordion" id="aidAcc">
            <!-- 0. Prvi postupci -->
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">🧭 Prvi postupci na mjestu nesreće</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li><b>Zaustavi se i procijeni sigurnost:</b> ne prilazi ako prijeti odron, klizav led, munje ili divlje životinje.</li>
                  <li><b>Pozovi 112</b> čim procijeniš da je situacija ozbiljna.</li>
                  <li><b>Zaštiti, pozovi, pruži pomoć:</b> osiguraj područje, označi stazu, pripremi orijentire (naziv staze, markacije, približne koordinate).</li>
                  <li><b>Provjeri svijest i disanje:</b> razgovaraj, protresi rame; ako ne diše normalno, započni oživljavanje.</li>
                </ul>
              </div>
            </div>
            <!-- 1. Oživljavanje odrasle osobe -->
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">🚑 Oživljavanje odrasle osobe</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li><b>Odmah pozovi 112.</b></li>
                  <li><b>Masiraj srce</b> na sredini prsnog koša: 100–120 pritisaka u minuti, dubina 5–6 cm.</li>
                  <li><b>Umjetno disanje</b> samo ako znaš i imaš masku.</li>
                  <li><b>Razmjena pomagača</b> svake 2 minute ako vas je više.</li>
                </ul>
              </div>
            </div>
            <!-- 2. Gušenje -->
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">🫁 Gušenje stranim tijelom</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li>Ako osoba <b>kašlje</b> – ohrabri kašalj.</li>
                  <li>Ako <b>ne može disati</b> – 5 udaraca između lopatica, zatim 5 potisaka u trbuh; ponavljaj dok se dišni put ne oslobodi.</li>
                  <li>Ako izgubi svijest – položi, pozovi 112 i započni masažu srca.</li>
                </ul>
              </div>
            </div>
            <!-- 3. Jako krvarenje -->
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">🩸 Jako krvarenje</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li><b>Pritisni ranu</b> 10 minuta bez prekidanja.</li>
                  <li>Ako promoči, dodaj preko – ne skidaj prvu gazu.</li>
                  <li>Za udove: kompresivni zavoj ili turniket (zabilježi vrijeme).</li>
                </ul>
              </div>
            </div>
            <!-- 4. Uganuće i prijelom -->
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">🦴 Uganuće i prijelom</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li><b>Odmor, hlađenje, pritisak, podizanje</b> – kod uganuća.</li>
                  <li><b>Sumnja na prijelom:</b> imobiliziraj u položaju u kojem se zatekne, toplinski zaštiti, pozovi 112.</li>
                  <li><b>Ozljeda glave/kralježnice:</b> osoba neka miruje, podupri glavu, ne pomiči vrat.</li>
                </ul>
              </div>
            </div>
            <!-- 5. Hladnoća i smrzavanje -->
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">🧊 Hladnoća i smrzavanje</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li><b>Blaga:</b> suha odjeća, slojevi, topli napitci (ne alkohol).</li>
                  <li><b>Teža:</b> pospanost, usporen govor – nježno zagrijavanje, bez trljanja, pozovi 112.</li>
                  <li><b>Smrzotine:</b> ne trljati, ne grijati plamenom; polako zagrijavati u mlakoj vodi ako neće opet smrznuti.</li>
                </ul>
              </div>
            </div>
            <!-- 6. Vrućina i dehidracija -->
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">🌞 Vrućina i dehidracija</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li><b>Umor od vrućine:</b> hlad, rashlađivanje, male gutljaje vode.</li>
                  <li><b>Toplinski udar:</b> visoka temperatura, smetenost – hitno rashladiti i zvati 112.</li>
                  <li><b>Dehidracija:</b> tamni urin, vrtoglavica – češće male količine vode i sol.</li>
                </ul>
              </div>
            </div>
            <!-- 7. Visinska bolest -->
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">⛰️ Tegobe na visini</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li>Glavobolja, mučnina, umor – odmor i hidracija; ako se pogoršava, spusti se.</li>
                  <li>Teško disanje, smetenost – hitno spuštanje i 112.</li>
                </ul>
              </div>
            </div>
            <!-- 8. Ugrizi i ubodi -->
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">🐍 Ugrizi i ubodi</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li><b>Krpelj:</b> pincetom ravno van, prati kožu.</li>
                  <li><b>Ubod pčele/ose:</b> hladiti, paziti na alergiju; ako teška reakcija – lijek i 112.</li>
                  <li><b>Zmija:</b> mir, imobilizirati, bez rezanja/isisavanja, hitno u bolnicu.</li>
                </ul>
              </div>
            </div>
            <!-- 9. Rane i žuljevi -->
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">🩹 Rane i žuljevi</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li>Isperi vodom, prekrij gazom.</li>
                  <li>Žuljeve zaštiti flasterom; ne bušiti osim sterilno i nužno.</li>
                </ul>
              </div>
            </div>
            <!-- 10. Opekline i oči -->
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">👁️ Opekline i ozljede oka</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li><b>Oko:</b> ispiranje čistom vodom ili fiziološkom.</li>
                  <li><b>Opekline:</b> hladiti vodom 20 min, skinuti nakit, sterilno prekriti, ne mazati mastima.</li>
                </ul>
              </div>
            </div>
            <!-- 11. Grmljavina -->
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">⚡ Grmljavina</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li>Silazi s grebena, ne stajati pod usamljena stabla.</li>
                  <li>Čučni na izolaciji, stopala zajedno, ne ležati.</li>
                  <li>Grupa se razmaka nekoliko metara.</li>
                </ul>
              </div>
            </div>
            <!-- 12. Hrana i voda -->
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">🥾 Voda i hrana</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li>Vodu prokuhati ili filtrirati.</li>
                  <li>Ne jesti nepoznate bobice/gljive.</li>
                  <li>Mučnina/proljev: odmor, lagana hrana, nadoknada tekućine i soli.</li>
                </ul>
              </div>
            </div>
            <!-- 13. Kronične bolesti -->
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">💊 Kronične bolesti u planini</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li><b>Šećerna bolest:</b> mjeri šećer, nosi glukozu; ako zbunjen ili bez svijesti – 112.</li>
                  <li><b>Tlak/srce:</b> odmori, simptomi u prsima – odmah 112.</li>
                  <li><b>Astma:</b> inhalator pri ruci, ako teško disanje – 112.</li>
                  <li><b>Epilepsija:</b> zaštiti glavu, ne stavljaj ništa u usta, nakon napadaj okreni na bok, 112 ako traje dugo.</li>
                </ul>
              </div>
            </div>
            <!-- 14. Bol u prsima i moždani udar -->
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">❤️ Bol u prsima i moždani udar</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li><b>Bol u prsima:</b> miruj, odmah 112.</li>
                  <li><b>Moždani udar:</b> asimetrija lica, slabost ruke/noge, teškoće govora – odmah 112.</li>
                </ul>
              </div>
            </div>
            <!-- 15. Signalizacija -->
            <div class="aid-item">
              <button class="aid-head btn ghost" style="width:100%;text-align:left">📢 Signalizacija i spašavanje</button>
              <div class="aid-body" style="display:none">
                <ul>
                  <li>Ostani na vidljivom mjestu, koristi zviždaljku, svjetiljku, foliju.</li>
                  <li>Daj jasne informacije: naziv staze, zadnja sigurna točka, broj osoba, ozljede.</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="divider"></div>
          <div class="hint">Ovo su sažeti vodiči za laike. Uvijek poštuj upute hitnih službi i liječnika.</div>
        </div>
        <!-- Desni stupac: podsjetnici -->
        <div>
          <h4 style="margin-top:0">Brzi podsjetnici</h4>
          <ul>
            <li>U hitnome: nazovi 112 što ranije, opiši lokaciju i stanje.</li>
            <li>Krvarenje: pritisak 10 min; dodaj preko.</li>
            <li>Hladnoća: suho, slojevito, bez trljanja smrzotina.</li>
            <li>Vrućina: hlad, rashlađivanje, male količine vode.</li>
            <li>Zmija: mir, imobilizacija, bez rezanja, brzo u bolnicu.</li>
            <li>Krpelj: pinceta ravno van, prati kožu.</li>
            <li>Kronične bolesti: lijekovi pri ruci, obavijesti partnera.</li>
          </ul>
          <h4 style="margin-top:12px">Mali planinarski komplet prve pomoći</h4>
          <ul>
            <li>Elastični zavoj, sterilne gaze, flasteri i gel flasteri za žuljeve.</li>
            <li>Fiziološka otopina ili čista voda za ispiranje, dezinfekcijske maramice.</li>
            <li>Rukavice, trokutna marama, škare.</li>
            <li>Termo folija, zviždaljka, čeona svjetiljka, marker i notes.</li>
            <li>Osobni lijekovi (inhalator, glukoza, tablete koje je propisao liječnik).</li>
          </ul>
          <div class="chip" style="margin-top:8px">📞 112 — hitna pomoć i spašavanje</div>
          <div class="chip" style="margin-top:8px">📍 Uvijek nosi osnovne orijentire: naziv staze, markacije, približne koordinate.</div>
        </div>
      </div>
    </section>

    <!-- =========================================================
         PANEL: KAMERA
         ========================================================= -->
    <section id="panelCamera" class="tool-panel" hidden>
      <h4>Pejzažno snimanje (ugrađeno)</h4>
      <div class="camera-wrap">
        <video id="camVideo" autoplay playsinline></video>
        <canvas id="camCanvas"></canvas>
        <div class="toolbar">
          <div id="camDot" class="dot" title="Pokazatelj mirnoće"></div>
          <div id="camMsg">Tražim stabilnost…</div>
          <button id="camManual" class="btn ghost">Snimi sada</button>
          <button id="camAuto" class="btn">Auto snimanje: UKLJ.</button>
          <button id="camClose" class="btn ghost">Zatvori</button>
        </div>
        <div class="result">
          <img id="camThumb" alt="Pregled snimljene fotografije">
          <div class="hint">Radi samo na HTTPS/localhost. Snimka ostaje lokalno.</div>
        </div>
      </div>
    </section>

    <!-- =========================================================
         PANEL: KOMPAS + GPX + DEKLINACIJA + LIBELA
         ========================================================= -->
    <section id="panelArrow" class="tool-panel" hidden>
      <h4>Pametni Kompas</h4>
      <div class="compass-wrap">
        <div class="compass-row">
          <!-- Kompas -->
          <div class="compass" aria-label="Kompas">
            <div class="compass-ring" id="compassRing">
              <span class="mark n">N</span>
              <span class="mark e">E</span>
              <span class="mark s">S</span>
              <span class="mark w">W</span>
              <div class="ticks"></div>
            </div>
            <div class="north-needle" id="northNeedle">
              <div class="tip"></div>
            </div>
            <!-- Strelica koja NAVODI (skrivena dok nema GPX ili si na stazi) -->
            <svg id="targetArrow" width="72" height="72" viewBox="0 0 72 72" style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%) rotate(0deg); display:none; z-index:5;">
              <polygon points="36,6 46,30 36,26 26,30" fill="#e53935"></polygon>
              <rect x="33" y="26" width="6" height="28" rx="3" fill="#e53935"></rect>
            </svg>
            <!-- Zelena kvačica kad si NA stazi -->
            <div id="onPathOK" style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); display:none; z-index:5;">
              <svg width="64" height="64" viewBox="0 0 64 64" aria-label="Na stazi">
                <circle cx="32" cy="32" r="28" fill="#2e7d32"></circle>
                <polyline points="20,33 28,41 46,23" fill="none" stroke="#fff" stroke-width="6" stroke-linecap="round" stroke-linejoin="round"></polyline>
              </svg>
            </div>
            <div class="tick"></div>
            <div id="arrow3d" class="arrow3d" style="opacity:0"></div>
          </div>
          <!-- Libela -->
          <div class="level-wrap" aria-label="Libela">
            <div class="level-ring" id="levelRing">
              <div class="lvl-cross lvl-h"></div>
              <div class="lvl-cross lvl-v"></div>
              <div class="level-bubble" id="levelBubble"></div>
            </div>
            <div class="level-readout">
              <span> ↔️ : <b id="pitchDeg">0.0°</b></span>
              <span> ↕️ : <b id="rollDeg">0.0°</b></span>
            </div>
          </div>
          <div class="hint">N/E/S/W su na rotirajućem prstenu, crvena igla je fiksna. <br> Ako je igla poravnata s N (±5°), plava strelica pokazuje najbližu točku GPX staze.</div>
        </div>
        <div class="divider"></div>
        <!-- GPX Učitavanje -->
        <div class="compass-row">
          <div class="field">
            <label for="gpxInput">GPX datoteka:</label>
            <input id="gpxInput" type="file" accept=".gpx,application/gpx+xml">
            <button class="btn ghost" id="loadGpxBtn">Učitaj</button>
          </div>
          <div class="field">
            <label for="gpxUrl">GPX URL:</label>
            <input id="gpxUrl" type="url" placeholder="https://…/ruta.gpx" style="width:260px">
            <button class="btn ghost" id="loadUrlBtn">Učitaj URL</button>
          </div>
          <div class="field">
            <label for="alertMeters">Prag (m) za zvuk:</label>
            <input id="alertMeters" type="number" min="5" step="5" value="30">
            <button class="btn" id="toggleTrackBtn">Pokreni praćenje</button>
          </div>
        </div>
        <div class="status-line" style="margin-top:6px">
          <span class="chip" id="trackStatusPill">GPX: —</span>
          <span class="chip" id="onTrackChip">🧭 status: —</span>
          <span class="chip" id="offDistChip">↔︎ udaljenost: —</span>
        </div>
        <div class="divider"></div>
        <!-- Povratna ruta (Backtrack) -->
        <div class="compass-row">
          <div class="btn-row">
            <button class="btn ghost" id="btStart">Započni povratak</button>
            <button class="btn ghost" id="btStop">Zaustavi povratak</button>
          </div>
          <span class="chip" id="btStatus">↩︎ Povratak: isključen</span>
        </div>
        <div class="divider"></div>
        <!-- Deklinacija i dozvole -->
        <div class="compass-row">
          <div class="chip"><label><input type="checkbox" id="useTrueNorth" checked> Geografski sjever</label></div>
          <div class="chip"><label><input type="checkbox" id="autoDecl" checked> Auto deklinacija (izvan mreže + GPS)</label></div>
          <div class="chip">Deklinacija: <input id="declInput" type="number" step="0.1" style="width:80px">°</div>
          <button class="btn ghost" id="declHelp">Upute</button>
          <button class="btn ghost" id="iosPermBtn" style="margin-left:auto">Omogući kompas (iOS)</button>
        </div>
        <p class="hint" style="margin-top:6px">Možeš dodati parametar: <code>?gpx=https://…/ruta.gpx</code></p>
        <div><button class="btn" id="arrowClose">Zatvori</button></div>
      </div>
    </section>

    <!-- =========================================================
         PANEL: NOĆNO NEBO (MINI PLANISFERA)
         ========================================================= -->
    <section id="panelSky" class="tool-panel" hidden>
      <h4>Noćno nebo — Orion i Veliki medvjed (beta)</h4>
      <canvas id="skyCanvas" width="520" height="300"></canvas>
      <div class="sky-legend" id="skyLegend">Pomakni telefon: prikaz prati orijentaciju (azimut). <br>Kad telefon uperiš prema gore (pitch &le; -60°), istaknut ćemo linije asterizama i nazive zvijezda.</div>
      <div class="divider"></div>
      <div class="btn-row">
        <button class="btn" id="skyStart">Uključi senzore</button>
        <button class="btn ghost" id="skyNow">Centriraj na sjever</button>
      </div>
    </section>

    <!-- =========================================================
         PANEL: PROGNOZA VREMENA (OPEN-METEO)
         ========================================================= -->
    <section id="panelWeather" class="tool-panel" hidden>
      <h4>Meteorološka prognoza — sljedeća 3 dana</h4>
      <div class="btn-row">
        <button class="btn" id="wxFetch">Dohvati prema lokaciji</button>
        <input id="wxLat" type="number" step="0.0001" placeholder="Geografska širina" style="width:160px">
        <input id="wxLon" type="number" step="0.0001" placeholder="Geografska dužina" style="width:160px">
        <button class="btn ghost" id="wxFetchManual">Dohvati po koordinatama</button>
      </div>
      <div class="divider"></div>
      <div id="wxCity" class="chip">Lokacija: —</div>
      <div class="weather-grid" id="wxGrid"></div>
    </section>

    <!-- =========================================================
         PANEL: BILJKE / ŽIVOTINJE (RUČNO)
         ========================================================= -->
    <section id="panelBio" class="tool-panel" hidden>
      <h4>Terenski vodič — Biljke i životinje (pomoć izvan mreže)</h4>
      <div class="id-grid">
        <div class="id-row">
          <button class="btn" id="bioOpenCam">Otvori kameru</button>
          <button class="btn ghost" id="bioSnap" disabled>Snimi</button>
          <button class="btn ghost" id="bioCloseCam" disabled>Zatvori</button>
          <button class="btn alt" id="bioINat">iNaturalist (na mreži)</button>
        </div>
        <video id="bioVideo" autoplay playsinline style="width:100%;max-width:420px;border:1px solid var(--line);border-radius:10px;display:none"></video>
        <canvas id="bioCanvas" width="640" height="480" style="display:none"></canvas>
        <img id="bioPhoto" alt="Snimka za usporedbu" style="max-width:420px;border:1px solid var(--line);border-radius:10px;display:none">
        <div class="divider"></div>
        <div class="hint">Brzi vodič (općenito):</div>
        <div class="id-row">
          <span class="tag">Listovi: suprotni ili naizmjenični?</span>
          <span class="tag">Rub lista: cijeli / nazubljen</span>
          <span class="tag">Cvijet: broj latica (4, 5, 6…)</span>
          <span class="tag">Plod: bobica / komuška / oraščić</span>
          <span class="tag">Stanište: livada / šuma / voda</span>
          <span class="tag">Životinja: tragovi — broj prstiju</span>
          <span class="tag">Perje: oblik repa i kljuna</span>
        </div>
      </div>
    </section>

    <!-- =========================================================
         PANEL: SAVJETI IZVAN MREŽE
         ========================================================= -->
    <section id="panelOffline" class="tool-panel" hidden>
      <h4>Savjeti izvan mreže</h4>
      <ul>
        <li><b>Organic Maps</b> ili <b>OSMand</b> — preuzmi regiju za korištenje bez interneta.</li>
        <li>GPX spremi lokalno i otvori iz aplikacije (bez interneta).</li>
        <li>Uključi “Zrakoplovni način” + GPS radi štednje baterije.</li>
      </ul>
      <button class="btn ghost" onclick="this.closest('section').hidden=true">Zatvori</button>
    </section>

    <!-- =========================================================
         PANEL: PEAKCAM (AR vrhovi preko kamere)
         ========================================================= -->
    <section id="panelPeakCam" class="tool-panel" hidden>
      <h4>PeakCam — prepoznavanje vrhova (OSM)</h4>
      <div class="pc-toolbar">
        <button id="pc-start" class="btn">Pokreni kameru</button>
        <button id="pc-stop" class="btn ghost">Zatvori</button>
        <span class="chip" id="pc-status">Status: spremno</span>
      </div>
      <div class="pc-wrap">
        <div class="pc-stage">
          <video id="pc-video" autoplay playsinline muted></video>
          <canvas id="pc-overlay"></canvas>
          <div id="pc-hint" class="pc-hint">Dopusti pristup kameri, lokaciji i orijentaciji.</div>
        </div>
        <div class="pc-legend">
          <label class="pc-inline">H FOV
            <input id="pc-hfov" type="range" min="40" max="90" value="60">
            <span id="pc-hfov-val">60°</span>
          </label>
          <label class="pc-inline">V FOV
            <input id="pc-vfov" type="range" min="30" max="70" value="40">
            <span id="pc-vfov-val">40°</span>
          </label>
          <label class="pc-inline">Kompas offset
            <input id="pc-hofs" type="range" min="-20" max="20" value="0">
            <span id="pc-hofs-val">0°</span>
          </label>
        </div>
        <div class="pc-attrib">Podaci o vrhovima: © <a href="https://www.openstreetmap.org" target="_blank" rel="noopener">OpenStreetMap contributors</a> — licenca <a href="https://opendatacommons.org/licenses/odbl/" target="_blank" rel="noopener">ODbL 1.0</a>.</div>
      </div>
    </section>
  </main>

<!-- MINI KOMPAS — FRAGMENT ZA POPUP (HTML+CSS, BEZ JS) -->
<template id="miniPopupTpl">
  <style>
    :root { color-scheme: dark light; }
    html,body{margin:0;background:#0b0e12;color:#e8eef5;font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;}
    .wrap{padding:14px;display:flex;flex-direction:column;gap:12px}
    .card{background:#12161c;border:1px solid #222b35;border-radius:16px;padding:14px}
    .topbar{display:flex;align-items:center;justify-content:space-between}
    .xbtn{appearance:none;border:0;background:#1b222b;border:1px solid #2b3642;color:#d7e0ea;border-radius:10px;padding:6px 10px;cursor:pointer}
    .ringWrap{display:grid;place-items:center}
    #ring{width:260px;height:260px;border-radius:50%;border:2px solid #2b3642;position:relative;transform:translateZ(0)}
    #needle{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:0;height:0;border-left:10px solid transparent;border-right:10px solid transparent;border-bottom:40px solid #ff6b6b;filter:drop-shadow(0 1px 2px rgba(0,0,0,.4))}
    .cardinal{position:absolute;left:50%;top:50%;transform-origin:50% 110px;color:#9fb0c2;font-weight:600}
    .N{transform:translate(-50%,-50%) rotate(0deg)   translateY(-110px)}
    .E{transform:translate(-50%,-50%) rotate(90deg)  translateY(-110px)}
    .S{transform:translate(-50%,-50%) rotate(180deg) translateY(-110px)}
    .W{transform:translate(-50%,-50%) rotate(270deg) translateY(-110px)}
    .hud{text-align:center;color:#a9b4c0}
    .pill{display:inline-block;background:#0f1318;border:1px solid #202a34;border-radius:999px;padding:6px 10px;margin-top:8px}
    .pill.ok{border-color:#2aa96b;color:#b8f1d4}
    .pill.warn{border-color:#f2c14e;color:#ffe7a4}
    .pill.bad{border-color:#ff6b6b;color:#ffc9c9}
  </style>

  <div class="wrap">
    <div class="topbar">
      <div style="opacity:.8">Mini kompas</div>
      <button id="close" class="xbtn" aria-label="Zatvori">✕</button>
    </div>
    <div class="card ringWrap">
      <div id="ring">
        <div id="needle"></div>
        <div class="cardinal N">N</div>
        <div class="cardinal E">E</div>
        <div class="cardinal S">S</div>
        <div class="cardinal W">W</div>
      </div>
      <div class="hud" style="margin-top:10px">Smjer: <span id="lblH">—</span>°</div>
    </div>
    <div class="card" style="text-align:center">
      <div class="hud">Udaljenost od staze</div>
      <div id="distPill" class="pill">—</div>
    </div>
  </div>
</template>

  <!-- FOOTER + BACK TO TOP -->
  <button id="backToTop" title="Na vrh" aria-label="Gumb na vrh">
    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <polyline points="18 15 12 9 6 15"></polyline>
    </svg>
  </button>

  <footer id="footer">
    <div class="footer-icons">
      <a href="https://instagram.com/mountainadventures__" target="_blank" aria-label="Instagram">
        <svg viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <rect x="2" y="2" width="20" height="20" rx="5" ry="5"></rect>
          <path d="M16 11.37A4 4 0 1 1 12.63 8 4 4 0 0 1 16 11.37z"></path>
          <line x1="17.5" y1="6.5" x2="17.5" y2="6.5"></line>
        </svg>
      </a>
      <a href="mailto:mountainadventures1717@gmail.com" aria-label="Email">
        <svg viewBox="0 0 24 24" fill="none" stroke="#ffffff" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
          <polyline points="22,6 12,13 2,6"></polyline>
        </svg>
      </a>
    </div>
    © Mountain Adventures. All rights reserved.
  </footer>

  <script src="season.js"></script>

<script>
/* =========================================================
   CORE / NAV / JEZIK / BACK-TO-TOP / PWA / PANELS
   ========================================================= */

/* ---------- Helperi (jednom u cijeloj stranici) ---------- */
window.qs  = window.qs  || ((s,root=document)=>root.querySelector(s));
window.qsa = window.qsa || ((s,root=document)=>root.querySelectorAll(s));
const hide = el => { if(el) el.hidden = true; };
const safeCall  = fn => { try { typeof fn === 'function' && fn(); } catch(_){} };
const safeAsync = async fn => { try { if (typeof fn === 'function') await fn(); } catch(_){} };
function normalize(d){ d = d % 360; return d < 0 ? d + 360 : d; }
function screenAngle(){
  const a = (screen.orientation && screen.orientation.angle) || window.orientation || 0;
  return (typeof a === 'number') ? a : 0;
}

/* ---------- NAV / JEZIK / MENI / BACK-TO-TOP ---------- */
const langToggle   = document.getElementById('language-toggle');
const searchInput  = document.getElementById('search');
const menuToggle   = document.getElementById('menu-toggle');
const menu         = document.getElementById('menu');
const backToTopBtn = document.getElementById('backToTop');
const footer       = document.getElementById('footer');

function getInitialLang() {
  const urlLang = new URLSearchParams(location.search).get('lang');
  if (['hr','en'].includes(urlLang)) return urlLang;
  try {
    const s = localStorage.getItem('preferredLang');
    if (['hr','en'].includes(s)) return s;
  } catch(_){}
  return 'hr';
}

function applyLanguage(lang) {
  try { localStorage.setItem('preferredLang', lang); } catch(_){}
  const u = new URL(location.href); u.searchParams.set('lang', lang); history.replaceState({},'',u.toString());
  document.documentElement.lang = lang;

  if (langToggle) {
    langToggle.src = lang === 'hr' ? 'images/flag-uk.svg' : 'images/flag-hr.svg';
    langToggle.alt = lang === 'hr' ? 'Promijeni na engleski' : 'Switch to Croatian';
    langToggle.setAttribute('data-tooltip', lang === 'hr' ? 'Promijeni jezik' : 'Change language');
  }
  if (searchInput) searchInput.placeholder = lang === 'hr' ? 'Pretraži...' : 'Search...';

  document.querySelectorAll('[data-hr]').forEach(el=>{
    const v = el.getAttribute('data-'+lang);
    if (v == null) return;
    if (v.includes('<')) el.innerHTML = v; else el.textContent = v;
  });
  document.querySelectorAll('.menu-overlay a').forEach(a=>{
    const v = a.getAttribute('data-'+lang);
    if (v != null) a.textContent = v;
  });
}

let currentLang = getInitialLang();
applyLanguage(currentLang);
langToggle?.addEventListener('click', ()=>{
  currentLang = currentLang === 'hr' ? 'en' : 'hr';
  applyLanguage(currentLang);
});

menuToggle?.addEventListener('click', ()=> menu.classList.toggle('open'));
window.addEventListener('click', (e)=>{
  if (!menu?.contains(e.target) && !menuToggle?.contains(e.target) && e.target.id !== 'language-toggle') {
    menu?.classList.remove('open');
  }
});
document.querySelectorAll('.menu-overlay a').forEach(l=> l.addEventListener('click', ()=> menu?.classList.remove('open')));

window.addEventListener('scroll', ()=>{
  const y = window.scrollY;
  const footerTop = footer?.getBoundingClientRect ? footer.getBoundingClientRect().top + window.scrollY : Infinity;
  const h = window.innerHeight;
  if (backToTopBtn){
    backToTopBtn.style.display = y > 300 ? 'flex' : 'none';
    backToTopBtn.style.bottom = (y + h > footerTop) ? ((y + h - footerTop) + 60) + 'px' : '30px';
  }
});
backToTopBtn?.addEventListener('click', ()=> window.scrollTo({top:0, behavior:'smooth'}));

/* ---------- Sezone (placeholder loader) ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  const s = localStorage.getItem('activeSeason');
  if (s) {
    setTimeout(()=>{
      if (s === 'winter') safeCall(()=>window.startWinterEffect?.(true));
      else if (s === 'summer') safeCall(()=>window.startSummerEffect?.(true));
      else if (s === 'spring') safeCall(()=>window.startSpringEffect?.(true));
      else if (s === 'autumn') safeCall(()=>window.startAutumnEffect?.(true));
    }, 10000);
  }
  fetch('season.html').then(r=>r.text()).then(html=>{
    const ph = document.getElementById('season-placeholder'); if (ph) ph.innerHTML = html;
    if (typeof initializeSeasonToggle === 'function') initializeSeasonToggle();
  }).catch(()=>{});
});

/* ---------- PWA ---------- */
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(()=>{});
}

/* ---------- Panel router (drop-in) ---------- */
(function(){
  const wires = [
    ['#openAidPanel',     '#panelAid'],
    ['#openCamPanel',     '#panelCamera'],
    ['#openArrowPanel',   '#panelArrow'],
    ['#openSkyPanel',     '#panelSky'],
    ['#openWeatherPanel', '#panelWeather'],
    ['#openBioPanel',     '#panelBio'],
    ['#openOfflinePanel', '#panelOffline'],
    ['#openPeakCamPanel', '#panelPeakCam'],
  ];
  const panels = Array.from(document.querySelectorAll('section.tool-panel'));
  function closeAll(){ panels.forEach(p=> p && (p.hidden = true)); }
  function openSel(sel){
    const tgt = document.querySelector(sel); if (!tgt) return;
    panels.forEach(p => p.hidden = (p !== tgt));
    try { tgt.scrollIntoView({behavior:'smooth', block:'start'}); } catch(_){}
  }
  wires.forEach(([btnSel, panelSel])=>{
    const btn = document.querySelector(btnSel);
    if (btn) btn.addEventListener('click', ()=> openSel(panelSel));
  });
  const closeBindings = [
    ['#camClose',   '#panelCamera'],
    ['#arrowClose', '#panelArrow'],
    ['#pc-stop',    '#panelPeakCam'],
  ];
  closeBindings.forEach(([btnSel, panelSel])=>{
    const btn = document.querySelector(btnSel), panel = document.querySelector(panelSel);
    if (btn && panel) btn.addEventListener('click', ()=> panel.hidden = true);
  });
  document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeAll(); });
  const main = document.querySelector('main');
  if (main){
    main.addEventListener('click', e=>{
      if (e.target === main) closeAll();
    });
  }
})();

/* ---------- Vidljivost — štedi bateriju ---------- */
document.addEventListener('visibilitychange', ()=>{
  if (document.visibilityState === 'hidden'){
    safeCall(()=> window.__arrow  ?.stop?.());
    safeCall(()=> window.__sky    ?.stop?.());
    safeCall(()=> window.__peakcam?.stop?.());
    safeCall(()=> window.stopCam?.());
  }
});

/* ---------- Akordeon vodič (ako postoji) ---------- */
(function(){
  const acc = qs('#aidAcc');
  if (!acc) return;
  acc.querySelectorAll('.aid-head').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const body = btn.parentElement.querySelector('.aid-body');
      if (!body) return;
      const open = btn.classList.toggle('open');
      body.style.display = open ? 'block' : 'none';
    });
  });
})();


/* =========================================================
   KAMERA — AUTO STABILNOST I CAPTURE
   ========================================================= */
const camClose = qs('#camClose'),
      camVideo = qs('#camVideo'),
      camCanvas= qs('#camCanvas'),
      camCtx   = camCanvas?.getContext?.('2d',{willReadFrequently:true}),
      camDot   = qs('#camDot'),
      camMsg   = qs('#camMsg'),
      camThumb = qs('#camThumb'),
      camManual= qs('#camManual'),
      camAutoBtn=qs('#camAuto');

const STABILITY_FRAMES=8, DIFF_THRESHOLD=6, CAPTURE_WIDTH=1600;
let camAutoMode=true, camPrev=null, camSteady=0, camLastAuto=0, camLoopOn=false;

camClose?.addEventListener('click', stopCam);
camAutoBtn?.addEventListener('click', ()=>{
  camAutoMode=!camAutoMode;
  camAutoBtn.textContent = camAutoMode ? 'Auto snimanje: UKLJ.' : 'Auto snimanje: ISKLJ.';
});
camManual?.addEventListener('click', captureCam);

async function startCam(){
  if(camLoopOn) return;
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
    camVideo.srcObject = stream; await camVideo.play();
    camCanvas.width  = Math.min(1280, camVideo.videoWidth  || 1280);
    camCanvas.height = Math.min(720,  camVideo.videoHeight || 720);
    camLoopOn = true;
    requestAnimationFrame(camLoop);
  }catch(e){
    if (camMsg) camMsg.textContent = 'Greška s kamerom: '+e.message;
  }
}
function stopCam(){
  hide(qs('#panelCamera'));
  camLoopOn=false;
  try{
    camVideo.pause();
    camVideo.srcObject?.getTracks?.().forEach(t=>t.stop());
    camVideo.srcObject=null;
  }catch(_){}
}
function lumaAt(d,i){ return 0.2126*d[i]+0.7152*d[i+1]+0.0722*d[i+2]; }
function frameDiff(a,b){
  const da=a.data, db=b.data;
  let s=0,n=da.length/4;
  for(let p=0,i=0;p<n;p++,i+=4){ s+=Math.abs(lumaAt(da,i)-lumaAt(db,i)); }
  return s/n;
}
function autoContrast(img){
  const d=img.data,n=d.length/4; let lo=255,hi=0;
  for(let i=0;i<n;i++){const idx=i*4,L=lumaAt(d,idx); if(L<lo)lo=L; if(L>hi)hi=L;}
  const range=Math.max(1,hi-lo),scale=255/range;
  for(let i=0;i<n;i++){
    const idx=i*4;
    d[idx  ]=Math.min(255,Math.max(0,(d[idx  ]-lo)*scale));
    d[idx+1]=Math.min(255,Math.max(0,(d[idx+1]-lo)*scale));
    d[idx+2]=Math.min(255,Math.max(0,(d[idx+2]-lo)*scale));
  }
  return img;
}
function unsharp(img,a=.55,r=1){
  const w=img.width,h=img.height,s=img.data,out=new Uint8ClampedArray(s.length);
  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      let rsum=0,gsum=0,bsum=0,c=0;
      for(let oy=-r;oy<=r;oy++){
        const yy=Math.min(h-1,Math.max(0,y+oy));
        for(let ox=-r;ox<=r;ox++){
          const xx=Math.min(w-1,Math.max(0,x+ox)),i=(yy*w+xx)*4;
          rsum+=s[i]; gsum+=s[i+1]; bsum+=s[i+2]; c++;
        }
      }
      const i=(y*w+x)*4, br=rsum/c, bg=gsum/c, bb=bsum/c;
      out[i  ]=Math.min(255,Math.max(0,s[i  ]+a*(s[i  ]-br)));
      out[i+1]=Math.min(255,Math.max(0,s[i+1]+a*(s[i+1]-bg)));
      out[i+2]=Math.min(255,Math.max(0,s[i+2]+a*(s[i+2]-bb)));
      out[i+3]=s[i+3];
    }
  }
  img.data.set(out); return img;
}
async function camLoop(){
  if(!camLoopOn) return;
  if(camVideo.readyState>=2){
    camCtx.drawImage(camVideo,0,0,camCanvas.width,camCanvas.height);
    const cur=camCtx.getImageData(0,0,camCanvas.width,camCanvas.height);
    if(camPrev){
      const diff=frameDiff(cur,camPrev);
      if(diff<DIFF_THRESHOLD){
        camSteady++; camDot?.classList.add('ok'); if (camMsg) camMsg.textContent=`Mirno — ${camSteady}/${STABILITY_FRAMES}`;
      } else {
        camSteady=0; camDot?.classList.remove('ok'); if (camMsg) camMsg.textContent=`Nemirno (${Math.round(diff)}), drži mirnije`;
      }
      if(camSteady>=STABILITY_FRAMES && camAutoMode){
        const now=Date.now();
        if(now-camLastAuto>2500){ camLastAuto=now; await captureCam(); }
        camSteady=0;
      }
    }
    camPrev=cur;
  }
  requestAnimationFrame(camLoop);
}
async function captureCam(){
  if (camMsg) camMsg.textContent='Snimam i obrađujem…';
  try{
    const track=camVideo.srcObject?.getVideoTracks?.[0];
    if(track && window.ImageCapture){
      const ic=new ImageCapture(track);
      if(ic.takePhoto){
        const blob=await ic.takePhoto();
        const bmp=await createImageBitmap(blob);
        const r=bmp.width/bmp.height;
        const W=Math.min(CAPTURE_WIDTH,bmp.width), H=Math.round(W/r);
        camCanvas.width=W; camCanvas.height=H;
        camCtx.drawImage(bmp,0,0,W,H);
        camCtx.filter='contrast(1.06) saturate(1.08)'; camCtx.drawImage(camCanvas,0,0); camCtx.filter='none';
        let id=camCtx.getImageData(0,0,W,H);
        id=autoContrast(id); id=unsharp(id,.6,1);
        camCtx.putImageData(id,0,0);
        const url=camCanvas.toDataURL('image/jpeg',0.92);
        camThumb.src=url;
        if (camMsg) camMsg.innerHTML='Gotovo. <a style="margin-left:8px" download="planina-fotografija.jpg" href="'+url+'">Preuzmi</a>';
        return;
      }
    }
  }catch(_){}
  const r=(camVideo.videoWidth||1080)/(camVideo.videoHeight||1920);
  const W=Math.min(CAPTURE_WIDTH,camVideo.videoWidth||1280), H=Math.round(W/r);
  camCanvas.width=W; camCanvas.height=H;
  camCtx.drawImage(camVideo,0,0,W,H);
  camCtx.filter='contrast(1.06) saturate(1.08)'; camCtx.drawImage(camCanvas,0,0); camCtx.filter='none';
  let id=camCtx.getImageData(0,0,W,H);
  id=autoContrast(id); id=unsharp(id,.6,1);
  camCtx.putImageData(id,0,0);
  const url=camCanvas.toDataURL('image/jpeg',0.92);
  camThumb.src=url;
  if (camMsg) camMsg.innerHTML='Gotovo. <a style="margin-left:8px" download="planina-fotografija.jpg" href="'+url+'">Preuzmi</a>';
}

/* Otvaranje panela kamere (na gumb) */
qs('#openCamPanel')?.addEventListener('click', async ()=>{
  await safeAsync(startCam);
});


/* =========================================================
   KOMPAS / GPX / BACKTRACK + MINI HUD + POPUP
   ========================================================= */

/* ---- DOM refs ---- */
const arrowEl=qs('#arrow3d'),
      gpxInput=qs('#gpxInput'),
      loadGpxBtn=qs('#loadGpxBtn'),
      gpxUrl=qs('#gpxUrl'),
      loadUrlBtn=qs('#loadUrlBtn'),
      alertMetersInput=qs('#alertMeters'),
      toggleTrackBtn=qs('#toggleTrackBtn'),
      trackStatusPill=qs('#trackStatusPill'),
      onTrackChip=qs('#onTrackChip'),
      offDistChip=qs('#offDistChip');

const mini=qs('#miniCompass'),
      miniNeedle=qs('#miniNeedle'),
      miniMeters=qs('#miniMeters');

const compassRing = qs('#compassRing');
const northNeedle = qs('#northNeedle');
const targetArrow = qs('#targetArrow');
const levelRing   = qs('#levelRing');
const levelBubble = qs('#levelBubble');
const pitchLbl    = qs('#pitchDeg');
const rollLbl     = qs('#rollDeg');

const useTrueNorthEl = qs('#useTrueNorth');
const autoDeclEl     = qs('#autoDecl');
const declInput      = qs('#declInput');
const declModalBack  = qs('#declModalBack');
const declHelpBtn    = qs('#declHelp');
const declCloseBtn   = qs('#declClose');
const iosPermBtn     = qs('#iosPermBtn');
const gpsBanner      = qs('#gpsBanner');
const bannerHide     = qs('#bannerHide');

bannerHide?.addEventListener('click', ()=> gpsBanner.style.display='none');
declHelpBtn?.addEventListener('click', ()=> declModalBack.style.display='grid');
declCloseBtn?.addEventListener('click', ()=> declModalBack.style.display='none');

const onPathOK = document.getElementById('onPathOK');
const NAV = { NO_TRACK:'NO_TRACK', ON_PATH:'ON_PATH', OFF_PATH:'OFF_PATH' };
let navState = NAV.NO_TRACK;
const ONPATH_THRESH_M = 20;

function setNavState(state){
  if (navState === state) return;
  navState = state;
  if (navState === NAV.NO_TRACK){
    targetArrow && (targetArrow.style.display='none');
    onPathOK    && (onPathOK.style.display='none');
  } else if (navState === NAV.ON_PATH){
    targetArrow && (targetArrow.style.display='none');
    onPathOK    && (onPathOK.style.display='block');
  } else {
    onPathOK    && (onPathOK.style.display='none');
    targetArrow && (targetArrow.style.display='block');
  }
}
setNavState(NAV.NO_TRACK);

/* ---- Namespace za kompas ---- */
window.__arrow = window.__arrow || {
  activeOriEvent: null,
  watchId: null,
  rafId: 0,
  _onOrientChange: null,
  stop(){
    try{
      if (this.activeOriEvent) {
        window.removeEventListener(this.activeOriEvent, onOrient3D, true);
        this.activeOriEvent = null;
      }
      if (this._onOrientChange) {
        window.removeEventListener('orientationchange', this._onOrientChange);
        this._onOrientChange = null;
      }
      if (this.watchId != null) {
        navigator.geolocation.clearWatch(this.watchId);
        this.watchId = null;
      }
      if (this.rafId) { cancelAnimationFrame(this.rafId); this.rafId = 0; }
    }catch(_){}
  }
};

/* ---- Stanje i konstante ---- */
const R=6371000, RAD=Math.PI/180, DEG=180/Math.PI;
let gpxTrack=null, alertMeters=30, audioCtx=null, offBeepArmed=false;
let lastFix=null, lastKnownLat=null, lastKnownLon=null;
let headingDeg=null, correctedHeading=null, lastBrg=null;
let useTrueNorth = JSON.parse(localStorage.getItem('ma_useTrueNorth') || 'true');
let autoDecl     = JSON.parse(localStorage.getItem('ma_autoDecl') || 'true');
let declinationDeg = parseFloat(localStorage.getItem('ma_declinationDeg') || '4.3');
const ALIGN_TOLERANCE = 5;

useTrueNorthEl && (useTrueNorthEl.checked = useTrueNorth);
autoDeclEl     && (autoDeclEl.checked     = autoDecl);
if (declInput) declInput.value = (+declinationDeg).toFixed(1);

useTrueNorthEl?.addEventListener('change', ()=>{
  useTrueNorth = !!useTrueNorthEl.checked;
  localStorage.setItem('ma_useTrueNorth', JSON.stringify(useTrueNorth));
  if(headingDeg!=null) applyHeading(headingDeg);
});
autoDeclEl?.addEventListener('change', ()=>{
  autoDecl = !!autoDeclEl.checked;
  localStorage.setItem('ma_autoDecl', JSON.stringify(autoDecl));
});
declInput?.addEventListener('change', ()=>{
  const v=parseFloat(declInput.value);
  if(Number.isFinite(v)){
    declinationDeg=v;
    localStorage.setItem('ma_declinationDeg', String(declinationDeg));
    if(headingDeg!=null) applyHeading(headingDeg);
  }
});

/* ---- Deklinacija (gruba mreža Balkana) ---- */
const DEC_GRID={ lats:[40,42,44,46], lons:[12,16,20,24], vals:[[2.0,3.0,4.0,4.8],[2.6,3.6,4.6,5.4],[3.0,4.1,5.1,6.0],[3.3,4.4,5.4,6.3]] };
function bilerp(x,x0,x1,y,y0,y1,q11,q21,q12,q22){
  const tx=(x-x0)/(x1-x0||1), ty=(y-y0)/(y1-y0||1);
  const a=q11*(1-tx)+q21*tx, b=q12*(1-tx)+q22*tx;
  return a*(1-ty)+b*ty;
}
function estimateDeclination(lat,lon){
  const {lats,lons,vals}=DEC_GRID;
  lat=Math.max(lats[0],Math.min(lats.at(-1),lat));
  lon=Math.max(lons[0],Math.min(lons.at(-1),lon));
  let i=lats.findIndex((v,idx)=>lat>=v&&(idx===lats.length-1||lat<lats[idx+1])); if(i<0) i=lats.length-2;
  let j=lons.findIndex((v,idx)=>lon>=v&&(idx===lons.length-1||lon<lons[idx+1])); if(j<0) j=lons.length-2;
  return bilerp(lon,lons[j],lons[j+1],lat,lats[i],lats[i+1], vals[i][j],vals[i][j+1],vals[i+1][j],vals[i+1][j+1]);
}

/* ---- Geo pomoćne ---- */
const toRad=x=>x*RAD;
function toXY(lat,lon,lat0){ const x=(lon*RAD)*Math.cos(lat0*RAD)*R, y=(lat*RAD)*R; return {x,y}; }
function haversine(lat1,lon1,lat2,lon2){
  const dφ=toRad(lat2-lat1), dλ=toRad(lon2-lon1);
  const a=Math.sin(dφ/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dλ/2)**2;
  return 2*R*Math.asin(Math.sqrt(a));
}
function bearingBetween(lat1,lon1,lat2,lon2){
  const φ1=toRad(lat1), φ2=toRad(lat2), Δλ=toRad(lon2-lon1);
  const y=Math.sin(Δλ)*Math.cos(φ2);
  const x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
  return ((Math.atan2(y,x)*DEG)+360)%360;
}
function nearestPointOnTrack(p,track){
  let best={lat:track[0].lat,lon:track[0].lon,distM:Infinity,segIndex:0};
  const lat0=p.lat, P=toXY(p.lat,p.lon,lat0);
  for(let i=0;i<track.length-1;i++){
    const A=toXY(track[i].lat,track[i].lon,lat0), B=toXY(track[i+1].lat,track[i+1].lon,lat0);
    const ABx=B.x-A.x, ABy=B.y-A.y, APx=P.x-A.x, APy=P.y-A.y;
    const ab2=ABx*ABx + ABy*ABy || 1;
    let t=(APx*ABx + APy*ABy)/ab2;
    t=Math.max(0,Math.min(1,t));
    const Qx=A.x+t*ABx, Qy=A.y+t*ABy;
    const lon=(Qx/(R*Math.cos(lat0*RAD)))*(180/Math.PI), lat=(Qy/R)*(180/Math.PI);
    const d=haversine(p.lat,p.lon,lat,lon);
    if(d<best.distM) best={lat,lon,distM:d,segIndex:i};
  }
  return best;
}

/* ---- Mini HUD ---- */
function setArrowMode(mode){
  arrowEl?.classList.remove('warn','bad');
  if(mode==='warn') arrowEl?.classList.add('warn');
  else if(mode==='bad') arrowEl?.classList.add('bad');
}
function showMini(){ if(mini) mini.hidden=false; }
function hideMini(){ if(mini) mini.hidden=true; }
function setMiniColor(mode){
  miniNeedle?.classList.remove('warn','bad');
  if(mode==='warn') miniNeedle?.classList.add('warn');
  else if(mode==='bad') miniNeedle?.classList.add('bad');
}

/* ---- Libela ---- */
function renderLevel(pitch=0,roll=0){
  if (!levelRing || !levelBubble) return;
  const ringRect = levelRing.getBoundingClientRect();
  const Rb = (ringRect.width/2) - 13;
  const maxTilt = 30;
  let x = (roll / maxTilt) * Rb;
  let y = (pitch / maxTilt) * Rb;
  const dist = Math.hypot(x,y);
  if(dist>Rb){ const k=Rb/dist; x*=k; y*=k; }
  levelBubble.style.left = '50%';
  levelBubble.style.top  = '50%';
  levelBubble.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
  pitchLbl && (pitchLbl.textContent = `${pitch.toFixed(1)}°`);
  rollLbl  && (rollLbl.textContent  = `${roll.toFixed(1)}°`);
}

/* ---- Heading / render petlja ---- */
let smooth = 0, EMA = 0.12, lastHeadTs = 0;
function renderCompassRing(){
  if (typeof correctedHeading === 'number') {
    const delta = ((((correctedHeading - smooth) + 540) % 360) - 180);
    smooth = smooth + EMA * delta;
    const smoothQuant = Math.round(smooth * 2) / 2;
    if (compassRing) compassRing.style.transform = `translateZ(0) rotate(${-smoothQuant}deg)`;

    const off = Math.min(normalize(smoothQuant), 360 - normalize(smoothQuant));
    const aligned = off <= ALIGN_TOLERANCE;
    if (navState === NAV.OFF_PATH && aligned && targetArrow){
      targetArrow.style.opacity = 1;
      if (lastBrg != null) {
        const rel = (lastBrg - smoothQuant + 360) % 360;
        targetArrow.style.transform = `translate(-50%, -50%) rotate(${rel}deg)`;
      }
    } else if (targetArrow) {
      targetArrow.style.opacity = 0;
    }
    // hook za mini popup
    hookMiniHeading?.(smoothQuant);
  }
  window.__arrow.rafId = requestAnimationFrame(renderCompassRing);
}
function applyHeading(mag, isIOS){
  let h = normalize(mag);
  if (useTrueNorth) h = normalize(h + declinationDeg);
  if (!isIOS) h = normalize(h - screenAngle());
  correctedHeading = h;
}
function onOrient3D(e){
  const now = performance.now(); if (now - lastHeadTs < 30) return; lastHeadTs = now;
  let isIOSHeading = false;
  if (typeof e.webkitCompassHeading === 'number' && Number.isFinite(e.webkitCompassHeading)) {
    headingDeg = normalize(e.webkitCompassHeading);
    isIOSHeading = true;
  } else if (typeof e.alpha === 'number') {
    headingDeg = normalize(360 - e.alpha);
    isIOSHeading = false;
  } else return;
  applyHeading(headingDeg, isIOSHeading);
  renderLevel( e.beta ? Number(e.beta) : 0, e.gamma ? Number(e.gamma) : 0 );
}

/* ---- iOS permission gumb ---- */
iosPermBtn?.addEventListener('click', async ()=>{
  await startCompassSensors();
  iosPermBtn.style.display='none';
});

/* ---- Start senzora ---- */
async function startCompassSensors(){
  if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
    alert('Senzori kompasa rade samo na HTTPS/localhost.');
    return;
  }
  try{
    if (typeof DeviceOrientationEvent !== 'undefined' &&
        typeof DeviceOrientationEvent.requestPermission === 'function'){
      const r = await DeviceOrientationEvent.requestPermission();
      if (r !== 'granted'){ alert('Bez dopuštenja senzora kompas neće raditi na iOS-u.'); return; }
    }
  }catch(_){}
  const ev = ('ondeviceorientationabsolute' in window) ? 'deviceorientationabsolute' : 'deviceorientation';
  window.__arrow.activeOriEvent = ev;
  try { window.removeEventListener(ev, onOrient3D, true); } catch(_){}
  window.addEventListener(ev, onOrient3D, true);

  if (!window.__arrow._onOrientChange) {
    window.__arrow._onOrientChange = ()=>{
      if (typeof headingDeg === 'number') applyHeading(headingDeg);
    };
    window.addEventListener('orientationchange', window.__arrow._onOrientChange, {passive:true});
  }
  if (!window.__arrow.rafId) window.__arrow.rafId = requestAnimationFrame(renderCompassRing);
}

/* ---- Otvaranje kompasa panel + GPX iz URL-a ---- */
function openArrow(){
  try { window.__peakcam?.stop?.(); } catch(_){}
  startCompassSensors();
  const urlParam=new URL(location.href).searchParams.get('gpx');
  if(urlParam) loadGpxFromUrl(urlParam);
  setNavState(gpxTrack && gpxTrack.length >= 2 ? NAV.ON_PATH : NAV.NO_TRACK);
  if (!window.__arrow.rafId) window.__arrow.rafId = requestAnimationFrame(renderCompassRing);
}
qs('#openArrowPanel')?.addEventListener('click', openArrow);

/* ---- Strelica boja prema udaljenosti ---- */
function updateArrowColor(distance){
  const arrow = document.getElementById('targetArrow');
  if (!arrow) return;
  let color = distance <= 10 ? '#2aa96b' : distance <= 20 ? '#f2c14e' : '#ff6b6b';
  arrow.querySelectorAll('rect, polygon').forEach(el=> el.setAttribute('fill', color));
}

/* ---------- GPX parsiranje i učitavanje ---------- */
async function loadGpxFromUrl(url){
  try{
    const res=await fetch(url,{mode:'cors'});
    if(!res.ok) throw new Error('HTTP '+res.status);
    const txt=await res.text();
    gpxTrack=parseGpxToTrack(txt);
    afterGpxLoaded(`GPX (URL): ${gpxTrack.length} točaka`);
  }catch(e){
    trackStatusPill && (trackStatusPill.textContent='GPX URL: ne mogu učitati (CORS?)');
    console.error(e);
  }
}
function parseGpxToTrack(xml){
  const dom=new DOMParser().parseFromString(xml,'application/xml');
  let pts=[...dom.querySelectorAll('trkpt')].map(n=>({lat:+n.getAttribute('lat'), lon:+n.getAttribute('lon')}));
  if(!pts.length){
    pts=[...dom.querySelectorAll('rtept')].map(n=>({lat:+n.getAttribute('lat'), lon:+n.getAttribute('lon')}));
  }
  return pts.filter(p=>Number.isFinite(p.lat)&&Number.isFinite(p.lon));
}
function afterGpxLoaded(label){
  if (!gpxTrack || gpxTrack.length < 2) {
    trackStatusPill && (trackStatusPill.textContent = 'GPX: premalo točaka');
    setNavState(NAV.NO_TRACK);
    if (targetArrow) targetArrow.style.opacity = 0;
    return;
  }
  trackStatusPill && (trackStatusPill.textContent = label);
  onTrackChip && (onTrackChip.textContent = '🧭 status: GPX spreman — klikni “Pokreni praćenje”');
  offDistChip && (offDistChip.textContent = '↔︎ udaljenost: —');
  toggleTrackBtn?.classList.add('alt');
  setTimeout(()=> toggleTrackBtn?.classList.remove('alt'), 1400);
  setNavState(NAV.NO_TRACK);
}
loadGpxBtn?.addEventListener('click', async ()=>{
  const f=gpxInput?.files?.[0];
  if(!f){ trackStatusPill && (trackStatusPill.textContent='GPX: nema datoteke'); return; }
  try{
    const txt=await f.text(); gpxTrack=parseGpxToTrack(txt); afterGpxLoaded(`GPX (datoteka): ${gpxTrack.length} točaka`);
  }catch(e){
    trackStatusPill && (trackStatusPill.textContent='GPX: greška pri učitavanju');
    console.error(e);
  }
});
loadUrlBtn?.addEventListener('click', async ()=>{
  const url=gpxUrl.value.trim();
  if(!url){ trackStatusPill && (trackStatusPill.textContent='GPX URL: prazno'); return; }
  await loadGpxFromUrl(url);
});

/* ---------- GPS praćenje ---------- */
let distLP=null; const DIST_ALPHA=0.35;
toggleTrackBtn?.addEventListener('click', ()=>{
  alertMeters=Math.max(5, Number(alertMetersInput?.value)||30);
  if(window.__arrow.watchId==null){
    if(!gpxTrack || gpxTrack.length<2){ trackStatusPill && (trackStatusPill.textContent='GPX: učitaj trag prvo'); return; }
    startGeoWatch();
    toggleTrackBtn.textContent='Zaustavi praćenje';
  } else { stopGeoWatch(); toggleTrackBtn.textContent='Pokreni praćenje'; }
});
function startGeoWatch(){
  try{
    window.__arrow.watchId = navigator.geolocation.watchPosition(onPos,onGeoErr,{enableHighAccuracy:true, maximumAge:1000, timeout:10000});
    trackStatusPill && (trackStatusPill.textContent='GPS: praćenje uključeno');
    offBeepArmed=true; showMini();
  }catch(_){
    trackStatusPill && (trackStatusPill.textContent='GPS: ne mogu pokrenuti');
  }
}
function stopGeoWatch(){
  if(window.__arrow.watchId!=null){
    navigator.geolocation.clearWatch(window.__arrow.watchId);
    window.__arrow.watchId=null;
  }
  trackStatusPill && (trackStatusPill.textContent='GPS: zaustavljeno');
  hideMini(); if (gpsBanner) gpsBanner.style.display='none';
  lastFix=null;
}
function onGeoErr(err){
  trackStatusPill && (trackStatusPill.textContent='GPS greška: '+(err?.message||''));
  if (gpsBanner) gpsBanner.style.display='flex';
}
function updateOffTrackUI(dist){
  if(dist<=5){ setArrowMode('ok'); onTrackChip && (onTrackChip.textContent='🧭 status: na stazi ✓'); }
  else if(dist<=alertMeters){ setArrowMode('warn'); onTrackChip && (onTrackChip.textContent='🧭 status: blizu ruba'); }
  else { setArrowMode('bad'); onTrackChip && (onTrackChip.textContent='🧭 status: izvan staze');
    if(offBeepArmed){ offBeepArmed=false; beep3(); setTimeout(()=>offBeepArmed=true,8000); }
  }
  offDistChip && (offDistChip.textContent=`↔︎ udaljenost: ${dist.toFixed(0)} m`);
}
function onPos(pos){
  if (gpsBanner) gpsBanner.style.display='none';
  const lat=pos.coords.latitude, lon=pos.coords.longitude, acc=pos.coords.accuracy;
  lastKnownLat=lat; lastKnownLon=lon;

  if(autoDecl && Number.isFinite(lat) && Number.isFinite(lon)){
    const est=estimateDeclination(lat,lon);
    if(Number.isFinite(est)){
      declinationDeg = est; if (declInput) declInput.value = est.toFixed(1);
      localStorage.setItem('ma_declinationDeg', String(declinationDeg));
      if(headingDeg!=null) applyHeading(headingDeg);
    }
  }
  if(!gpxTrack || gpxTrack.length<2){ return; }
  if(Number.isFinite(acc) && acc>50){ onTrackChip && (onTrackChip.textContent='🧭 status: GPS netočan (>50 m)'); return; }

  const nearest = nearestPointOnTrack({lat, lon}, gpxTrack);
  let dist = nearest.distM;
  distLP = distLP == null ? dist : (DIST_ALPHA * dist + (1 - DIST_ALPHA) * distLP);
  if (distLP <= ONPATH_THRESH_M) { setNavState(NAV.ON_PATH); } else { setNavState(NAV.OFF_PATH); }
  updateOffTrackUI(distLP);
  updateArrowColor(distLP);

  const brg = bearingBetween(lat, lon, nearest.lat, nearest.lon);
  lastBrg = brg;
  miniMeters && (miniMeters.textContent=`${distLP.toFixed(0)} m`);
  if(correctedHeading!=null){
    const miniRot = Math.round(((brg - correctedHeading + 360)%360)/5)*5;
    miniNeedle && (miniNeedle.style.transform=`rotate(${miniRot}deg)`);
  }
  const mode = distLP<=5 ? 'ok' : (distLP<=alertMeters ? 'warn' : 'bad');
  setMiniColor(mode);

  const spd = Number.isFinite(pos.coords.speed)?pos.coords.speed:0;
  if(spd>=0.5 && lastFix){
    const cog=bearingBetween(lastFix.lat,lastFix.lon,lat,lon);
    if(headingDeg!=null){
      let diff=cog-(useTrueNorth?normalize(headingDeg+declinationDeg):headingDeg);
      if(diff>180) diff-=360; if(diff<-180) diff+=360;
      const blended=(useTrueNorth?normalize(headingDeg+declinationDeg):headingDeg)+0.4*diff;
      correctedHeading = normalize(blended - screenAngle());
    } else {
      correctedHeading = normalize(cog - screenAngle());
    }
  }
  lastFix = {lat,lon,t:Date.now()};
  window.__btOnPosition?.(pos.coords.latitude, pos.coords.longitude);

  // hook za mini popup udaljenost
  hookMiniDistance?.(distLP);
}

/* ---- Zatvaranje panela kompasa ---- */
qs('#arrowClose')?.addEventListener('click', ()=>{
  hide(qs('#panelArrow'));
  try { window.__arrow.stop(); } catch(_){}
});

/* Beep kontrola s mogućnošću hard-stop-a */
let audioCtx = null;
let __beepActiveOscs = [];

function stopBeep(){
  try {
    __beepActiveOscs.forEach(({osc, gain})=>{
      try { gain?.gain?.cancelScheduledValues?.(0); } catch {}
      try { gain?.disconnect?.(); } catch {}
      try { osc?.stop?.(0); } catch {}
      try { osc?.disconnect?.(); } catch {}
    });
    __beepActiveOscs = [];
    if (audioCtx && audioCtx.state !== 'closed') {
      audioCtx.close().catch(()=>{});
    }
  } catch {}
  audioCtx = null;
}

function beep3(){
  try{
    audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
    const seq = [900,900,900];
    let t = audioCtx.currentTime;
    __beepActiveOscs = [];

    seq.forEach((f)=>{
      const osc = audioCtx.createOscillator();
      const gain= audioCtx.createGain();
      osc.type='sine'; osc.frequency.value=f;
      osc.connect(gain); gain.connect(audioCtx.destination);
      gain.gain.setValueAtTime(0.0001, t);
      gain.gain.exponentialRampToValueAtTime(0.25, t+0.02);
      osc.start(t);
      osc.stop(t+0.15);
      gain.gain.exponentialRampToValueAtTime(0.0001, t+0.15);
      __beepActiveOscs.push({osc, gain});
      t += 0.27;
    });

    if (navigator.vibrate) navigator.vibrate([150,120,150,120,150]);

    // safety timeout: ugasi sve nakon 1.5s ako zapne
    setTimeout(()=>{ stopBeep(); }, 1500);
  }catch(e){}
}

/* ---- Backtrack ---- */
let backtrackActive = false;
let backtrackPoints = [];
const BT_MIN_DIST_M = 8;
const btStartBtn = document.getElementById('btStart');
const btStopBtn  = document.getElementById('btStop');
const btStatusEl = document.getElementById('btStatus');
function btUpdateStatus(msg){ btStatusEl && (btStatusEl.textContent = `↩︎ ${msg}`); }
function btStart(){ backtrackActive = true; backtrackPoints = []; btUpdateStatus('Povratak: snimam…'); }
function btStop(){ backtrackActive = false; btUpdateStatus(`Povratak: isključen — točaka: ${backtrackPoints.length}`); }
btStartBtn?.addEventListener('click', btStart);
btStopBtn ?.addEventListener('click', btStop);
window.__btOnPosition = function(lat, lon){
  if (!backtrackActive) return;
  const last = backtrackPoints[backtrackPoints.length - 1];
  if (!last) { backtrackPoints.push([lat, lon]); return; }
  const d = haversine(last[0], last[1], lat, lon);
  if (d >= BT_MIN_DIST_M) backtrackPoints.push([lat, lon]);
};
window.exportBacktrackGPX = function(){
  if (!backtrackPoints.length) { alert('Nema točaka za povratak.'); return; }
  const gpxPts = backtrackPoints.map(([la,lo]) => `<trkpt lat="${la}" lon="${lo}"></trkpt>`).join('\n    ');
  const gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="Digitalni ruksak" xmlns="http://www.topografix.com/GPX/1/1">
<trk><name>Povratna ruta</name><trkseg>
    ${gpxPts}
</trkseg></trk></gpx>`;
  const blob = new Blob([gpx], {type:'application/gpx+xml'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'povratak.gpx'; a.click();
  URL.revokeObjectURL(url);
};

/* ---- MINI POPUP (HUD) ---- */
let miniPopupWin = null;
let __lastMiniSendTs = 0;
let __lastHeadingForMini = null;
let __lastDistForMini = null;
let __miniAlertMeters = 30;

function hookMiniHeading(deg){ if (typeof deg==='number'){ __lastHeadingForMini = deg; miniPopupBroadcast(); } }
function hookMiniDistance(m){ if (typeof m==='number' || m===null){ __lastDistForMini = m; miniPopupBroadcast(); } }

function __bindMiniInto(win){
  const doc = win.document;
  const ring = doc.getElementById('ring');
  const lblH = doc.getElementById('lblH');
  const distPill = doc.getElementById('distPill');
  const btnClose = doc.getElementById('close');
  let smooth=0, EMA=0.12, rafId=null, lastHeading=null;

  function setDistance(m, alertMeters){
    if (typeof m!=='number'){ distPill.textContent='—'; distPill.className='pill'; return; }
    distPill.textContent = Math.round(m)+' m';
    const a = (typeof alertMeters==='number'&&alertMeters>0)? alertMeters : 30;
    let cls='pill'; if(m<=5) cls+=' ok'; else if(m<=a) cls+=' warn'; else cls+=' bad';
    distPill.className = cls;
  }
  function animate(){
    if (typeof lastHeading==='number'){
      const delta = ((((lastHeading - smooth) + 540) % 360) - 180);
      smooth += EMA * delta;
      const hq = Math.round(smooth*2)/2;
      ring && (ring.style.transform = 'translateZ(0) rotate('+(-hq)+'deg)');
      lblH && (lblH.textContent = hq.toFixed(1));
    }
    rafId = win.requestAnimationFrame(animate);
  }
  win.addEventListener('message', (e)=>{
    const d = e.data||{}; if (d.type!=='compass-mini') return;
    if (typeof d.heading==='number')  lastHeading = normalize(d.heading);
    if (typeof d.distance==='number' || d.distance===null) setDistance(d.distance, d.alertMeters);
    if (!rafId) rafId = win.requestAnimationFrame(animate);
  });
  btnClose && btnClose.addEventListener('click', ()=> win.close());
}
function openMiniPopup(){
  if (miniPopupWin && !miniPopupWin.closed){ miniPopupWin.focus(); return; }
  const w=360, h=500;
  const left=(window.screenX||0)+((window.outerWidth||800)-w)/2;
  const top =(window.screenY||0)+((window.outerHeight||600)-h)/2;
  miniPopupWin = window.open('', 'miniCompassPopup',
    `width=${w},height=${h},left=${Math.max(0,left)},top=${Math.max(0,top)},resizable=yes,noopener=yes`
  );
  if(!miniPopupWin){ alert('Popup blokiran — dopusti iskočne prozore.'); return; }

  const tpl = qs('#miniPopupTpl');
  const html = tpl ? tpl.innerHTML : '<div style="padding:12px">Nedostaje #miniPopupTpl</div>';
  miniPopupWin.document.open();
  miniPopupWin.document.write(`<!doctype html><html lang="hr"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Mini kompas</title></head><body>${html}</body></html>`);
  miniPopupWin.document.close();

  __bindMiniInto(miniPopupWin);
  setTimeout(()=> miniPopupBroadcast(true), 60);

  const t = setInterval(()=>{
    if(!miniPopupWin || miniPopupWin.closed){ clearInterval(t); miniPopupWin = null; }
  }, 1000);
}
function closeMiniPopup(){ try{ if(miniPopupWin && !miniPopupWin.closed) miniPopupWin.close(); }catch(_){} miniPopupWin = null; }
function miniPopupBroadcast(force=false){
  if(!miniPopupWin || miniPopupWin.closed) return;
  const now = performance.now();
  if(!force && now - __lastMiniSendTs < 120) return;
  __lastMiniSendTs = now;
  const payload = {
    type:'compass-mini',
    heading: (typeof __lastHeadingForMini==='number') ? __lastHeadingForMini : null,
    distance:(typeof __lastDistForMini==='number') ? __lastDistForMini : null,
    alertMeters: __miniAlertMeters
  };
  try{ miniPopupWin.postMessage(payload, '*'); }catch(_){}
}
qs('#openPopupBtn')?.addEventListener('click', ()=>{ try{ window.__peakcam?.stop?.(); }catch(_){} openMiniPopup(); });
qs('#closePopupBtn')?.addEventListener('click', closeMiniPopup);

/* Fallback: pokreni render petlju ako nije aktivna */
if (!window.__arrow.rafId) window.__arrow.rafId = requestAnimationFrame(renderCompassRing);
  

/* =========================================================
   NOĆNO NEBO — ISTICANJE ASTERIZAMA
   ========================================================= */
const skyCanvas = qs('#skyCanvas');
const skyCtx = skyCanvas?.getContext('2d');
const skyStartBtn = qs('#skyStart');
const skyNowBtn = qs('#skyNow');
const skyLegend = qs('#skyLegend');
let skyHeading = 0, skyPitch = 0;

window.__sky = window.__sky || {
  activeEvent: null, isRunning: false,
  stop(){
    try{
      if (this.activeEvent){ window.removeEventListener(this.activeEvent, handleSky, true); this.activeEvent=null; }
      this.isRunning=false;
    }catch(_){}
  }
};

const STARS = [
  {ra:5.9195, dec:7.4071,  mag:0.2, name:'Betelgeuse'},
  {ra:5.2423, dec:-8.2016, mag:0.5, name:'Rigel'},
  {ra:5.5334, dec:-0.2991, mag:0.9, name:'Alnilam'},
  {ra:5.6036, dec:-1.2019, mag:1.7, name:'Mintaka'},
  {ra:5.5856, dec:-1.9426, mag:2.2, name:'Alnitak'},
  {ra:11.0621, dec:61.7508, mag:1.8, name:'Alioth'},
  {ra:12.2570, dec:57.0326, mag:1.9, name:'Mizar'},
  {ra:13.7923, dec:49.3133, mag:1.8, name:'Dubhe'},
  {ra:14.2610, dec:19.1825, mag:2.4, name:'Alkaid'},
  {ra:11.8972, dec:53.6948, mag:2.3, name:'Megrez'},
  {ra:12.9004, dec:55.9598, mag:2.4, name:'Phecda'}
];

function drawSky(){
  if(!skyCtx || !skyCanvas) return;
  const w=skyCanvas.width = skyCanvas.clientWidth || skyCanvas.width || 360;
  const h=skyCanvas.height= skyCanvas.clientHeight|| skyCanvas.height|| 240;

  skyCtx.fillStyle='#020309'; skyCtx.fillRect(0,0,w,h);
  skyCtx.strokeStyle='#1f2327'; skyCtx.strokeRect(0.5,0.5,w-1,h-1);

  skyCtx.fillStyle='#9aa6b2'; skyCtx.font='12px Montserrat';
  skyCtx.fillText('N', 6, 14); skyCtx.fillText('E', w-14, 14);
  skyCtx.fillText('S', w-14, h-6); skyCtx.fillText('W', 6, h-6);

  const cx=w/2, cy=h/2, Rk=Math.min(cx,cy)-16;
  skyCtx.strokeStyle='#101317';
  skyCtx.beginPath(); skyCtx.arc(cx,cy,Rk,0,Math.PI*2); skyCtx.stroke();

  const positions = {};
  STARS.forEach(st=>{
    const az = ((st.ra*15 - skyHeading + 360*10) % 360);
    const rad = az*Math.PI/180;
    const x = cx + Math.sin(rad)*Rk*0.92;
    const y = cy - Math.cos(rad)*Rk*0.92;
    const r = (st.mag < 1.0) ? 3.2 : (st.mag < 2.0) ? 2.6 : 2.1;
    positions[st.name] = {x,y};
    skyCtx.fillStyle='#e7e9ff';
    skyCtx.beginPath(); skyCtx.arc(x,y,r,0,Math.PI*2); skyCtx.fill();
  });

  const lookingUp = skyPitch <= -60;
  if(lookingUp){
    skyCtx.strokeStyle='rgba(58,160,255,.7)';
    skyCtx.lineWidth=2;
    ['Alnitak','Alnilam','Mintaka'].reduce((prev,cur)=>{
      if(prev && positions[prev] && positions[cur]){
        skyCtx.beginPath();
        skyCtx.moveTo(positions[prev].x,positions[prev].y);
        skyCtx.lineTo(positions[cur].x,positions[cur].y);
        skyCtx.stroke();
      }
      return cur;
    }, null);
    const umList=['Dubhe','Megrez','Phecda','Alioth','Mizar','Alkaid'];
    umList.reduce((prev,cur)=>{
      if(prev && positions[prev] && positions[cur]){
        skyCtx.beginPath();
        skyCtx.moveTo(positions[prev].x,positions[prev].y);
        skyCtx.lineTo(positions[cur].x,positions[cur].y);
        skyCtx.stroke();
      }
      return cur;
    }, null);
    skyCtx.fillStyle='#8fbaff'; skyCtx.font='11px Montserrat';
    ['Betelgeuse','Rigel','Alnilam','Mintaka','Dubhe','Alioth','Mizar','Alkaid'].forEach(n=>{
      const p=positions[n]; if(p){ skyCtx.fillText(n, p.x+6, p.y-6); }
    });
  }
  skyCtx.fillStyle='#6f7a86';
  skyCtx.fillText(lookingUp?'Orion • Veliki medvjed (linije aktivne)':'Orion • Veliki medvjed (pojednostavljeno)', 10, h-10);
}
function handleSky(e){
  if(typeof e.webkitCompassHeading === 'number'){ skyHeading = normalize(e.webkitCompassHeading); }
  else if (typeof e.alpha === 'number'){ let h = normalize(360 - e.alpha); h = normalize(h - screenAngle()); skyHeading = h; }
  if(typeof e.beta === 'number'){ skyPitch = e.beta; }
  drawSky();
}
async function askSkyPermission(){
  if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
    alert('Senzori rade samo na HTTPS/localhost.'); return;
  }
  try{
    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
      const r = await DeviceOrientationEvent.requestPermission();
      if (r !== 'granted') { alert('Bez dopuštenja senzora nebo se neće rotirati na iOS-u.'); return; }
    }
  }catch(_){}
  const ev = ('ondeviceorientationabsolute' in window) ? 'deviceorientationabsolute' : 'deviceorientation';
  try{ window.removeEventListener(ev, handleSky, true); }catch(_){}
  window.addEventListener(ev, handleSky, true);
  window.__sky.activeEvent = ev; window.__sky.isRunning = true;
  drawSky();
}
qs('#skyStart')?.addEventListener('click', askSkyPermission);
qs('#skyNow')  ?.addEventListener('click', ()=>{ skyHeading = 0; drawSky(); });
drawSky();

/* =========================================================
   PROGNOZA — OPEN-METEO (3 DANA)
   ========================================================= */
const wxGrid=qs('#wxGrid'),
      wxCity=qs('#wxCity'),
      wxFetchBtn=qs('#wxFetch'),
      wxFetchManual=qs('#wxFetchManual'),
      wxLat=qs('#wxLat'),
      wxLon=qs('#wxLon');

wxFetchBtn?.addEventListener('click', ()=>{
  if(!navigator.geolocation){ alert('Ova naprava nema geolokaciju.'); return; }
  navigator.geolocation.getCurrentPosition(async p=>{
    const lat=p.coords.latitude, lon=p.coords.longitude;
    wxLat.value=lat.toFixed(4); wxLon.value=lon.toFixed(4);
    await fetchForecast(lat,lon);
  }, e=>alert('GPS greška: '+e.message), {enableHighAccuracy:true,timeout:10000});
});
wxFetchManual?.addEventListener('click', async ()=>{
  const lat=parseFloat(wxLat.value), lon=parseFloat(wxLon.value);
  if(!Number.isFinite(lat)||!Number.isFinite(lon)){ alert('Unesi ispravne koordinate.'); return; }
  await fetchForecast(lat,lon);
});
async function fetchForecast(lat,lon){
  try{
    wxCity.textContent=`Lokacija: ${lat.toFixed(3)}, ${lon.toFixed(3)}`;
    const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,precipitation,wind_speed_10m,uv_index&daily=temperature_2m_max,temperature_2m_min,precipitation_sum,uv_index_max,wind_speed_10m_max&current_weather=true&timezone=auto`;
    const res=await fetch(url); const data=await res.json();
    renderWeather(data);
  }catch(_){ wxCity.textContent='Greška pri dohvaćanju prognoze'; }
}
function renderWeather(d){
  wxGrid.innerHTML='';
  if(!d?.daily){ wxGrid.innerHTML='<div class="wx-card">Nema podataka.</div>'; return; }
  const days=d.daily.time.length;
  for(let i=0;i<Math.min(days,3);i++){
    const el=document.createElement('div'); el.className='wx-card';
    el.innerHTML=`<h5>${d.daily.time[i]}</h5>
      <div class="wx-meta">Tmin/Tmax: ${d.daily.temperature_2m_min[i]}° / ${d.daily.temperature_2m_max[i]}°</div>
      <div class="wx-meta">Vjetar max: ${d.daily.wind_speed_10m_max[i]} m/s</div>
      <div class="wx-meta">Oborina: ${d.daily.precipitation_sum[i]} mm</div>
      <div class="wx-meta">UV max: ${d.daily.uv_index_max[i]??'—'}</div>`;
    wxGrid.appendChild(el);
  }
}

/* =========================================================
   BILJKE / ŽIVOTINJE — KAMERA
   ========================================================= */
const bioOpen = qs('#bioOpenCam'),
      bioSnap = qs('#bioSnap'),
      bioClose= qs('#bioCloseCam'),
      bioVideo= qs('#bioVideo'),
      bioCanvas=qs('#bioCanvas'),
      bioPhoto =qs('#bioPhoto'),
      bioINat  =qs('#bioINat');
let bioStream=null;

bioOpen?.addEventListener('click', async ()=>{
  try{
    bioStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    bioVideo.srcObject=bioStream; bioVideo.style.display='block';
    bioSnap.disabled=false; bioClose.disabled=false; await bioVideo.play();
  }catch(e){ alert('Kamera nedostupna: '+e.message); }
});
bioClose?.addEventListener('click', ()=>{
  try{
    bioVideo.pause(); bioVideo.style.display='none';
    bioStream?.getTracks()?.forEach(t=>t.stop());
    bioStream=null; bioSnap.disabled=true; bioClose.disabled=true;
  }catch(_){}
});
bioSnap?.addEventListener('click', ()=>{
  if(!bioVideo.videoWidth) return;
  bioCanvas.width=bioVideo.videoWidth; bioCanvas.height=bioVideo.videoHeight;
  const ctx=bioCanvas.getContext('2d'); ctx.drawImage(bioVideo,0,0);
  const url=bioCanvas.toDataURL('image/jpeg',0.9);
  bioPhoto.src=url; bioPhoto.style.display='block';
});
bioINat?.addEventListener('click', ()=>{ window.open('https://www.inaturalist.org/observations/new','_blank'); });

/* =========================================================
   SOS — AUDIO
   ========================================================= */
let sosCtx=null, sosPlay=false;
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function sosBeep(freq=900,dur=150){
  return new Promise(res=>{
    try{
      sosCtx=sosCtx||new (window.AudioContext||window.webkitAudioContext)();
      const t=sosCtx.currentTime;
      const osc=sosCtx.createOscillator(); const gain=sosCtx.createGain();
      osc.frequency.value=freq; osc.type='sine';
      gain.gain.value=0.0001; osc.connect(gain); gain.connect(sosCtx.destination);
      osc.start();
      gain.gain.exponentialRampToValueAtTime(0.25, t+0.02);
      gain.gain.setValueAtTime(0.25, t+dur/1000-0.03);
      gain.gain.exponentialRampToValueAtTime(0.0001, t+dur/1000);
      osc.stop(t+dur/1000+0.02);
      setTimeout(res, dur);
    }catch(_){ res(); }
  });
}
async function playSOS(){
  if(sosPlay) return;
  sosPlay=true;
  while(sosPlay){
    await sosBeep(900,150); await sleep(120);
    await sosBeep(900,150); await sleep(120);
    await sosBeep(900,150); await sleep(300);
    await sosBeep(900,450); await sleep(150);
    await sosBeep(900,450); await sleep(150);
    await sosBeep(900,450); await sleep(300);
    await sosBeep(900,150); await sleep(120);
    await sosBeep(900,150); await sleep(120);
    await sosBeep(900,150); await sleep(900);
  }
}
function stopSOS(){ sosPlay=false; }
qs('#playSOS')?.addEventListener('click', playSOS);
qs('#stopSOS')?.addEventListener('click', stopSOS);
                      

/* =========================================================
   PEAK CAM (AR OSM Vrhovi) — KAMERA + SENZORI + OSM
   ========================================================= */
(function(){
  // --- DOM ---
  const panel   = document.getElementById('panelPeakCam');
  const video   = document.getElementById('pc-video');
  const overlay = document.getElementById('pc-overlay');
  const ctx     = overlay?.getContext?.('2d');
  const hint    = document.getElementById('pc-hint');
  const statusEl= document.getElementById('pc-status');
  const btnStart= document.getElementById('pc-start');
  const btnStop = document.getElementById('pc-stop');
  const hfovInp = document.getElementById('pc-hfov');
  const vfovInp = document.getElementById('pc-vfov');
  const hofsInp = document.getElementById('pc-hofs');
  const hfovVal = document.getElementById('pc-hfov-val');
  const vfovVal = document.getElementById('pc-vfov-val');
  const hofsVal = document.getElementById('pc-hofs-val');

  // --- STATE ---
  const state = {
    running:false, rafId:null, stream:null,
    heading:null, pitch:0, roll:0, pos:null,
    peaks:[], hfov:Number(hfovInp?.value||60), vfov:Number(vfovInp?.value||40), hofs:Number(hofsInp?.value||0)
  };

  // --- UTILS ---
  const RAD=Math.PI/180, DEG=180/Math.PI, R=6371000;
  const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
  function setStatus(msg){ statusEl && (statusEl.textContent = `Status: ${msg}`); }
  function showHint(txt){ if(!hint) return; hint.textContent = txt; hint.style.display='block'; }
  function hideHint(){ if(hint) hint.style.display='none'; }

  // --- CAMERA ---
  async function startCamera(){
    if(state.stream) return;
    setStatus('pokrećem kameru…');
    const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
    state.stream = stream; video.srcObject = stream; await video.play();

    const resize = ()=>{
      const rect = video.getBoundingClientRect();
      overlay.width  = Math.max(2, Math.round(rect.width));
      overlay.height = Math.max(2, Math.round(rect.height));
    };
    resize(); setTimeout(resize, 150);
    window.addEventListener('resize', resize, {passive:true});
    setStatus('kamera radi');
  }
  function stopCamera(){
    try{
      video.pause();
      state.stream?.getTracks?.().forEach(t=>t.stop());
      state.stream=null; video.srcObject=null;
    }catch(_){}
  }

  // --- ORIENTATION ---
  let activeOriEvent = null, lastHeadTs=0;
  function applyHeading(raw, isIOS){
    let h = normalize(raw + state.hofs);
    if(!isIOS) h = normalize(h - screenAngle());
    state.heading = h;
  }
  function onOrient(e){
    const now = performance.now(); if(now - lastHeadTs < 30) return; lastHeadTs = now;
    if (typeof e.webkitCompassHeading === 'number' && Number.isFinite(e.webkitCompassHeading)) {
      applyHeading(e.webkitCompassHeading, true);
    } else if (typeof e.alpha === 'number') {
      applyHeading(360 - e.alpha, false);
    }
    state.pitch = typeof e.beta  === 'number' ? e.beta  : 0;
    state.roll  = typeof e.gamma === 'number' ? e.gamma : 0;
  }
  async function enableOrientation(){
    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
      const r = await DeviceOrientationEvent.requestPermission();
      if (r !== 'granted') throw new Error('senzori odbijeni (iOS)');
    }
    if ('ondeviceorientationabsolute' in window) {
      window.addEventListener('deviceorientationabsolute', onOrient, true);
      activeOriEvent = 'deviceorientationabsolute';
    } else {
      window.addEventListener('deviceorientation', onOrient, true);
      activeOriEvent = 'deviceorientation';
    }
    window.addEventListener('orientationchange', ()=>{
      if(state.heading!=null){ applyHeading(state.heading, false); }
    }, {passive:true});
  }
  function disableOrientation(){
    if(activeOriEvent){
      window.removeEventListener(activeOriEvent, onOrient, true);
      activeOriEvent = null;
    }
  }

  // --- GEO ---
  function getLocation(){
    return new Promise((resolve,reject)=>{
      if(!navigator.geolocation) return reject(new Error('geolokacija nije podržana'));
      navigator.geolocation.getCurrentPosition(
        pos=>{ const lat=pos.coords.latitude, lon=pos.coords.longitude; state.pos={lat,lon}; resolve(state.pos); },
        err=>reject(err),
        { enableHighAccuracy:true, timeout:12000, maximumAge:2000 }
      );
    });
  }

  // --- OSM PEAKS (Overpass) ---
  async function fetchPeaks(lat, lon, radius=10000){  // smanjeno na 10 km da bude preglednije
    const q = `
      [out:json][timeout:20];
      (
        node["natural"="peak"]["name"](around:${radius},${lat},${lon});
        way["natural"="peak"]["name"](around:${radius},${lat},${lon});
        relation["natural"="peak"]["name"](around:${radius},${lat},${lon});
      );
      out center 200;`.trim();
    try{
      const res = await fetch('https://overpass-api.de/api/interpreter', {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ data:q })
      });
      if(!res.ok) throw new Error('Overpass HTTP '+res.status);
      const data = await res.json();
      const peaks = [];
      for(const el of (data.elements||[])){
        let plat = el.lat, plon = el.lon;
        if(plat==null || plon==null){ if(el.center){ plat=el.center.lat; plon=el.center.lon; } }
        const name = el.tags && el.tags.name || 'Vrh';
        if(Number.isFinite(plat) && Number.isFinite(plon)) peaks.push({lat:plat, lon:plon, name});
      }
      state.peaks = peaks.slice(0, 120);
      setStatus(`dohvaćeno vrhova: ${state.peaks.length}`);
    }catch(_){
      state.peaks = [
        {name:'Demo vrh A', lat:lat+0.15, lon:lon+0.00},
        {name:'Demo vrh B', lat:lat+0.10, lon:lon+0.20},
        {name:'Demo vrh C', lat:lat-0.05, lon:lon-0.18},
      ];
      setStatus('OSM vrhovi: offline demo');
    }
  }

  // --- GEO MATH ---
  function toRad(x){ return x*RAD; }
  function bearingBetween(lat1,lon1,lat2,lon2){
    const φ1=toRad(lat1), φ2=toRad(lat2), Δλ=toRad(lon2-lon1);
    const y=Math.sin(Δλ)*Math.cos(φ2);
    const x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
    return normalize(Math.atan2(y,x)*DEG);
  }
  function haversine(lat1,lon1,lat2,lon2){
    const dφ=toRad(lat2-lat1), dλ=toRad(lon2-lon1);
    const a=Math.sin(dφ/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dλ/2)**2;
    return 2*R*Math.asin(Math.sqrt(a));
  }

  // --- Projektiranje (HFOV) ---
  function projectPeak(peak, width, height){
    if(!state.pos || state.heading==null) return null;
    const brg = bearingBetween(state.pos.lat, state.pos.lon, peak.lat, peak.lon);
    const rel = normalize(brg - state.heading);
    const halfH = state.hfov/2;
    let dx = rel; if (dx > 180) dx -= 360;
    if (Math.abs(dx) > halfH) return null;
    const x = ((dx + halfH) / (state.hfov)) * width;
    const dist = haversine(state.pos.lat, state.pos.lon, peak.lat, peak.lon);
    const horizonY = height * 0.52;
    const y = horizonY - clamp((3000 - dist/15)/3000, -0.35, 0.35) * (height*0.35);
    return { x, y, dist, brg };
  }

  // --- DRAW LOOP ---
  function draw(){
    if(!ctx || !overlay) return;
    const w = overlay.width, h = overlay.height;
    ctx.clearRect(0,0,w,h);
    ctx.strokeStyle = 'rgba(255,255,255,0.12)';
    ctx.beginPath(); ctx.moveTo(0, h*0.52); ctx.lineTo(w, h*0.52); ctx.stroke();
    ctx.fillStyle = 'rgba(255,255,255,0.28)';
    ctx.fillRect(w/2-6, h/2, 12, 1); ctx.fillRect(w/2, h/2-6, 1, 12);

    if(state.peaks.length && state.pos && state.heading!=null){
      ctx.font = '12px Montserrat, system-ui, sans-serif'; ctx.textBaseline='bottom';
      for(const p of state.peaks){
        const P = projectPeak(p, w, h); if(!P) continue;
        ctx.fillStyle = 'rgba(58,160,255,.95)'; ctx.beginPath(); ctx.arc(P.x, P.y, 3, 0, Math.PI*2); ctx.fill();
        const label = `${p.name} · ${(P.dist/1000).toFixed(1)} km`;
        const tw = ctx.measureText(label).width + 10; const lh = 18;
        const lx = clamp(P.x - tw/2, 6, w - tw - 6); const ly = Math.max(18, P.y - 10);
        ctx.fillStyle = 'rgba(18,20,22,.85)'; ctx.fillRect(lx, ly-lh, tw, lh);
        ctx.strokeStyle = 'rgba(255,255,255,.18)'; ctx.strokeRect(lx+0.5, ly-lh+0.5, tw-1, lh-1);
        ctx.fillStyle = '#e9eef2'; ctx.fillText(label, lx+5, ly-4);
      }
    }
    state.rafId = requestAnimationFrame(draw);
  }

  // --- PUBLIC API ---
  async function start(){
    if(state.running) return;
    if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
      alert('PeakCam radi samo na HTTPS/localhost (kamera i senzori).'); return;
    }
    try {
      showHint('Dopusti pristup kameri, lokaciji i orijentaciji.');
      setStatus('čekam dozvole…');
      await enableOrientation();
      hideHint();
      const pos = await getLocation().catch(()=>null);
      if(pos) setStatus('lokacija OK'); else setStatus('lokacija nije dostupna');
      await startCamera();
      if(pos){ fetchPeaks(pos.lat, pos.lon, 10000).catch(()=>{}); } // 10 km
      state.running = true; draw(); setStatus('radi');
    } catch (e) {
      setStatus('greška: ' + (e?.message || 'nepoznato'));
      showHint('Provjeri dozvole za kameru / lokaciju / orijentaciju.');
    }
  }
  function stop(){
    if (!state.running) { stopCamera(); disableOrientation(); return; }
    state.running=false;
    if (state.rafId){ cancelAnimationFrame(state.rafId); state.rafId=null; }
    ctx?.clearRect?.(0,0,overlay.width,overlay.height);
    disableOrientation(); stopCamera();
  }

  // --- SLIDERS / UI ---
  function bindSliders(){
    if(hfovInp){
      hfovInp.addEventListener('input', ()=>{ state.hfov = Number(hfovInp.value)||60; hfovVal && (hfovVal.textContent = `${state.hfov}°`); });
      hfovVal && (hfovVal.textContent = `${state.hfov}°`);
    }
    if(vfovInp){
      vfovInp.addEventListener('input', ()=>{ state.vfov = Number(vfovInp.value)||40; vfovVal && (vfovVal.textContent = `${state.vfov}°`); });
      vfovVal && (vfovVal.textContent = `${state.vfov}°`);
    }
    if(hofsInp){
      hofsInp.addEventListener('input', ()=>{ state.hofs = Number(hofsInp.value)||0; hofsVal && (hofsVal.textContent = `${state.hofs}°`); });
      hofsVal && (hofsVal.textContent = `${state.hofs}°`);
    }
  }
  bindSliders();

  btnStart?.addEventListener('click', start);
  btnStop ?.addEventListener('click', ()=>{
    stop();
    if (panel) panel.hidden = true;
    showHint('Dopusti pristup kameri, lokaciji i orijentaciji.');
    setStatus('spremno');
  });

  // Izloži globalno
  window.__peakcam = { start, stop };
})();
</script>

<script>
/* --- Globalni suspend svih modula (jedan alat aktivan) --- */
window.suspendAllTools = function suspendAllTools() {
  // Kompas (render + senzori + GPS + miniHUD + zvuk)
  try { window.__arrow?.stop?.(); } catch {}
  try { window.stopGeoWatch?.(); } catch {}
  try { window.hideMini?.(); } catch {}

  // PeakCam
  try { window.__peakcam?.stop?.(); } catch {}

  // Noćno nebo
  try { window.__sky?.stop?.(); } catch {}

  // Kamera
  try { window.stopCam?.(); } catch {}

  // SOS / Beep
  try { window.stopSOS?.(); } catch {}
  try { window.stopBeep?.(); } catch {}
};

/* --- Hookaj suspend u router (otvaranje bilo kojeg panela) --- */
(function patchRouterToSuspend(){
  const openSel = (sel) => {
    window.suspendAllTools?.(); // <-- KLJUČNO: prije promjene panela, sve ugasi
    const tgt = document.querySelector(sel);
    if (!tgt) return;
    document.querySelectorAll('section.tool-panel').forEach(p => p.hidden = (p !== tgt));
    try { tgt.scrollIntoView({behavior:'smooth', block:'start'}); } catch {}
  };
  // Ako si već imao router, prespojit ćemo gumbe na ovu verziju:
  [
    ['#openAidPanel',     '#panelAid'],
    ['#openCamPanel',     '#panelCamera'],
    ['#openArrowPanel',   '#panelArrow'],
    ['#openSkyPanel',     '#panelSky'],
    ['#openWeatherPanel', '#panelWeather'],
    ['#openBioPanel',     '#panelBio'],
    ['#openOfflinePanel', '#panelOffline'],
    ['#openPeakCamPanel', '#panelPeakCam'],
  ].forEach(([btnSel, panelSel])=>{
    const btn = document.querySelector(btnSel);
    if (btn) {
      btn.onclick = (e)=>{ e?.preventDefault?.(); openSel(panelSel); };
    }
  });
})();
</script>

<script>
/* --- GPX optimizacija: simplify + throttle onPos --- */

/* 1) Pojednostavi trag po udaljenosti (O(n)) */
function simplifyTrackByDistance(pts, minStepM=8){
  if (!Array.isArray(pts) || pts.length < 3) return pts || [];
  const out = [pts[0]];
  let last = pts[0];
  for (let i=1;i<pts.length;i++){
    const p = pts[i];
    const d = haversine(last.lat,last.lon,p.lat,p.lon);
    if (d >= minStepM){ out.push(p); last = p; }
  }
  if (out[out.length-1] !== pts[pts.length-1]) out.push(pts[pts.length-1]);
  return out;
}

/* 2) Adaptivni korak ovisno o veličini traga */
function adaptMinStepMeters(n){
  if (n <= 1500)   return 6;
  if (n <= 5000)   return 12;
  if (n <= 15000)  return 20;
  return 35;
}

/* 3) Wrap oko tvog afterGpxLoaded: simplificiraj pa proslijedi */
const __orig_afterGpxLoaded = (typeof afterGpxLoaded === 'function') ? afterGpxLoaded : null;

function afterGpxLoaded(label){
  try{
    if (Array.isArray(gpxTrack) && gpxTrack.length > 2){
      const step = adaptMinStepMeters(gpxTrack.length);
      gpxTrack = simplifyTrackByDistance(gpxTrack, step);
      label = `${label} • simpl: ${gpxTrack.length} točaka`;
    }
  }catch(e){ console.warn('GPX simplify error:', e); }

  if (__orig_afterGpxLoaded) {
    return __orig_afterGpxLoaded(label);
  }

  /* fallback ako iz nekog razloga original ne postoji */
  if (!gpxTrack || gpxTrack.length < 2) {
    trackStatusPill && (trackStatusPill.textContent = 'GPX: premalo točaka');
    setNavState && setNavState(NAV.NO_TRACK);
    if (typeof targetArrow !== 'undefined' && targetArrow) targetArrow.style.opacity = 0;
    return;
  }
  trackStatusPill && (trackStatusPill.textContent = label);
  onTrackChip   && (onTrackChip.textContent = '🧭 status: GPX spreman — klikni “Pokreni praćenje”');
  offDistChip   && (offDistChip.textContent = '↔︎ udaljenost: —');
  toggleTrackBtn?.classList.add('alt');
  setTimeout(()=> toggleTrackBtn?.classList.remove('alt'), 1400);
  setNavState && setNavState(NAV.NO_TRACK);
}

/* 4) Throttle onPos (spriječi “smrzavanje” na slabijim uređajima) */
let __onPosLastTs = 0;
const __ONPOS_MIN_MS = 140; // ≈7 Hz
if (typeof onPos === 'function') {
  const __orig_onPos = onPos;
  window.onPos = function(pos){
    const now = performance.now();
    if (now - __onPosLastTs < __ONPOS_MIN_MS) return;
    __onPosLastTs = now;
    return __orig_onPos(pos);
  };
}
</script>  

<script>
// Kompas otvaranje
document.querySelector('#openArrowPanel')?.addEventListener('click', ()=>{
  window.suspendAllTools?.();   // prvo ugasi sve
  startCompassSensors?.();      // onda upali kompas
});

// PeakCam otvaranje
document.querySelector('#openPeakCamPanel')?.addEventListener('click', ()=>{
  window.suspendAllTools?.();   // prvo ugasi sve
  window.__peakcam?.start?.();  // onda upali PeakCam
});
</script>  

<script>
window.stopGeoWatch = window.stopGeoWatch || function(){
  try{
    if(window.__arrow?.watchId != null){
      navigator.geolocation.clearWatch(window.__arrow.watchId);
      window.__arrow.watchId = null;
    }
  }catch{}
};
</script>  
  
</body>
</html>
